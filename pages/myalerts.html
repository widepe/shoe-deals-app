<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <title>My Alerts – Shoe Beagle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 2rem 1rem;
      background: #f4ede3ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #2d2d2d;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .page-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .brand-logo {
      display: block;
      width: 600px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover {
      opacity: 0.9;
    }

    /* Create Alert Section */
    .create-alert-section {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }

    .section-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0 0 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #214478ff;
      margin-bottom: 0.4rem;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      height: 42px;
      padding: 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: #1a3661;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.1);
    }

    .input-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #999;
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      padding: 0;
      line-height: 1;
      z-index: 20;
    }

    .input-clear:hover {
      background: #666;
    }

    .input-wrapper:has(input:not(:placeholder-shown)) .input-clear {
      display: flex;
    }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 30;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.5rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .suggestion-item:hover,
    .suggestion-item.active {
      background: #e8f0ff;
    }

    .gender-selector {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .gender-option {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }

    .gender-option input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .gender-option label {
      cursor: pointer;
      font-size: 0.95rem;
    }

    .price-input-wrapper {
      position: relative;
      display: inline-block;
      width: 150px;
    }

    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }

    .price-input-wrapper input {
      padding-left: 2rem;
      text-align: right;
    }

    .submit-btn {
      width: 100%;
      height: 48px;
      border-radius: 0.5rem;
      border: none;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 0.5rem;
    }

    .submit-btn:hover {
      background: #1a3661;
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .form-hint {
      font-size: 0.82rem;
      color: #666;
      font-style: italic;
      margin-top: 0.3rem;
    }

    .status-message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      text-align: center;
      display: none;
    }

    .status-message.success {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid rgba(46, 160, 67, 0.5);
      color: #1f6a2a;
    }

    .status-message.error {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: #8a1f2c;
    }

    /* Alerts dashboard (existing styles) */
    .alerts-dashboard {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.25rem 1.25rem 1.5rem;
      box-sizing: border-box;
    }

    .alerts-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0.25rem 0 0.3rem;
    }

    .alerts-instruction {
      color: #49543a;
      font-size: 0.88rem;
      text-align: center;
      margin: 0 0 0.6rem;
      font-style: italic;
    }

    .alerts-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    .alerts-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .alerts-table colgroup col:nth-child(1) { width: 10%; }  /* Date Set */
    .alerts-table colgroup col:nth-child(2) { width: 35%; }  /* Shoe */
    .alerts-table colgroup col:nth-child(3) { width: 12%; }  /* Email */
    .alerts-table colgroup col:nth-child(4) { width: 7%; }   /* Days Left */
    .alerts-table colgroup col:nth-child(5) { width: 10%; }  /* Target */
    .alerts-table colgroup col:nth-child(6) { width: 19%; }  /* Status */

    .alerts-table thead th {
      text-align: left;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #214478ff;
      padding: 0.5rem 0.65rem;
      border-bottom: 2px solid rgba(33, 68, 120, 0.35);
      background: rgba(255, 255, 255, 0.55);
    }

    .alerts-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .alerts-table tbody tr:hover {
      background: rgba(33, 68, 120, 0.08);
    }

    .alerts-table tbody tr.selected {
      background: rgba(33, 68, 120, 0.15);
    }

    .alerts-table tbody tr.inactive {
      background: #e8e8e8;
    }

    .alerts-table tbody tr.inactive:hover {
      background: #d8d8d8;
    }

    .alerts-table tbody td {
      padding: 0.5rem 0.65rem;
      border-bottom: 1px solid rgba(33, 68, 120, 0.18);
      vertical-align: middle;
      font-size: 0.92rem;
      color: #2d2d2d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .alerts-table tbody td:nth-child(2),
    .alerts-table tbody td:nth-child(3) {
      max-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .alerts-table td.target-cell {
      text-align: right;
    }

    .alerts-muted {
      text-align: center;
      padding: 1.25rem 0.5rem;
      color: #49543a;
      font-size: 0.95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.82rem;
      border: 1px solid rgba(33, 68, 120, 0.25);
      background: rgba(255, 255, 255, 0.6);
      color: #214478ff;
    }

    .pill.active {
      background: rgba(46, 160, 67, 0.20);
      border-color: rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
    }

    .pill.expired {
      background: rgba(150, 150, 150, 0.18);
      border-color: rgba(150, 150, 150, 0.40);
      color: #555;
    }

    .pill.cancelled {
      background: rgba(220, 53, 69, 0.14);
      border-color: rgba(220, 53, 69, 0.35);
      color: #8a1f2c;
    }

    /* Alert action panel */
    .alert-actions {
      padding: 0.75rem 1rem;
      background: rgba(33, 68, 120, 0.05);
      border-left: 3px solid #214478ff;
      margin: 0;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .alert-actions button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.88rem;
      font-weight: 600;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .alert-actions button:hover {
      background: #1a3661;
    }

    .alert-actions button.secondary {
      background: white;
      color: #214478ff;
      border: 1px solid #214478ff;
    }

    .alert-actions button.secondary:hover {
      background: rgba(33, 68, 120, 0.1);
    }

    .alert-actions button.danger {
      background: #dc3545;
      border-color: #c82333;
    }

    .alert-actions button.danger:hover {
      background: #c82333;
    }

    .alert-actions button.success {
      background: #28a745;
      border-color: #218838;
    }

    .alert-actions button.success:hover {
      background: #218838;
    }

    .alert-actions .confirmation {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .alert-actions .confirmation-text {
      font-size: 0.88rem;
      color: #2d2d2d;
      font-weight: 600;
    }

    .alert-actions .edit-price-label {
      font-size: 0.88rem;
      color: #2d2d2d;
      font-weight: 600;
    }

    .price-change-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .price-change-input {
      position: relative;
      display: inline-block;
    }

    .price-change-input::before {
      content: '$';
      position: absolute;
      left: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }

    .price-change-input input {
      width: 80px;
      height: 32px;
      padding: 0 0.3rem 0 1.5rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 0.9rem;
      text-align: right;
    }

    .clear-inactive-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    .clear-inactive-actions {
      padding: 0.75rem 1rem;
      background: rgba(220, 53, 69, 0.08);
      border: 1px solid #dc3545;
      border-radius: 0.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .clear-inactive-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: #dc3545;
      border: 1px solid #c82333;
      color: white;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
    }

    .clear-inactive-btn:hover {
      background: #c82333;
    }

    .hidden {
      display: none !important;
    }

    .home-btn {
      display: block;
      margin: 1.5rem auto 0.25rem;
      padding: 0.6rem 1.25rem;
      border-radius: 999px;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
      width: max-content;
    }

    .home-btn:hover {
      background: #1a3661;
    }

    .footer {
      margin-top: 1.5rem;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.82rem;
      color: #444;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      margin: 0 0.25rem;
      cursor: pointer;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .alerts-table colgroup col:nth-child(3) { width: 15%; }
      .alerts-table tbody td:nth-child(3) {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- Logo at top -->
    <a href="/">
      <img src="/images/logo.svg" alt="Shoe Beagle Logo" class="brand-logo">
    </a>

    <!-- Create Alert Section -->
    <div class="create-alert-section">
      <div class="section-title">Create New Alert</div>
      
      <form id="createAlertForm">
        <div class="form-group">
          <label class="form-label" for="alertEmail">Email Address *</label>
          <input 
            type="email" 
            id="alertEmail" 
            placeholder="your@email.com" 
            required
          />
          <div class="form-hint">We'll notify you when your shoe hits your target price</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertBrand">Shoe Brand *</label>
          <div class="input-wrapper">
            <input 
              type="text" 
              id="alertBrand" 
              placeholder="e.g., Nike, Hoka, Brooks" 
              autocomplete="off"
              required
            />
            <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
            <div id="alertBrandSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertModel">Shoe Model *</label>
          <div class="input-wrapper">
            <input 
              type="text" 
              id="alertModel" 
              placeholder="e.g., Pegasus, Clifton, Ghost" 
              autocomplete="off"
              required
            />
            <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
            <div id="alertModelSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Gender Preference</label>
          <div class="gender-selector">
            <div class="gender-option">
              <input type="radio" id="genderBoth" name="gender" value="" checked>
              <label for="genderBoth">Both</label>
            </div>
            <div class="gender-option">
              <input type="radio" id="genderMens" name="gender" value="mens">
              <label for="genderMens">Mens</label>
            </div>
            <div class="gender-option">
              <input type="radio" id="genderWomens" name="gender" value="womens">
              <label for="genderWomens">Womens</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertPrice">Target Price *</label>
          <div class="price-input-wrapper">
            <input 
              type="number" 
              id="alertPrice" 
              placeholder="0.00" 
              step="0.01" 
              min="0.01"
              required
            />
          </div>
          <div class="form-hint">Alert expires after 30 days</div>
        </div>

        <button type="submit" class="submit-btn" id="createAlertBtn">Create Alert</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>

    <!-- Alerts Dashboard -->
    <div id="alertsDashboard" class="alerts-dashboard">
      <div class="alerts-title">My Alerts</div>
      <div class="alerts-instruction">Tap or click a row to manage an alert.</div>

      <div class="alerts-table-wrapper">
        <table class="alerts-table" aria-label="My Alerts Table" id="alertsTable">
          <colgroup>
            <col style="width: 10%;">  <!-- Date Set -->
            <col style="width: 35%;">  <!-- Shoe -->
            <col style="width: 12%;">  <!-- Email -->
            <col style="width: 7%;">   <!-- Days Left -->
            <col style="width: 10%;">  <!-- Target -->
            <col style="width: 19%;">  <!-- Status -->
          </colgroup>
          <thead>
            <tr>
              <th>Date Set</th>
              <th>Shoe</th>
              <th>Email</th>
              <th>Days Left</th>
              <th>Target</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="alertsTbody"></tbody>
        </table>
      </div>

      <div id="alertsEmpty" class="alerts-muted hidden">No alerts have been set.</div>

      <div class="clear-inactive-wrapper hidden" id="clearInactiveWrapper"></div>
    </div>

    <!-- Close button -->
    <a href="/" class="home-btn">Close</a>

    <!-- Footer -->
    <div class="footer">
      © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script>
    // ========== CONSTANTS & GLOBALS ==========
    const ALERTS_KEY = "shoeBeagleAlerts";
    let alertsMemoryFallback = [];
    let selectedAlertRow = null;

    // Brand-model dictionary (same as index)
    const brandModels = {
      "361°": ["Spire","Fury","Strata","Flame"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Allbirds": ["Tree Dasher","Tree Flyer","Trail Runner SWT","Tree Dashers Relay"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Atreyu": ["Base Model","Artist","Race Model","Daily Trainer"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Craft": ["CTM Ultra","CTM Ultra Carbon","Pro Endur","Nordlite"],
      "Decathlon Kiprun": ["KD900","KS900","Ultralight","Race Light"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "Inov-8": ["Roadfly","Trailfly","Roclite","Mudtalon","X-Talon"],
      "Joe Nimble": ["Addict","Trail Addict","Ultreya","WanderToes"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "La Sportiva": ["Jackal","Akasha","Karacal","Mutant","Kaptiva"],
      "Lems": ["Primal","Primal 2","Trailhead","Mesa"],
      "Merrell": ["Vapor Glove","Trail Glove","Agility Peak","Long Sky","Morphlite"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "Newton": ["Gravity","Distance","Motion","Fate","Kismet"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Norda": ["001","002","003"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Pearl Izumi": ["Flow","Floatride","Trail N2","Road N1"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Vibram FiveFingers": ["V-Run","V-Trail","V-Alpha","KSO EVO","V-Trek"],
      "Vivobarefoot": ["Primus Lite","Primus Trail","Geo Racer","Stealth","Addis"],
      "Xero Shoes": ["HFS","Prio","Speed Force","Mesa Trail","Zelen"]
    };

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));

    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    // DOM Elements
    const createAlertForm = document.getElementById("createAlertForm");
    const alertEmail = document.getElementById("alertEmail");
    const alertBrand = document.getElementById("alertBrand");
    const alertModel = document.getElementById("alertModel");
    const alertPrice = document.getElementById("alertPrice");
    const createAlertBtn = document.getElementById("createAlertBtn");
    const statusMessage = document.getElementById("statusMessage");

    const alertBrandSuggestions = document.getElementById("alertBrandSuggestions");
    const alertModelSuggestions = document.getElementById("alertModelSuggestions");

    const alertsDashboard = document.getElementById("alertsDashboard");
    const alertsTbody = document.getElementById("alertsTbody");
    const alertsEmpty = document.getElementById("alertsEmpty");
    const alertsTable = document.getElementById("alertsTable");
    const clearInactiveWrapper = document.getElementById("clearInactiveWrapper");
    const footerYear = document.getElementById("footerYear");

    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }

    // ========== UTILITY FUNCTIONS ==========
    function nowMs() {
      return Date.now();
    }

    function daysBetween(msA, msB) {
      const diff = Math.abs(msA - msB);
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatDateShort(ms) {
      const d = new Date(ms);
      const day = d.getDate();
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mon = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${day}-${mon}-${yy}`;
    }

    function normalizeStr(s) {
      return String(s || "").trim().toLowerCase();
    }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function canUseLocalStorage() {
      try {
        const k = "__sb_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
      } catch (e) {
        return false;
      }
    }

    // ========== STORAGE FUNCTIONS ==========
    function loadAlerts() {
      if (canUseLocalStorage()) {
        try {
          const raw = localStorage.getItem(ALERTS_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }
      return alertsMemoryFallback;
    }

    function saveAlerts(list) {
      if (canUseLocalStorage()) {
        try {
          localStorage.setItem(ALERTS_KEY, JSON.stringify(list));
        } catch (e) {}
      } else {
        alertsMemoryFallback = list;
      }
    }

    function upsertAlert(newAlert) {
      const list = loadAlerts();
      const idx = list.findIndex(a => a.id === newAlert.id);
      if (idx >= 0) list[idx] = newAlert;
      else list.push(newAlert);
      saveAlerts(list);
    }

    function deleteAlert(alertId) {
      const list = loadAlerts();
      const filtered = list.filter(a => a.id !== alertId);
      saveAlerts(filtered);
    }

    // ========== ALERT STATUS ==========
    function computeAlertStatus(alert) {
      if (alert.cancelledAt) return "Cancelled";
      const ageDays = daysBetween(alert.setAt, nowMs());
      if (ageDays >= 30) return "Expired";
      return "Active";
    }

    function computeDaysLeft(alert) {
      if (alert.cancelledAt) return 0;
      const ageDays = daysBetween(alert.setAt, nowMs());
      const left = 30 - ageDays;
      return left > 0 ? left : 0;
    }

    function pillClassFor(status) {
      if (status === "Active") return "pill active";
      if (status === "Expired") return "pill expired";
      if (status === "Cancelled") return "pill cancelled";
      return "pill";
    }

    // ========== SUGGESTIONS ENGINE ==========
    function squashStr(s) {
      return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;

      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];

      const qLower = q.toLowerCase();

      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }

    function resolveBrand() {
      return resolveBrandKey(alertBrand.value.trim());
    }

    // ========== SUGGESTIONS UI ==========
    const suggestionState = {
      openFor: null,
      items: [],
      activeIndex: -1,
    };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        alertBrandSuggestions.style.display = "none";
        alertBrandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        alertModelSuggestions.style.display = "none";
        alertModelSuggestions.innerHTML = "";
      }

      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";

      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);

        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });

        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));

      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");

        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;

      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    // ========== BRAND SUGGESTIONS ==========
    alertBrand.addEventListener("input", () => {
      const typed = alertBrand.value.trim();

      if (typed.length < 1) {
        closeSuggestions("brand");
        return;
      }

      const matches = filterSuggestions(brands, typed, 12);

      renderSuggestions(alertBrandSuggestions, matches, "brand", (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", alertBrandSuggestions, (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    // ========== MODEL SUGGESTIONS ==========
    alertModel.addEventListener("input", () => {
      const text = alertModel.value.trim();

      if (text.length < 1) {
        closeSuggestions("model");
        return;
      }

      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey]))
        ? brandModels[brandKey]
        : allModels;

      const matches = filterSuggestions(pool, text, 12);

      renderSuggestions(alertModelSuggestions, matches, "model", (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", alertModelSuggestions, (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    // Clear buttons
    document.querySelectorAll('.input-clear').forEach((clearBtn) => {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const input = clearBtn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
          input.value = '';
          input.focus();
          if (input.id === 'alertBrand') closeSuggestions("brand");
          if (input.id === 'alertModel') closeSuggestions("model");
        }
      });
    });

    // Click selects text
    alertBrand.addEventListener("click", () => alertBrand.select());
    alertModel.addEventListener("click", () => alertModel.select());

    // ========== CREATE ALERT FORM ==========
    function showStatus(message, isSuccess) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${isSuccess ? 'success' : 'error'}`;
      statusMessage.style.display = 'block';

      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    createAlertForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const email = sanitizeInput(alertEmail.value);
      const brand = sanitizeInput(alertBrand.value);
      const model = sanitizeInput(alertModel.value);
      const price = parseFloat(alertPrice.value);
      const gender = document.querySelector('input[name="gender"]:checked').value;

      // Validation
      if (!email || !email.includes('@')) {
        showStatus("Please enter a valid email address.", false);
        return;
      }

      if (!brand) {
        showStatus("Please enter a shoe brand.", false);
        return;
      }

      if (!model) {
        showStatus("Please enter a shoe model.", false);
        return;
      }

      if (!price || price <= 0) {
        showStatus("Please enter a valid target price.", false);
        return;
      }

      // Create new alert
      const newAlert = {
        id: `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        email: email,
        brand: brand,
        model: model,
        targetPrice: price.toFixed(2),
        gender: gender,
        setAt: nowMs(),
        cancelledAt: null,
      };

      upsertAlert(newAlert);
      showStatus("Alert created successfully! You'll receive an email when a match is found.", true);

      // Reset form
      createAlertForm.reset();
      
      // Re-render alerts table
      renderAlertsDashboard();
    });

    // ========== ALERTS DASHBOARD ==========
    function clearAllInactive() {
      const list = loadAlerts();
      const active = list.filter(a => {
        const status = computeAlertStatus(a);
        return status === "Active";
      });
      saveAlerts(active);
      renderAlertsDashboard();
    }

    function showConfirmation(actionsDiv, message, onYes) {
      actionsDiv.innerHTML = "";

      const confirmDiv = document.createElement("div");
      confirmDiv.className = "confirmation";

      const confirmText = document.createElement("span");
      confirmText.className = "confirmation-text";
      confirmText.textContent = message;

      const yesBtn = document.createElement("button");
      yesBtn.textContent = "Yes";
      yesBtn.className = "success";
      yesBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        onYes();
      });

      const noBtn = document.createElement("button");
      noBtn.textContent = "No";
      noBtn.className = "secondary";
      noBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        renderAlertsDashboard();
      });

      confirmDiv.appendChild(confirmText);
      confirmDiv.appendChild(yesBtn);
      confirmDiv.appendChild(noBtn);
      actionsDiv.appendChild(confirmDiv);
    }

    function showClearInactiveConfirmation() {
      clearInactiveWrapper.innerHTML = "";

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "clear-inactive-actions";

      const confirmText = document.createElement("span");
      confirmText.className = "confirmation-text";
      confirmText.textContent = "Clear all inactive alerts?";

      const yesBtn = document.createElement("button");
      yesBtn.textContent = "Yes";
      yesBtn.className = "success";
      yesBtn.addEventListener("click", () => {
        clearAllInactive();
      });

      const noBtn = document.createElement("button");
      noBtn.textContent = "No";
      noBtn.className = "secondary";
      noBtn.addEventListener("click", () => {
        renderAlertsDashboard();
      });

      actionsDiv.appendChild(confirmText);
      actionsDiv.appendChild(yesBtn);
      actionsDiv.appendChild(noBtn);
      clearInactiveWrapper.appendChild(actionsDiv);
    }

    function maskEmail(email) {
      if (!email || !email.includes('@')) return email;
      const parts = email.split('@');
      const username = parts[0];
      const domain = parts[1];
      
      if (username.length <= 2) return `${username[0]}***@${domain}`;
      return `${username.substring(0, 2)}***@${domain}`;
    }

    function renderAlertsDashboard() {
      const list = loadAlerts();
      alertsTbody.innerHTML = "";
      selectedAlertRow = null;
      clearInactiveWrapper.innerHTML = "";

      if (!list.length) {
        alertsEmpty.classList.remove("hidden");
        alertsTable.classList.add("hidden");
        clearInactiveWrapper.classList.add("hidden");
        return;
      }

      alertsEmpty.classList.add("hidden");
      alertsTable.classList.remove("hidden");

      const hasInactive = list.some(a => {
        const status = computeAlertStatus(a);
        return status === "Expired" || status === "Cancelled";
      });

      if (hasInactive) {
        clearInactiveWrapper.classList.remove("hidden");
        const clearBtn = document.createElement("button");
        clearBtn.className = "clear-inactive-btn";
        clearBtn.textContent = "Clear Inactive Alerts";
        clearBtn.addEventListener("click", showClearInactiveConfirmation);
        clearInactiveWrapper.appendChild(clearBtn);
      } else {
        clearInactiveWrapper.classList.add("hidden");
      }

      const order = { "Active": 0, "Expired": 1, "Cancelled": 2 };
      const sorted = [...list].sort((a, b) => {
        const sa = computeAlertStatus(a);
        const sb = computeAlertStatus(b);
        if (order[sa] !== order[sb]) return order[sa] - order[sb];
        return (b.setAt || 0) - (a.setAt || 0);
      });

      sorted.forEach(a => {
        const status = computeAlertStatus(a);
        const daysLeft = computeDaysLeft(a);

        const tr = document.createElement("tr");
        tr.dataset.alertId = a.id;

        if (status !== "Active") {
          tr.classList.add("inactive");
        }

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateShort(a.setAt);
        tr.appendChild(tdDate);

        const tdShoe = document.createElement("td");
        const shoeText = `${a.brand} ${a.model}`.trim();
        const genderText = a.gender === "mens" ? " (M)" : a.gender === "womens" ? " (W)" : "";
        tdShoe.textContent = (shoeText + genderText).length > 40 ? (shoeText + genderText).substring(0, 40) + "..." : (shoeText + genderText);
        tdShoe.title = shoeText + genderText;
        tr.appendChild(tdShoe);

        const tdEmail = document.createElement("td");
        tdEmail.textContent = maskEmail(a.email);
        tdEmail.title = a.email;
        tr.appendChild(tdEmail);

        const tdDays = document.createElement("td");
        tdDays.textContent = status === "Active" ? String(daysLeft) : "—";
        tr.appendChild(tdDays);

        const tdTarget = document.createElement("td");
        tdTarget.className = "target-cell";
        tdTarget.textContent = `$${Number(a.targetPrice).toFixed(0)}`;
        tr.appendChild(tdTarget);

        const tdStatus = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = pillClassFor(status);
        pill.textContent = status;
        tdStatus.appendChild(pill);
        tr.appendChild(tdStatus);

        tr.addEventListener("click", (e) => {
          e.stopPropagation();

          const existingActionRow = document.querySelector(".alert-actions-row");
          if (existingActionRow) {
            existingActionRow.remove();
          }

          const allRows = alertsTbody.querySelectorAll("tr");
          allRows.forEach(r => r.classList.remove("selected"));

          if (selectedAlertRow === tr) {
            selectedAlertRow = null;
            return;
          }

          tr.classList.add("selected");
          selectedAlertRow = tr;

          const actionRow = document.createElement("tr");
          actionRow.className = "alert-actions-row";
          const actionCell = document.createElement("td");
          actionCell.colSpan = 6;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "alert-actions";

          if (status === "Active") {
            const priceWrapper = document.createElement("div");
            priceWrapper.className = "price-change-wrapper";

            const editLabel = document.createElement("span");
            editLabel.className = "edit-price-label";
            editLabel.textContent = "Edit Price:";
            priceWrapper.appendChild(editLabel);

            const priceInputWrapper = document.createElement("span");
            priceInputWrapper.className = "price-change-input";

            const priceInput = document.createElement("input");
            priceInput.type = "number";
            priceInput.step = "1";
            priceInput.min = "1";
            priceInput.value = Number(a.targetPrice).toFixed(0);

            priceInputWrapper.appendChild(priceInput);
            priceWrapper.appendChild(priceInputWrapper);

            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save";
            saveBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              const val = Number(priceInput.value);
              if (!isFinite(val) || val <= 0) {
                alert("Please enter a valid target price greater than 0.");
                return;
              }
              showConfirmation(actionsDiv, "Save new price?", () => {
                a.targetPrice = Number(val).toFixed(2);
                a.setAt = nowMs();
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });

            priceWrapper.appendChild(saveBtn);
            actionsDiv.appendChild(priceWrapper);

            const add10Btn = document.createElement("button");
            add10Btn.textContent = "Add 10 Days";
            add10Btn.className = "secondary";
            add10Btn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Add 10 days to alert?", () => {
                const TEN_DAYS_MS = 10 * 24 * 60 * 60 * 1000;
                a.setAt = a.setAt - TEN_DAYS_MS;
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(add10Btn);

            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel Alert";
            cancelBtn.className = "danger";
            cancelBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Cancel this alert?", () => {
                a.cancelledAt = nowMs();
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(cancelBtn);

          } else {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "danger";
            deleteBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Delete this alert?", () => {
                deleteAlert(a.id);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(deleteBtn);
          }

          actionCell.appendChild(actionsDiv);
          actionRow.appendChild(actionCell);
          tr.parentNode.insertBefore(actionRow, tr.nextSibling);
        });

        alertsTbody.appendChild(tr);
      });
    }

    // Click outside to clear selection
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".alerts-table") && !e.target.closest(".alert-actions")) {
        const existingActionRow = document.querySelector(".alert-actions-row");
        if (existingActionRow) {
          existingActionRow.remove();
        }
        const allRows = alertsTbody.querySelectorAll("tr");
        allRows.forEach(r => r.classList.remove("selected"));
        selectedAlertRow = null;
      }
      
      // Close suggestions if clicking outside
      const insideBrand = alertBrandSuggestions.contains(e.target) || alertBrand.contains(e.target);
      const insideModel = alertModelSuggestions.contains(e.target) || alertModel.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    // Initial render
    renderAlertsDashboard();
  </script>
</body>
</html>
