<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Alerts – Shoe Beagle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 2rem 1rem;
      background: #f4ede3ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #2d2d2d;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .page-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .brand-logo {
      display: block;
      width: 600px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover {
      opacity: 0.9;
    }

    /* Alerts dashboard card (copied from index) */
    .alerts-dashboard {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.25rem 1.25rem 1.5rem;
      box-sizing: border-box;
    }

    .alerts-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0.25rem 0 0.3rem;
    }

    .alerts-instruction {
      color: #49543a;
      font-size: 0.88rem;
      text-align: center;
      margin: 0 0 0.6rem;
      font-style: italic;
    }

    .alerts-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    .alerts-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .alerts-table colgroup col:nth-child(1) { width: 12%; }  /* Date Set */
    .alerts-table colgroup col:nth-child(2) { width: 45%; }  /* Shoe */
    .alerts-table colgroup col:nth-child(3) { width: 7%; }   /* Days Left */
    .alerts-table colgroup col:nth-child(4) { width: 10%; }  /* Target */
    .alerts-table colgroup col:nth-child(5) { width: 19%; }  /* Status */

    .alerts-table thead th {
      text-align: left;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #214478ff;
      padding: 0.5rem 0.65rem;
      border-bottom: 2px solid rgba(33, 68, 120, 0.35);
      background: rgba(255, 255, 255, 0.55);
    }

    .alerts-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .alerts-table tbody tr:hover {
      background: rgba(33, 68, 120, 0.08);
    }

    .alerts-table tbody tr.selected {
      background: rgba(33, 68, 120, 0.15);
    }

    .alerts-table tbody tr.inactive {
      background: #e8e8e8;
    }

    .alerts-table tbody tr.inactive:hover {
      background: #d8d8d8;
    }

    .alerts-table tbody td {
      padding: 0.5rem 0.65rem;
      border-bottom: 1px solid rgba(33, 68, 120, 0.18);
      vertical-align: middle;
      font-size: 0.92rem;
      color: #2d2d2d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .alerts-table tbody td:nth-child(2) {
      max-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .alerts-table td.target-cell {
      text-align: right;
    }

    .alerts-muted {
      text-align: center;
      padding: 1.25rem 0.5rem;
      color: #49543a;
      font-size: 0.95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.82rem;
      border: 1px solid rgba(33, 68, 120, 0.25);
      background: rgba(255, 255, 255, 0.6);
      color: #214478ff;
    }

    .pill.active {
      background: rgba(46, 160, 67, 0.20);
      border-color: rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
    }

    .pill.expired {
      background: rgba(150, 150, 150, 0.18);
      border-color: rgba(150, 150, 150, 0.40);
      color: #555;
    }

    .pill.cancelled {
      background: rgba(220, 53, 69, 0.14);
      border-color: rgba(220, 53, 69, 0.35);
      color: #8a1f2c;
    }

    /* Alert action panel (same as index) */
    .alert-actions {
      padding: 0.75rem 1rem;
      background: rgba(33, 68, 120, 0.05);
      border-left: 3px solid #214478ff;
      margin: 0;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .alert-actions button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.88rem;
      font-weight: 600;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .alert-actions button:hover {
      background: #1a3661;
    }

    .alert-actions button.secondary {
      background: white;
      color: #214478ff;
      border: 1px solid #214478ff;
    }

    .alert-actions button.secondary:hover {
      background: rgba(33, 68, 120, 0.1);
    }

    .alert-actions button.danger {
      background: #dc3545;
      border-color: #c82333;
    }

    .alert-actions button.danger:hover {
      background: #c82333;
    }

    .alert-actions button.success {
      background: #28a745;
      border-color: #218838;
    }

    .alert-actions button.success:hover {
      background: #218838;
    }

    .alert-actions .confirmation {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .alert-actions .confirmation-text {
      font-size: 0.88rem;
      color: #2d2d2d;
      font-weight: 600;
    }

    .alert-actions .edit-price-label {
      font-size: 0.88rem;
      color: #2d2d2d;
      font-weight: 600;
    }

    .price-change-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .price-change-input {
      position: relative;
      display: inline-block;
    }

    .price-change-input::before {
      content: '$';
      position: absolute;
      left: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }

    .price-change-input input {
      width: 80px;
      height: 32px;
      padding: 0 0.3rem 0 1.5rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 0.9rem;
      text-align: right;
    }

    .clear-inactive-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    .clear-inactive-actions {
      padding: 0.75rem 1rem;
      background: rgba(220, 53, 69, 0.08);
      border: 1px solid #dc3545;
      border-radius: 0.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .clear-inactive-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: #dc3545;
      border: 1px solid #c82333;
      color: white;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
    }

    .clear-inactive-btn:hover {
      background: #c82333;
    }

    .hidden {
      display: none !important;
    }

    /* Close button (same as Privacy / other pages) */
    .home-btn {
      display: block;
      margin: 1.5rem auto 0.25rem;
      padding: 0.6rem 1.25rem;
      border-radius: 999px;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
      width: max-content;
    }

    .home-btn:hover {
      background: #1a3661;
    }

    /* Footer */
    .footer {
      margin-top: 1.5rem;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.82rem;
      color: #444;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      margin: 0 0.25rem;
      cursor: pointer;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page-container">

    <!-- Logo at top -->
    <a href="/">
      <img src="/images/logo.svg" alt="Shoe Beagle Logo" class="brand-logo">
    </a>

    <!-- Alerts Dashboard -->
    <div id="alertsDashboard" class="alerts-dashboard">
      <div class="alerts-title">My Alerts</div>
      <div class="alerts-instruction">Tap or click a row below to manage your alert.</div>

      <div class="alerts-table-wrapper">
        <table class="alerts-table" aria-label="My Alerts Table" id="alertsTable">
          <colgroup>
            <col style="width: 12%;">  <!-- Date Set -->
            <col style="width: 45%;">  <!-- Shoe -->
            <col style="width: 7%;">   <!-- Days Left -->
            <col style="width: 10%;">  <!-- Target -->
            <col style="width: 19%;">  <!-- Status -->
          </colgroup>
          <thead>
            <tr>
              <th>Date Set</th>
              <th>Shoe</th>
              <th>Days Left</th>
              <th>Target</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="alertsTbody"></tbody>
        </table>
      </div>

      <div id="alertsEmpty" class="alerts-muted hidden">No alerts have been set.</div>

      <div class="clear-inactive-wrapper hidden" id="clearInactiveWrapper"></div>
    </div>

    <!-- Close button (back to home) -->
    <a href="/" class="home-btn">Close</a>

    <!-- Footer -->
    <div class="footer">
      © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script>
    const ALERTS_KEY = "shoeBeagleAlerts";
    let alertsMemoryFallback = [];
    let selectedAlertRow = null;

    const alertsDashboard = document.getElementById("alertsDashboard");
    const alertsTbody = document.getElementById("alertsTbody");
    const alertsEmpty = document.getElementById("alertsEmpty");
    const alertsTable = document.getElementById("alertsTable");
    const clearInactiveWrapper = document.getElementById("clearInactiveWrapper");
    const footerYear = document.getElementById("footerYear");

    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }

    function nowMs() {
      return Date.now();
    }

    function daysBetween(msA, msB) {
      const diff = Math.abs(msA - msB);
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatDateShort(ms) {
      const d = new Date(ms);
      const day = d.getDate();
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mon = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${day}-${mon}-${yy}`;
    }

    function canUseLocalStorage() {
      try {
        const k = "__sb_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
      } catch (e) {
        return false;
      }
    }

    function loadAlerts() {
      if (canUseLocalStorage()) {
        try {
          const raw = localStorage.getItem(ALERTS_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }
      return alertsMemoryFallback;
    }

    function saveAlerts(list) {
      if (canUseLocalStorage()) {
        try {
          localStorage.setItem(ALERTS_KEY, JSON.stringify(list));
        } catch (e) {}
      } else {
        alertsMemoryFallback = list;
      }
    }

    function computeAlertStatus(alert) {
      if (alert.cancelledAt) return "Cancelled";
      const ageDays = daysBetween(alert.setAt, nowMs());
      if (ageDays >= 30) return "Expired";
      return "Active";
    }

    function computeDaysLeft(alert) {
      if (alert.cancelledAt) return 0;
      const ageDays = daysBetween(alert.setAt, nowMs());
      const left = 30 - ageDays;
      return left > 0 ? left : 0;
    }

    function pillClassFor(status) {
      if (status === "Active") return "pill active";
      if (status === "Expired") return "pill expired";
      if (status === "Cancelled") return "pill cancelled";
      return "pill";
    }

    function upsertAlert(newAlert) {
      const list = loadAlerts();
      const idx = list.findIndex(a => a.id === newAlert.id);
      if (idx >= 0) list[idx] = newAlert;
      else list.push(newAlert);
      saveAlerts(list);
    }

    function deleteAlert(alertId) {
      const list = loadAlerts();
      const filtered = list.filter(a => a.id !== alertId);
      saveAlerts(filtered);
    }

    function clearAllInactive() {
      const list = loadAlerts();
      const active = list.filter(a => {
        const status = computeAlertStatus(a);
        return status === "Active";
      });
      saveAlerts(active);
      renderAlertsDashboard();
    }

    function showConfirmation(actionsDiv, message, onYes) {
      actionsDiv.innerHTML = "";

      const confirmDiv = document.createElement("div");
      confirmDiv.className = "confirmation";

      const confirmText = document.createElement("span");
      confirmText.className = "confirmation-text";
      confirmText.textContent = message;

      const yesBtn = document.createElement("button");
      yesBtn.textContent = "Yes";
      yesBtn.className = "success";
      yesBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        onYes();
      });

      const noBtn = document.createElement("button");
      noBtn.textContent = "No";
      noBtn.className = "secondary";
      noBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        renderAlertsDashboard();
      });

      confirmDiv.appendChild(confirmText);
      confirmDiv.appendChild(yesBtn);
      confirmDiv.appendChild(noBtn);
      actionsDiv.appendChild(confirmDiv);
    }

    function showClearInactiveConfirmation() {
      clearInactiveWrapper.innerHTML = "";

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "clear-inactive-actions";

      const confirmText = document.createElement("span");
      confirmText.className = "confirmation-text";
      confirmText.textContent = "Clear all inactive alerts?";

      const yesBtn = document.createElement("button");
      yesBtn.textContent = "Yes";
      yesBtn.className = "success";
      yesBtn.addEventListener("click", () => {
        clearAllInactive();
      });

      const noBtn = document.createElement("button");
      noBtn.textContent = "No";
      noBtn.className = "secondary";
      noBtn.addEventListener("click", () => {
        renderAlertsDashboard();
      });

      actionsDiv.appendChild(confirmText);
      actionsDiv.appendChild(yesBtn);
      actionsDiv.appendChild(noBtn);
      clearInactiveWrapper.appendChild(actionsDiv);
    }

    function renderAlertsDashboard() {
      const list = loadAlerts();
      alertsTbody.innerHTML = "";
      selectedAlertRow = null;
      clearInactiveWrapper.innerHTML = "";

      if (!list.length) {
        alertsEmpty.classList.remove("hidden");
        alertsTable.classList.add("hidden");
        clearInactiveWrapper.classList.add("hidden");
        return;
      }

      alertsEmpty.classList.add("hidden");
      alertsTable.classList.remove("hidden");

      const hasInactive = list.some(a => {
        const status = computeAlertStatus(a);
        return status === "Expired" || status === "Cancelled";
      });

      if (hasInactive) {
        clearInactiveWrapper.classList.remove("hidden");
        const clearBtn = document.createElement("button");
        clearBtn.className = "clear-inactive-btn";
        clearBtn.textContent = "Clear Inactive Alerts";
        clearBtn.addEventListener("click", showClearInactiveConfirmation);
        clearInactiveWrapper.appendChild(clearBtn);
      } else {
        clearInactiveWrapper.classList.add("hidden");
      }

      const order = { "Active": 0, "Expired": 1, "Cancelled": 2 };
      const sorted = [...list].sort((a, b) => {
        const sa = computeAlertStatus(a);
        const sb = computeAlertStatus(b);
        if (order[sa] !== order[sb]) return order[sa] - order[sb];
        return (b.setAt || 0) - (a.setAt || 0);
      });

      sorted.forEach(a => {
        const status = computeAlertStatus(a);
        const daysLeft = computeDaysLeft(a);

        const tr = document.createElement("tr");
        tr.dataset.alertId = a.id;

        if (status !== "Active") {
          tr.classList.add("inactive");
        }

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateShort(a.setAt);
        tr.appendChild(tdDate);

        const tdShoe = document.createElement("td");
        const shoeText = `${a.brand} ${a.model}`.trim();
        tdShoe.textContent = shoeText.length > 30 ? shoeText.substring(0, 30) + "..." : shoeText;
        tdShoe.title = shoeText;
        tr.appendChild(tdShoe);

        const tdDays = document.createElement("td");
        tdDays.textContent = status === "Active" ? String(daysLeft) : "—";
        tr.appendChild(tdDays);

        const tdTarget = document.createElement("td");
        tdTarget.className = "target-cell";
        tdTarget.textContent = `$${Number(a.targetPrice).toFixed(0)}`;
        tr.appendChild(tdTarget);

        const tdStatus = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = pillClassFor(status);
        pill.textContent = status;
        tdStatus.appendChild(pill);
        tr.appendChild(tdStatus);

        tr.addEventListener("click", (e) => {
          e.stopPropagation();

          const existingActionRow = document.querySelector(".alert-actions-row");
          if (existingActionRow) {
            existingActionRow.remove();
          }

          const allRows = alertsTbody.querySelectorAll("tr");
          allRows.forEach(r => r.classList.remove("selected"));

          if (selectedAlertRow === tr) {
            selectedAlertRow = null;
            return;
          }

          tr.classList.add("selected");
          selectedAlertRow = tr;

          const actionRow = document.createElement("tr");
          actionRow.className = "alert-actions-row";
          const actionCell = document.createElement("td");
          actionCell.colSpan = 5;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "alert-actions";

          if (status === "Active") {
            const priceWrapper = document.createElement("div");
            priceWrapper.className = "price-change-wrapper";

            const editLabel = document.createElement("span");
            editLabel.className = "edit-price-label";
            editLabel.textContent = "Edit Price:";
            priceWrapper.appendChild(editLabel);

            const priceInputWrapper = document.createElement("span");
            priceInputWrapper.className = "price-change-input";

            const priceInput = document.createElement("input");
            priceInput.type = "number";
            priceInput.step = "1";
            priceInput.min = "1";
            priceInput.value = Number(a.targetPrice).toFixed(0);

            priceInputWrapper.appendChild(priceInput);
            priceWrapper.appendChild(priceInputWrapper);

            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save";
            saveBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              const val = Number(priceInput.value);
              if (!isFinite(val) || val <= 0) {
                alert("Please enter a valid target price greater than 0.");
                return;
              }
              showConfirmation(actionsDiv, "Save new price?", () => {
                a.targetPrice = Number(val).toFixed(2);
                a.setAt = nowMs();
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });

            priceWrapper.appendChild(saveBtn);
            actionsDiv.appendChild(priceWrapper);

            const add10Btn = document.createElement("button");
            add10Btn.textContent = "Add 10 Days";
            add10Btn.className = "secondary";
            add10Btn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Add 10 days to alert?", () => {
                const TEN_DAYS_MS = 10 * 24 * 60 * 60 * 1000;
                a.setAt = a.setAt - TEN_DAYS_MS;
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(add10Btn);

            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel Alert";
            cancelBtn.className = "danger";
            cancelBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Cancel this alert?", () => {
                a.cancelledAt = nowMs();
                upsertAlert(a);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(cancelBtn);

          } else {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "danger";
            deleteBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              showConfirmation(actionsDiv, "Delete this alert?", () => {
                deleteAlert(a.id);
                renderAlertsDashboard();
              });
            });
            actionsDiv.appendChild(deleteBtn);
          }

          actionCell.appendChild(actionsDiv);
          actionRow.appendChild(actionCell);
          tr.parentNode.insertBefore(actionRow, tr.nextSibling);
        });

        alertsTbody.appendChild(tr);
      });
    }

    // Click outside actions to clear selection
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".alerts-table") && !e.target.closest(".alert-actions")) {
        const existingActionRow = document.querySelector(".alert-actions-row");
        if (existingActionRow) {
          existingActionRow.remove();
        }
        const allRows = alertsTbody.querySelectorAll("tr");
        allRows.forEach(r => r.classList.remove("selected"));
        selectedAlertRow = null;
      }
    });

    // Initial render
    renderAlertsDashboard();
  </script>
</body>
</html>
