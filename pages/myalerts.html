<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <title>My Alerts – Shoe Beagle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 2rem 1rem;
      background: #f4ede3ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #2d2d2d;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .page-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .brand-logo {
      display: block;
      width: 600px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover { opacity: 0.9; }

    /* Create Alert Section */
    .create-alert-section {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }

    .section-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0 0 1rem;
    }

    .form-group { margin-bottom: 1rem; }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #214478ff;
      margin-bottom: 0.4rem;
    }

    .input-wrapper { position: relative; width: 100%; }

    input[type="text"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      height: 42px;
      padding: 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    /* Hide number input arrows */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    input:focus {
      outline: none;
      border-color: #1a3661;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.1);
    }

    .input-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #999;
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      padding: 0;
      line-height: 1;
      z-index: 20;
    }

    .input-clear:hover { background: #666; }

    .input-wrapper:has(input:not(:placeholder-shown)) .input-clear { display: flex; }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 30;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.5rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .suggestion-item:hover,
    .suggestion-item.active { background: #e8f0ff; }

    /* Gender and Price Row */
    .gender-price-row {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .gender-group {
      flex: 1;
      min-width: 250px;
    }

    .price-group {
      flex: 0 0 auto;
    }

    .gender-selector {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .gender-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.85rem;
      border: 2px solid #214478ff;
      background: white;
      color: #214478ff;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      width: 70px;
      text-align: center;
    }

    .gender-chip:hover {
      background: rgba(33, 68, 120, 0.1);
    }

    .gender-chip.active {
      background: #214478ff;
      color: white;
    }

    .price-input-wrapper {
      position: relative;
      display: inline-block;
      width: 150px;
    }

    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
      z-index: 1;
    }

    .price-input-wrapper input { 
      padding-left: 2rem; 
      padding-right: 2rem;
      text-align: right; 
    }

    .price-input-wrapper .input-clear {
      right: 0.5rem;
    }

    .submit-btn {
      width: 100%;
      height: 48px;
      border-radius: 0.5rem;
      border: none;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 0.5rem;
    }

    .submit-btn:hover { background: #1a3661; }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .form-hint {
      font-size: 0.82rem;
      color: #666;
      font-style: italic;
      margin-top: 0.3rem;
    }

    .status-message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      text-align: center;
      display: none;
    }

    .status-message.success {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid rgba(46, 160, 67, 0.5);
      color: #1f6a2a;
    }

    .status-message.error {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: #8a1f2c;
    }

    .status-message.warning {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.5);
      color: #856404;
    }

    /* Alerts dashboard */
    .alerts-dashboard {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.25rem 1.25rem 1.5rem;
      box-sizing: border-box;
    }

    .alerts-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0.25rem 0 0.3rem;
    }

    .alerts-instruction {
      color: #49543a;
      font-size: 0.88rem;
      text-align: center;
      margin: 0 0 0.6rem;
      font-style: italic;
    }

    .alerts-table-wrapper { width: 100%; overflow-x: auto; }

    .alerts-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .alerts-table colgroup col:nth-child(1) { width: 10%; }
    .alerts-table colgroup col:nth-child(2) { width: 35%; }
    .alerts-table colgroup col:nth-child(3) { width: 12%; }
    .alerts-table colgroup col:nth-child(4) { width: 7%; }
    .alerts-table colgroup col:nth-child(5) { width: 10%; }
    .alerts-table colgroup col:nth-child(6) { width: 19%; }

    .alerts-table thead th {
      text-align: left;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #214478ff;
      padding: 0.5rem 0.65rem;
      border-bottom: 2px solid rgba(33, 68, 120, 0.35);
      background: rgba(255, 255, 255, 0.55);
    }

    .alerts-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .alerts-table tbody tr:hover { background: rgba(33, 68, 120, 0.08); }
    .alerts-table tbody tr.selected { background: rgba(33, 68, 120, 0.15); }
    .alerts-table tbody tr.inactive { 
      background: #e8e8e8;
      opacity: 0.6;
    }
    .alerts-table tbody tr.inactive:hover { background: #d8d8d8; }

    .alerts-table tbody td {
      padding: 0.5rem 0.65rem;
      border-bottom: 1px solid rgba(33, 68, 120, 0.18);
      vertical-align: middle;
      font-size: 0.92rem;
      color: #2d2d2d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .alerts-table tbody td:nth-child(2),
    .alerts-table tbody td:nth-child(3) {
      max-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .alerts-table td.target-cell { text-align: right; }

    /* Stacked date and days */
    .stacked-cell {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      line-height: 1.2;
    }

    .stacked-primary {
      font-weight: 600;
      font-size: 0.92rem;
    }

    .stacked-secondary {
      font-size: 0.75rem;
      color: #666;
    }

    .alerts-muted {
      text-align: center;
      padding: 1.25rem 0.5rem;
      color: #49543a;
      font-size: 0.95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.82rem;
      border: 1px solid rgba(33, 68, 120, 0.25);
      background: rgba(255, 255, 255, 0.6);
      color: #214478ff;
    }

    .pill.active {
      background: rgba(46, 160, 67, 0.20);
      border-color: rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
    }

    .pill.expired {
      background: rgba(150, 150, 150, 0.18);
      border-color: rgba(150, 150, 150, 0.40);
      color: #555;
    }

    .pill.cancelled {
      background: rgba(220, 53, 69, 0.14);
      border-color: rgba(220, 53, 69, 0.35);
      color: #8a1f2c;
    }

    /* Alert action panel */
    .alert-actions {
      padding: 0.75rem 1rem;
      background: rgba(33, 68, 120, 0.05);
      border-left: 3px solid #214478ff;
      margin: 0;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .alert-actions button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.88rem;
      font-weight: 600;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
      position: relative;
    }

    .alert-actions button:hover { background: #1a3661; }

    .alert-actions button.secondary {
      background: white;
      color: #214478ff;
      border: 1px solid #214478ff;
    }

    .alert-actions button.secondary:hover { background: rgba(33, 68, 120, 0.1); }

    .alert-actions button.danger {
      background: #dc3545;
      border-color: #c82333;
    }

    .alert-actions button.danger:hover { background: #c82333; }

    .alert-actions button.success {
      background: #28a745;
      border-color: #218838;
    }

    .alert-actions button.success:hover { background: #218838; }

    .alert-actions .edit-price-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .alert-actions .edit-price-input {
      width: 120px;
      height: 36px;
      padding: 0 0.5rem 0 1.75rem;
      border-radius: 0.4rem;
      border: 1px solid #214478ff;
      font-size: 0.9rem;
      text-align: right;
    }

    .alert-actions .price-input-wrapper-small {
      position: relative;
      display: inline-block;
    }

    .alert-actions .price-input-wrapper-small::before {
      content: '$';
      position: absolute;
      left: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }

    .alert-actions .confirmation {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .alert-actions .confirmation-text {
      font-size: 0.88rem;
      color: #2d2d2d;
      font-weight: 600;
    }

    /* Tooltip styles */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #2d2d2d;
      color: white;
      padding: 0.4rem 0.6rem;
      border-radius: 0.3rem;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10000;
    }

    [data-tooltip]:hover::after {
      opacity: 1;
    }

    .hidden { display: none !important; }

    .home-btn {
      display: block;
      margin: 1.5rem auto 0.25rem;
      padding: 0.6rem 1.25rem;
      border-radius: 999px;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
      width: max-content;
      position: relative;
    }

    .home-btn:hover { background: #1a3661; }

    .footer {
      margin-top: 1.5rem;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.82rem;
      color: #444;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      margin: 0 0.25rem;
      cursor: pointer;
    }

    .footer a:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .alerts-table colgroup col:nth-child(3) { width: 15%; }
      .alerts-table tbody td:nth-child(3) { font-size: 0.8rem; }
      
      .gender-price-row {
        flex-direction: column;
        gap: 1rem;
      }
      
      .gender-group,
      .price-group {
        width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <div class="page-container">
    <!-- Logo -->
    <a href="/">
      <img src="/images/logo.svg" alt="Shoe Beagle Logo" class="brand-logo">
    </a>

    <!-- Create Alert -->
    <div class="create-alert-section">
      <div class="section-title">Set Alert</div>

      <form id="createAlertForm">
        <div class="form-group">
          <label class="form-label" for="alertEmail">Email Address *</label>
          <input type="email" id="alertEmail" placeholder="your@email.com" required />
          <div class="form-hint">We'll email you to confirm the alert, and again when we find matches.</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertBrand">Shoe Brand *</label>
          <div class="input-wrapper">
            <input type="text" id="alertBrand" placeholder="e.g., Nike, Hoka, Brooks" autocomplete="off" required />
            <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
            <div id="alertBrandSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertModel">Shoe Model *</label>
          <div class="input-wrapper">
            <input type="text" id="alertModel" placeholder="e.g., Pegasus, Clifton, Ghost" autocomplete="off" required />
            <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
            <div id="alertModelSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <div class="gender-price-row">
            <div class="gender-group">
              <label class="form-label">Gender Preference</label>
              <div class="gender-selector">
                <div class="gender-chip active" data-gender="both">Both</div>
                <div class="gender-chip" data-gender="mens">Mens</div>
                <div class="gender-chip" data-gender="womens">Womens</div>
              </div>
            </div>
            
            <div class="price-group">
              <label class="form-label" for="alertPrice">Target Price *</label>
              <div class="price-input-wrapper">
                <input type="text" id="alertPrice" placeholder="0" inputmode="numeric" required />
                <button type="button" class="input-clear" aria-label="Clear price">&times;</button>
              </div>
            </div>
          </div>
          <div class="form-hint">When we find your shoes equal to or lower than your set price, we'll notify you by email. Alert expires after 30 days.</div>
        </div>

        <button type="submit" class="submit-btn" id="createAlertBtn">Set Alert</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>

    <!-- Alerts Dashboard -->
    <div id="alertsDashboard" class="alerts-dashboard">
      <div class="alerts-title">My Alerts</div>
      <div class="alerts-instruction">Tap or click a row to manage an alert.</div>

      <div class="alerts-table-wrapper">
        <table class="alerts-table" aria-label="My Alerts Table" id="alertsTable">
          <colgroup>
            <col style="width: 10%;">
            <col style="width: 35%;">
            <col style="width: 12%;">
            <col style="width: 7%;">
            <col style="width: 10%;">
            <col style="width: 19%;">
          </colgroup>
          <thead>
            <tr>
              <th>Date Set</th>
              <th>Shoe</th>
              <th>Email</th>
              <th>Days Left</th>
              <th>Target</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="alertsTbody"></tbody>
        </table>
      </div>

      <div id="alertsEmpty" class="alerts-muted hidden">No alerts have been set.</div>
    </div>

    <a href="/" class="home-btn" data-tooltip="Back to home page">Return</a>

    <div class="footer">
      © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script>
    // =======================
    // BACKEND ENDPOINTS
    // =======================
    const API = {
      create: "/api/alerts/create",
      list: "/api/alerts/list",
      cancel: "/api/alerts/cancel",
      update: "/api/alerts/update",
      remove: "/api/alerts/remove"
    };

    // =======================
    // BRAND/MODEL SUGGESTIONS
    // =======================
    const brandModels = {
      "361°": ["Spire","Fury","Strata","Flame"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Allbirds": ["Tree Dasher","Tree Flyer","Trail Runner SWT","Tree Dashers Relay"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Atreyu": ["Base Model","Artist","Race Model","Daily Trainer"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Craft": ["CTM Ultra","CTM Ultra Carbon","Pro Endur","Nordlite"],
      "Decathlon Kiprun": ["KD900","KS900","Ultralight","Race Light"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "Inov-8": ["Roadfly","Trailfly","Roclite","Mudtalon","X-Talon"],
      "Joe Nimble": ["Addict","Trail Addict","Ultreya","WanderToes"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "La Sportiva": ["Jackal","Akasha","Karacal","Mutant","Kaptiva"],
      "Lems": ["Primal","Primal 2","Trailhead","Mesa"],
      "Merrell": ["Vapor Glove","Trail Glove","Agility Peak","Long Sky","Morphlite"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "Newton": ["Gravity","Distance","Motion","Fate","Kismet"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Norda": ["001","002","003"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Pearl Izumi": ["Flow","Floatride","Trail N2","Road N1"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Vibram FiveFingers": ["V-Run","V-Trail","V-Alpha","KSO EVO","V-Trek"],
      "Vivobarefoot": ["Primus Lite","Primus Trail","Geo Racer","Stealth","Addis"],
      "Xero Shoes": ["HFS","Prio","Speed Force","Mesa Trail","Zelen"]
    };

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));
    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    // =======================
    // DOM
    // =======================
    const createAlertForm = document.getElementById("createAlertForm");
    const alertEmail = document.getElementById("alertEmail");
    const alertBrand = document.getElementById("alertBrand");
    const alertModel = document.getElementById("alertModel");
    const alertPrice = document.getElementById("alertPrice");
    const createAlertBtn = document.getElementById("createAlertBtn");
    const statusMessage = document.getElementById("statusMessage");

    const alertBrandSuggestions = document.getElementById("alertBrandSuggestions");
    const alertModelSuggestions = document.getElementById("alertModelSuggestions");

    const alertsTbody = document.getElementById("alertsTbody");
    const alertsEmpty = document.getElementById("alertsEmpty");
    const alertsTable = document.getElementById("alertsTable");
    const footerYear = document.getElementById("footerYear");

    if (footerYear) footerYear.textContent = new Date().getFullYear();

    // =======================
    // STATE
    // =======================
    let selectedAlertRow = null;
    let currentAlerts = [];
    let currentEmail = "";
    let selectedGender = "both"; // Start with "both"

    // =======================
    // PRICE INPUT - NUMBERS ONLY
    // =======================
    alertPrice.addEventListener('input', (e) => {
      // Remove any non-numeric characters
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    alertPrice.addEventListener('keypress', (e) => {
      // Only allow numeric keys
      if (e.key && !/[0-9]/.test(e.key)) {
        e.preventDefault();
      }
    });

    alertPrice.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numericOnly = pastedText.replace(/[^0-9]/g, '');
      document.execCommand('insertText', false, numericOnly);
    });

    // =======================
    // GENDER CHIP HANDLING
    // =======================
    document.querySelectorAll(".gender-chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const gender = chip.dataset.gender;
        
        // Don't do anything if clicking the already selected chip
        if (selectedGender === gender) {
          return;
        }
        
        // Deselect all chips
        document.querySelectorAll(".gender-chip").forEach(c => c.classList.remove("active"));
        
        // Select the clicked chip
        chip.classList.add("active");
        selectedGender = gender;
      });
    });

    // =======================
    // UTILS
    // =======================
    function nowMs() { return Date.now(); }

    function daysBetween(msA, msB) {
      const diff = Math.abs(msA - msB);
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatDateShort(ms) {
      const d = new Date(ms);
      const day = d.getDate();
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mon = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${day}-${mon}-${yy}`;
    }

    function normalizeStr(s) {
      return String(s || "").trim().toLowerCase();
    }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function maskEmail(email) {
      if (!email || !email.includes("@")) return email || "";
      const [user, domain] = email.split("@");
      if (!user) return `***@${domain}`;
      if (user.length <= 2) return `${user[0]}***@${domain}`;
      return `${user.substring(0, 2)}***@${domain}`;
    }

    function computeAlertStatus(alert) {
      if (alert.cancelledAt) return "Cancelled";
      const ageDays = Math.floor((nowMs() - Number(alert.setAt || 0)) / (1000 * 60 * 60 * 24));
      if (ageDays >= 30) return "Expired";
      return "Active";
    }

    function computeDaysLeft(alert) {
      if (alert.cancelledAt) return 0;
      const ageDays = Math.floor((nowMs() - Number(alert.setAt || 0)) / (1000 * 60 * 60 * 24));
      const left = 30 - ageDays;
      return left > 0 ? left : 0;
    }

    function pillClassFor(status) {
      if (status === "Active") return "pill active";
      if (status === "Expired") return "pill expired";
      if (status === "Cancelled") return "pill cancelled";
      return "pill";
    }

    function showStatus(message, type = "error") {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = "block";
      setTimeout(() => { statusMessage.style.display = "none"; }, 6500);
    }

    function setBusy(isBusy) {
      createAlertBtn.disabled = isBusy;
      createAlertBtn.textContent = isBusy ? "Setting..." : "Set Alert";
    }

    // =======================
    // API CALLS
    // =======================
    async function apiListAlerts(email) {
      const url = `${API.list}?email=${encodeURIComponent(email)}`;
      const res = await fetch(url, { method: "GET" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Failed to load alerts.");
      }
      return Array.isArray(data.alerts) ? data.alerts : [];
    }

    async function apiCreateAlert(payload) {
      const res = await fetch(API.create, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Failed to create alert.");
      }
      return data;
    }

    async function apiCancelAlert(alertId, email) {
      const res = await fetch(API.cancel, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alertId, email }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Failed to cancel alert.");
      }
      return data;
    }

    async function apiUpdateAlert(alertId, email, newPrice) {
      const res = await fetch(API.update, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alertId, email, targetPrice: newPrice }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Failed to update alert.");
      }
      return data;
    }

    async function apiRemoveAlert(alertId, email) {
      const res = await fetch(API.remove, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alertId, email }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Failed to remove alert.");
      }
      return data;
    }

    // =======================
    // SUGGESTIONS ENGINE
    // =======================
    function squashStr(s) {
      return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;
      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];
      const qLower = q.toLowerCase();

      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }

    function resolveBrand() {
      return resolveBrandKey(alertBrand.value.trim());
    }

    const suggestionState = {
      openFor: null,
      items: [],
      activeIndex: -1,
    };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        alertBrandSuggestions.style.display = "none";
        alertBrandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        alertModelSuggestions.style.display = "none";
        alertModelSuggestions.innerHTML = "";
      }
      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";

      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });
        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));

      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");

        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;

      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    // Brand suggestions
    alertBrand.addEventListener("input", () => {
      const typed = alertBrand.value.trim();
      if (typed.length < 1) { closeSuggestions("brand"); return; }
      const matches = filterSuggestions(brands, typed, 12);
      renderSuggestions(alertBrandSuggestions, matches, "brand", (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", alertBrandSuggestions, (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    // Model suggestions
    alertModel.addEventListener("input", () => {
      const text = alertModel.value.trim();
      if (text.length < 1) { closeSuggestions("model"); return; }

      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey]))
        ? brandModels[brandKey]
        : allModels;

      const matches = filterSuggestions(pool, text, 12);
      renderSuggestions(alertModelSuggestions, matches, "model", (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", alertModelSuggestions, (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    // Clear buttons
    document.querySelectorAll(".input-clear").forEach((clearBtn) => {
      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const wrapper = clearBtn.closest('.input-wrapper, .price-input-wrapper');
        const input = wrapper ? wrapper.querySelector('input') : clearBtn.previousElementSibling;
        if (input && input.tagName === "INPUT") {
          input.value = "";
          input.focus();
          if (input.id === "alertBrand") closeSuggestions("brand");
          if (input.id === "alertModel") closeSuggestions("model");
        }
      });
    });

    // Click selects text
    alertBrand.addEventListener("click", () => alertBrand.select());
    alertModel.addEventListener("click", () => alertModel.select());

    // =======================
    // DASHBOARD RENDER
    // =======================
    function showEditPriceForm(actionsDiv, alert) {
      actionsDiv.innerHTML = "";

      const formDiv = document.createElement("div");
      formDiv.className = "edit-price-form";

      const label = document.createElement("span");
      label.className = "confirmation-text";
      label.textContent = "New target price:";

      const wrapper = document.createElement("div");
      wrapper.className = "price-input-wrapper-small";

      const input = document.createElement("input");
      input.type = "text";
      input.inputMode = "numeric";
      input.className = "edit-price-input";
      input.value = Math.round(Number(alert.targetPrice || 0));
      input.placeholder = "0";

      // Numbers only for edit input
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });
      input.addEventListener('keypress', (e) => {
        if (e.key && !/[0-9]/.test(e.key)) {
          e.preventDefault();
        }
      });

      wrapper.appendChild(input);

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.className = "success";
      saveBtn.setAttribute("data-tooltip", "Reset alert to 30 days");
      saveBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const newPrice = parseInt(input.value, 10);
        if (!newPrice || newPrice <= 0) {
          showStatus("Please enter a valid price.", "error");
          return;
        }
        try {
          await apiUpdateAlert(alert.id, currentEmail, newPrice);
          showStatus("Alert updated and reset to 30 days!", "success");
          await refreshAlerts();
        } catch (err) {
          showStatus(err.message || "Failed to update alert.", "error");
        }
      });

      const exitBtn = document.createElement("button");
      exitBtn.textContent = "Exit";
      exitBtn.className = "secondary";
      exitBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        renderAlertsDashboard();
      });

      formDiv.appendChild(label);
      formDiv.appendChild(wrapper);
      formDiv.appendChild(saveBtn);
      formDiv.appendChild(exitBtn);
      actionsDiv.appendChild(formDiv);

      input.focus();
      input.select();
    }

    function showConfirmation(actionsDiv, message, onYes) {
      actionsDiv.innerHTML = "";

      const confirmDiv = document.createElement("div");
      confirmDiv.className = "confirmation";

      const confirmText = document.createElement("span");
      confirmText.className = "confirmation-text";
      confirmText.textContent = message;

      const yesBtn = document.createElement("button");
      yesBtn.textContent = "Yes";
      yesBtn.className = "success";
      yesBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        onYes();
      });

      const noBtn = document.createElement("button");
      noBtn.textContent = "No";
      noBtn.className = "secondary";
      noBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        renderAlertsDashboard();
      });

      confirmDiv.appendChild(confirmText);
      confirmDiv.appendChild(yesBtn);
      confirmDiv.appendChild(noBtn);
      actionsDiv.appendChild(confirmDiv);
    }

    function renderAlertsDashboard() {
      const list = Array.isArray(currentAlerts) ? currentAlerts.slice() : [];
      alertsTbody.innerHTML = "";
      selectedAlertRow = null;

      if (!list.length) {
        alertsEmpty.classList.remove("hidden");
        alertsTable.classList.add("hidden");
        return;
      }

      alertsEmpty.classList.add("hidden");
      alertsTable.classList.remove("hidden");

      const order = { "Active": 0, "Expired": 1, "Cancelled": 2 };
      const sorted = list.sort((a, b) => {
        const sa = computeAlertStatus(a);
        const sb = computeAlertStatus(b);
        if (order[sa] !== order[sb]) return order[sa] - order[sb];
        return (Number(b.setAt || 0) - Number(a.setAt || 0));
      });

      sorted.forEach(a => {
        const status = computeAlertStatus(a);
        const daysLeft = computeDaysLeft(a);

        const tr = document.createElement("tr");
        tr.dataset.alertId = a.id;
        if (status !== "Active") tr.classList.add("inactive");

        // Date Set (stacked)
        const tdDate = document.createElement("td");
        const dateDiv = document.createElement("div");
        dateDiv.className = "stacked-cell";
        
        const datePrimary = document.createElement("div");
        datePrimary.className = "stacked-primary";
        datePrimary.textContent = formatDateShort(Number(a.setAt || 0));
        
        dateDiv.appendChild(datePrimary);
        tdDate.appendChild(dateDiv);
        tr.appendChild(tdDate);

        // Shoe
        const tdShoe = document.createElement("td");
        const shoeText = `${a.brand || ""} ${a.model || ""}`.trim();
        const label = shoeText;
        tdShoe.textContent = label.length > 40 ? label.substring(0, 40) + "..." : label;
        tdShoe.title = label;
        tr.appendChild(tdShoe);

        // Email
        const tdEmail = document.createElement("td");
        tdEmail.textContent = maskEmail(a.email);
        tdEmail.title = a.email || "";
        tr.appendChild(tdEmail);

        // Days Left (stacked)
        const tdDays = document.createElement("td");
        const daysDiv = document.createElement("div");
        daysDiv.className = "stacked-cell";
        
        const daysPrimary = document.createElement("div");
        daysPrimary.className = "stacked-primary";
        daysPrimary.textContent = status === "Active" ? String(daysLeft) : "—";
        
        daysDiv.appendChild(daysPrimary);
        tdDays.appendChild(daysDiv);
        tr.appendChild(tdDays);

        // Target
        const tdTarget = document.createElement("td");
        tdTarget.className = "target-cell";
        tdTarget.textContent = `$${Math.round(Number(a.targetPrice || 0))}`;
        tr.appendChild(tdTarget);

        // Status
        const tdStatus = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = pillClassFor(status);
        pill.textContent = status;
        tdStatus.appendChild(pill);
        tr.appendChild(tdStatus);

        tr.addEventListener("click", (e) => {
          e.stopPropagation();

          const existingActionRow = document.querySelector(".alert-actions-row");
          if (existingActionRow) existingActionRow.remove();

          const allRows = alertsTbody.querySelectorAll("tr");
          allRows.forEach(r => r.classList.remove("selected"));

          if (selectedAlertRow === tr) {
            selectedAlertRow = null;
            return;
          }

          tr.classList.add("selected");
          selectedAlertRow = tr;

          const actionRow = document.createElement("tr");
          actionRow.className = "alert-actions-row";
          const actionCell = document.createElement("td");
          actionCell.colSpan = 6;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "alert-actions";

          if (status === "Active") {
            // Edit price button
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit Price";
            editBtn.className = "secondary";
            editBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              showEditPriceForm(actionsDiv, a);
            });
            actionsDiv.appendChild(editBtn);

            // Refresh button
            const refreshBtn = document.createElement("button");
            refreshBtn.textContent = "Refresh";
            refreshBtn.className = "secondary";
            refreshBtn.setAttribute("data-tooltip", "Refresh alerts list");
            refreshBtn.addEventListener("click", async (ev) => {
              ev.stopPropagation();
              await refreshAlerts();
            });
            actionsDiv.appendChild(refreshBtn);

            // Cancel button (last)
            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel";
            cancelBtn.className = "danger";
            cancelBtn.setAttribute("data-tooltip", "Cancel alert and refresh");
            cancelBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              showConfirmation(actionsDiv, "Cancel this alert?", async () => {
                try {
                  if (!currentEmail) throw new Error("Missing email context.");
                  await apiCancelAlert(a.id, currentEmail);
                  showStatus("Alert cancelled.", "success");
                  await refreshAlerts();
                } catch (err) {
                  showStatus(err.message || "Failed to cancel alert.", "error");
                }
              });
            });
            actionsDiv.appendChild(cancelBtn);

          } else {
            // Remove button for inactive alerts
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "Remove";
            removeBtn.className = "danger";
            removeBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              showConfirmation(actionsDiv, "Remove this alert?", async () => {
                try {
                  if (!currentEmail) throw new Error("Missing email context.");
                  await apiRemoveAlert(a.id, currentEmail);
                  showStatus("Alert removed.", "success");
                  await refreshAlerts();
                } catch (err) {
                  showStatus(err.message || "Failed to remove alert.", "error");
                }
              });
            });
            actionsDiv.appendChild(removeBtn);
          }

          actionCell.appendChild(actionsDiv);
          actionRow.appendChild(actionCell);
          tr.parentNode.insertBefore(actionRow, tr.nextSibling);
        });

        alertsTbody.appendChild(tr);
      });
    }

    // Click outside to clear selection + close suggestions
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".alerts-table") && !e.target.closest(".alert-actions")) {
        const existingActionRow = document.querySelector(".alert-actions-row");
        if (existingActionRow) existingActionRow.remove();
        const allRows = alertsTbody.querySelectorAll("tr");
        allRows.forEach(r => r.classList.remove("selected"));
        selectedAlertRow = null;
      }

      const insideBrand = alertBrandSuggestions.contains(e.target) || alertBrand.contains(e.target);
      const insideModel = alertModelSuggestions.contains(e.target) || alertModel.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    // =======================
    // LOAD/REFRESH ALERTS
    // =======================
    async function refreshAlerts() {
      if (!currentEmail) {
        currentAlerts = [];
        renderAlertsDashboard();
        return;
      }
      try {
        const alerts = await apiListAlerts(currentEmail);
        currentAlerts = alerts;
        renderAlertsDashboard();
      } catch (err) {
        currentAlerts = [];
        renderAlertsDashboard();
        showStatus(err.message || "Failed to load alerts.", "error");
      }
    }

    function getEmailFromQueryString() {
      const params = new URLSearchParams(window.location.search);
      const email = params.get("email");
      return email ? email.trim().toLowerCase() : "";
    }

    function setEmailContext(email) {
      currentEmail = (email || "").trim().toLowerCase();
      if (currentEmail) {
        alertEmail.value = currentEmail;
      }
    }

    // =======================
    // CHECK FOR DUPLICATE ACTIVE ALERTS
    // =======================
    function hasActiveAlert(brand, model) {
      return currentAlerts.some(alert => {
        const status = computeAlertStatus(alert);
        return status === "Active" && 
               normalizeStr(alert.brand) === normalizeStr(brand) &&
               normalizeStr(alert.model) === normalizeStr(model);
      });
    }

    // =======================
    // CREATE ALERT
    // =======================
    createAlertForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = sanitizeInput(alertEmail.value).toLowerCase();
      const brand = sanitizeInput(alertBrand.value);
      const model = sanitizeInput(alertModel.value);
      const targetPrice = parseInt(String(alertPrice.value || ""), 10);

      // Validation
      if (!email || !email.includes("@")) {
        showStatus("Please enter a valid email address.", "error");
        return;
      }
      if (!brand) {
        showStatus("Please enter a shoe brand.", "error");
        return;
      }
      if (!model) {
        showStatus("Please enter a shoe model.", "error");
        return;
      }
      if (!targetPrice || targetPrice <= 0) {
        showStatus("Please enter a valid target price (whole dollars).", "error");
        return;
      }

      // Check for duplicate active alert
      if (hasActiveAlert(brand, model)) {
        showStatus(
          "You already have an active alert for this shoe. Please modify the existing alert or cancel it to create a new one.",
          "warning"
        );
        return;
      }

      setBusy(true);

      try {
        const result = await apiCreateAlert({ email, brand, model, targetPrice });

        if (email && getEmailFromQueryString() !== email) {
          const u = new URL(window.location.href);
          u.searchParams.set("email", email);
          window.history.replaceState({}, "", u.toString());
        }

        setEmailContext(email);

        showStatus(result.message || "Alert set! Check your email for confirmation.", "success");

        // Reset only brand/model/price; keep email and gender selection
        alertBrand.value = "";
        alertModel.value = "";
        alertPrice.value = "";
        closeSuggestions();

        await refreshAlerts();
      } catch (err) {
        showStatus(err.message || "Failed to set alert.", "error");
      } finally {
        setBusy(false);
      }
    });

    // =======================
    // INIT
    // =======================
    (function init() {
      const emailFromQS = getEmailFromQueryString();
      if (emailFromQS) setEmailContext(emailFromQS);

      alertEmail.addEventListener("change", async () => {
        const next = sanitizeInput(alertEmail.value).toLowerCase();
        setEmailContext(next);

        const u = new URL(window.location.href);
        if (currentEmail) u.searchParams.set("email", currentEmail);
        else u.searchParams.delete("email");
        window.history.replaceState({}, "", u.toString());

        await refreshAlerts();
      });

      refreshAlerts();
    })();
  </script>
</body>
</html>
