<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <title>Set Alert – Shoe Beagle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 2rem 1rem;
      background: #f4ede3ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #2d2d2d;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .page-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .brand-logo {
      display: block;
      width: 600px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .brand-logo:hover { opacity: 0.9; }

    /* Set Alert Section */
    .set-alert-section {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }

    .section-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0 0 1rem;
    }

    .form-group { margin-bottom: 1rem; }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #214478ff;
      margin-bottom: 0.4rem;
    }

    .input-wrapper { position: relative; width: 100%; }

    input[type="text"], input[type="email"] {
      width: 100%;
      height: 42px;
      padding: 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: #1a3661;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.1);
    }

    /* Clear "x" chip */
    .input-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #999;
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      padding: 0;
      line-height: 1;
      z-index: 20;
    }
    .input-clear:hover { background: #666; }

    /* Show clear button when there's text */
    .input-wrapper:has(input:not(:placeholder-shown)) .input-clear { display: flex; }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 30;
      padding: 0.25rem 0;
      display: none;
    }
    .suggestion-item {
      padding: 0.5rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .suggestion-item:hover, .suggestion-item.active { background: #e8f0ff; }

    /* Gender and Price Row */
    .gender-price-row {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .gender-group { flex: 1; min-width: 280px; }
    .price-group { flex: 0 0 auto; }

    .gender-selector {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .gender-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      border: 2px solid #214478ff;
      background: white;
      color: #214478ff;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      width: 95px;
      text-align: center;
      position: relative;
    }
    .gender-chip:hover { background: rgba(33, 68, 120, 0.1); }

    /* green check shown AFTER text when selected */
    .gender-chip .check {
      display: none;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
      font-weight: 900;
      font-size: 0.75rem;
      line-height: 1;
      align-items: center;
      justify-content: center;
      order: 2;
    }

    .gender-chip .text {
      order: 1;
    }

    .gender-chip.active {
      background: #214478ff;
      color: white;
    }
    .gender-chip.active .check {
      display: inline-flex;
      background: rgba(255,255,255,0.9);
      border-color: rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
    }

    .price-input-wrapper {
      position: relative;
      display: inline-block;
      width: 150px;
    }
    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
      z-index: 1;
    }
    .price-input-wrapper input {
      padding-left: 2rem;
      padding-right: 2.25rem;
      text-align: right;
    }
    .price-input-wrapper .input-clear { right: 0.5rem; }

    .price-input-wrapper:has(input:not(:placeholder-shown)) .input-clear { display: flex; }

    .submit-btn {
      width: 100%;
      height: 48px;
      border-radius: 0.5rem;
      border: none;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 0.5rem;
    }
    .submit-btn:hover { background: #1a3661; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }

    .privacy-note {
      margin-top: 0.35rem;
      font-size: 0.82rem;
      color: #49543a;
      font-style: italic;
    }

    /* Confirmation panel */
    .confirmation-panel {
      margin-top: 1.25rem;
      padding: 1.25rem;
      border-radius: 0.75rem;
      border: 2px solid rgba(46, 160, 67, 0.6);
      background: rgba(46, 160, 67, 0.08);
      display: none;
    }

    .confirmation-panel.show {
      display: block;
    }

    .confirmation-header {
      font-size: 1.25rem;
      font-weight: 800;
      color: #1f6a2a;
      margin: 0 0 0.75rem;
      text-align: center;
    }

    .confirmation-details {
      background: white;
      border-radius: 0.5rem;
      padding: 0.85rem;
      margin-bottom: 0.85rem;
      border: 1px solid rgba(46, 160, 67, 0.3);
    }

    .confirmation-details p {
      margin: 0.35rem 0;
      font-size: 0.95rem;
      color: #2d2d2d;
    }

    .confirmation-details p strong {
      color: #214478ff;
      font-weight: 700;
    }

    .confirmation-message {
      font-size: 0.9rem;
      line-height: 1.5;
      color: #1f6a2a;
      margin-bottom: 1rem;
      text-align: center;
    }

    .confirmation-actions {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      align-items: center;
    }

    .confirmation-btn {
      width: 100%;
      max-width: 280px;
      height: 46px;
      border-radius: 0.5rem;
      border: 2px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      display: block;
      text-align: center;
      line-height: 46px;
      text-decoration: none;
    }
    .confirmation-btn:hover { background: #1a3661; border-color: #1a3661; }

    .confirmation-btn.secondary {
      background: white;
      color: #214478ff;
    }
    .confirmation-btn.secondary:hover {
      background: rgba(33, 68, 120, 0.1);
    }

    .status-message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      text-align: center;
      display: none;
    }
    .status-message.success {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid rgba(46, 160, 67, 0.5);
      color: #1f6a2a;
    }
    .status-message.error {
      background: rgba(220, 53, 69, 0.15);
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: #8a1f2c;
    }
    .status-message.warning {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.5);
      color: #856404;
    }

    .home-btn {
      display: block;
      margin: 1.5rem auto 0.25rem;
      padding: 0.6rem 1.25rem;
      border-radius: 999px;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
      width: max-content;
      position: relative;
    }
    .home-btn:hover { background: #1a3661; }

    .footer {
      margin-top: 1.5rem;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.82rem;
      color: #444;
    }
    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      margin: 0 0.25rem;
      cursor: pointer;
    }
    .footer a:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .gender-price-row { flex-direction: column; gap: 1rem; }
      .gender-group, .price-group { width: 100%; min-width: 0; }
    }
  </style>
</head>

<body>
  <div class="page-container">
    <!-- Logo -->
    <a href="/">
      <img src="/images/logo.svg" alt="Shoe Beagle Logo" class="brand-logo">
    </a>

    <!-- Set Alert Form -->
    <div class="set-alert-section">
      <div class="section-title">Set Alert</div>

      <form id="setAlertForm">
        <div class="form-group">
          <label class="form-label" for="alertEmail">Email Address *</label>
          <input type="email" id="alertEmail" placeholder="your@email.com" required autocomplete="email" />
          <div class="privacy-note">Your email will never be shared or sold by Shoe Beagle.</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertBrand">Shoe Brand *</label>
          <div class="input-wrapper">
            <input type="text" id="alertBrand" placeholder="e.g., Nike, Hoka, Brooks" autocomplete="off" required />
            <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
            <div id="alertBrandSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="alertModel">Shoe Model *</label>
          <div class="input-wrapper">
            <input type="text" id="alertModel" placeholder="e.g., Pegasus, Clifton, Ghost" autocomplete="off" required />
            <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
            <div id="alertModelSuggestions" class="suggestions"></div>
          </div>
        </div>

        <div class="form-group">
          <div class="gender-price-row">
            <div class="gender-group">
              <label class="form-label">Gender</label>
              <div class="gender-selector">
                <div class="gender-chip active" data-gender="mens">
                  <span class="text">Men's</span><span class="check">✓</span>
                </div>
                <div class="gender-chip" data-gender="womens">
                  <span class="text">Women's</span><span class="check">✓</span>
                </div>
                <div class="gender-chip" data-gender="both">
                  <span class="text">Both</span><span class="check">✓</span>
                </div>
              </div>
            </div>

            <div class="price-group">
              <label class="form-label" for="alertPrice">Target Price *</label>
              <div class="price-input-wrapper">
                <input type="text" id="alertPrice" placeholder="0" inputmode="numeric" required autocomplete="off" />
                <button type="button" class="input-clear" aria-label="Clear price">&times;</button>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="setAlertBtn">Set Alert</button>
      </form>

      <!-- Confirmation Panel -->
      <div id="confirmationPanel" class="confirmation-panel">
        <div class="confirmation-header">✓ Alert Set Successfully!</div>
        
        <div class="confirmation-details" id="confirmationDetails"></div>

        <div class="confirmation-message">
          You'll receive a confirmation email shortly. When we find your shoes equal to, or lower than, your set price, we'll immediately send you a message. This alert expires in 30 days.
        </div>

        <div class="confirmation-actions">
          <button type="button" class="confirmation-btn" id="setAnotherBtn">Set Another Alert?</button>
          <a href="/pages/myalerts.html" class="confirmation-btn secondary" id="viewAlertsBtn">View My Alerts</a>
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>
    </div>

    <a href="/" class="home-btn">Return</a>

    <div class="footer">
      © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script>
    // =======================
    // BACKEND ENDPOINTS
    // =======================
    const API = { alerts: "/api/alerts" };

    // =======================
    // BRAND/MODEL SUGGESTIONS
    // =======================
    const brandModels = {
      "361°": ["Spire","Fury","Strata","Flame"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Allbirds": ["Tree Dasher","Tree Flyer","Trail Runner SWT","Tree Dashers Relay"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Atreyu": ["Base Model","Artist","Race Model","Daily Trainer"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Craft": ["CTM Ultra","CTM Ultra Carbon","Pro Endur","Nordlite"],
      "Decathlon Kiprun": ["KD900","KS900","Ultralight","Race Light"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "Inov-8": ["Roadfly","Trailfly","Roclite","Mudtalon","X-Talon"],
      "Joe Nimble": ["Addict","Trail Addict","Ultreya","WanderToes"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "La Sportiva": ["Jackal","Akasha","Karacal","Mutant","Kaptiva"],
      "Lems": ["Primal","Primal 2","Trailhead","Mesa"],
      "Merrell": ["Vapor Glove","Trail Glove","Agility Peak","Long Sky","Morphlite"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "Newton": ["Gravity","Distance","Motion","Fate","Kismet"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Norda": ["001","002","003"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Pearl Izumi": ["Flow","Floatride","Trail N2","Road N1"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Vibram FiveFingers": ["V-Run","V-Trail","V-Alpha","KSO EVO","V-Trek"],
      "Vivobarefoot": ["Primus Lite","Primus Trail","Geo Racer","Stealth","Addis"],
      "Xero Shoes": ["HFS","Prio","Speed Force","Mesa Trail","Zelen"]
    };

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));
    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    // =======================
    // DOM
    // =======================
    const setAlertForm = document.getElementById("setAlertForm");
    const alertEmail = document.getElementById("alertEmail");
    const alertBrand = document.getElementById("alertBrand");
    const alertModel = document.getElementById("alertModel");
    const alertPrice = document.getElementById("alertPrice");
    const setAlertBtn = document.getElementById("setAlertBtn");
    const statusMessage = document.getElementById("statusMessage");
    const confirmationPanel = document.getElementById("confirmationPanel");
    const confirmationDetails = document.getElementById("confirmationDetails");
    const setAnotherBtn = document.getElementById("setAnotherBtn");
    const viewAlertsBtn = document.getElementById("viewAlertsBtn");

    const alertBrandSuggestions = document.getElementById("alertBrandSuggestions");
    const alertModelSuggestions = document.getElementById("alertModelSuggestions");
    const footerYear = document.getElementById("footerYear");
    if (footerYear) footerYear.textContent = new Date().getFullYear();

    // =======================
    // STATE
    // =======================
    let selectedGender = "mens"; // Default to Men's
    let isProcessing = false;

    // =======================
    // PRICE INPUT - NUMBERS ONLY
    // =======================
    alertPrice.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    alertPrice.addEventListener('keypress', (e) => {
      if (e.key && !/[0-9]/.test(e.key)) e.preventDefault();
    });
    alertPrice.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numericOnly = pastedText.replace(/[^0-9]/g, '');
      const selection = window.getSelection();
      if (selection.rangeCount) {
        selection.deleteFromDocument();
        selection.getRangeAt(0).insertNode(document.createTextNode(numericOnly));
        selection.collapseToEnd();
      }
    });

    // =======================
    // GENDER CHIP HANDLING
    // =======================
    document.querySelectorAll(".gender-chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const gender = chip.dataset.gender;
        if (selectedGender === gender) return;

        document.querySelectorAll(".gender-chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        selectedGender = gender;
      });
    });

    // =======================
    // SET ANOTHER ALERT BUTTON
    // =======================
    setAnotherBtn.addEventListener("click", () => {
      confirmationPanel.classList.remove("show");
      alertBrand.value = "";
      alertModel.value = "";
      alertPrice.value = "";
      alertBrand.focus();
    });

    // Update View My Alerts link with email
    function updateViewAlertsLink(email) {
      if (email) {
        viewAlertsBtn.href = `/pages/myalerts.html?email=${encodeURIComponent(email)}`;
      }
    }

    // =======================
    // UTILS
    // =======================
    function normalizeStr(s) { return String(s || "").trim().toLowerCase(); }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function showStatus(message, type = "error") {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = "block";
      setTimeout(() => { statusMessage.style.display = "none"; }, 6500);
    }

    function showConfirmation(brand, model, gender, price) {
      const genderText = gender === "mens" ? "Men's" : gender === "womens" ? "Women's" : "Men's or Women's";
      
      confirmationDetails.innerHTML = `
        <p><strong>Shoe:</strong> ${brand} ${model}</p>
        <p><strong>Gender:</strong> ${genderText}</p>
        <p><strong>Target Price:</strong> $${price} or less</p>
      `;
      
      confirmationPanel.classList.add("show");
    }

    function setBusy(isBusy) {
      setAlertBtn.disabled = isBusy;
      setAlertBtn.textContent = isBusy ? "Setting..." : "Set Alert";
    }

    // =======================
    // API CALLS
    // =======================
    async function apiWithRetry(apiFn, maxRetries = 3, delayMs = 1000) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          return await apiFn();
        } catch (error) {
          if (attempt === maxRetries) throw error;
          console.warn(`API attempt ${attempt} failed, retrying...`, error);
          await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
        }
      }
    }

    async function apiCreateAlert(payload) {
      return apiWithRetry(async () => {
        const res = await fetch(API.alerts, {
          method: "POST",
          cache: "no-store",
          headers: { 
            "Content-Type": "application/json",
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || `HTTP ${res.status}: Failed to create alert`);
        }
        return await res.json();
      });
    }

    // =======================
    // SUGGESTIONS ENGINE
    // =======================
    function squashStr(s) { return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, ""); }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;
      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];
      const qLower = q.toLowerCase();

      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }
    function resolveBrand() { return resolveBrandKey(alertBrand.value.trim()); }

    const suggestionState = { openFor: null, items: [], activeIndex: -1 };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        alertBrandSuggestions.style.display = "none";
        alertBrandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        alertModelSuggestions.style.display = "none";
        alertModelSuggestions.innerHTML = "";
      }
      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";
      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });
        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));
      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");
        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;
      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }
      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }
      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }
      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    // Brand suggestions
    alertBrand.addEventListener("input", () => {
      const typed = alertBrand.value.trim();
      if (typed.length < 1) { closeSuggestions("brand"); return; }
      const matches = filterSuggestions(brands, typed, 12);
      renderSuggestions(alertBrandSuggestions, matches, "brand", (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", alertBrandSuggestions, (value) => {
        alertBrand.value = value;
        closeSuggestions("brand");
        setTimeout(() => alertModel.focus(), 0);
      });
    });

    alertBrand.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    // Model suggestions
    alertModel.addEventListener("input", () => {
      const text = alertModel.value.trim();
      if (text.length < 1) { closeSuggestions("model"); return; }
      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey])) ? brandModels[brandKey] : allModels;
      const matches = filterSuggestions(pool, text, 12);
      renderSuggestions(alertModelSuggestions, matches, "model", (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", alertModelSuggestions, (value) => {
        alertModel.value = value;
        closeSuggestions("model");
        setTimeout(() => alertPrice.focus(), 0);
      });
    });

    alertModel.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    // Clear buttons
    document.querySelectorAll(".input-clear").forEach((clearBtn) => {
      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const wrapper = clearBtn.closest('.input-wrapper, .price-input-wrapper');
        const input = wrapper ? wrapper.querySelector('input') : clearBtn.previousElementSibling;
        if (input && input.tagName === "INPUT") {
          input.value = "";
          input.focus();
          if (input.id === "alertBrand") closeSuggestions("brand");
          if (input.id === "alertModel") closeSuggestions("model");
        }
      });
    });

    // Click selects text
    alertBrand.addEventListener("click", () => alertBrand.select());
    alertModel.addEventListener("click", () => alertModel.select());

    // Click outside to close suggestions
    document.addEventListener("click", (e) => {
      const insideBrand = alertBrandSuggestions.contains(e.target) || alertBrand.contains(e.target);
      const insideModel = alertModelSuggestions.contains(e.target) || alertModel.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    // =======================
    // FORM SUBMISSION
    // =======================
    setAlertForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (isProcessing) return;

      const email = sanitizeInput(alertEmail.value).toLowerCase();
      const brand = sanitizeInput(alertBrand.value);
      const model = sanitizeInput(alertModel.value);
      const targetPrice = parseInt(String(alertPrice.value || ""), 10);
      const gender = selectedGender;

      // Validation
      if (!email || !email.includes("@")) { 
        showStatus("Please enter a valid email address.", "error"); 
        return; 
      }
      if (!brand) { 
        showStatus("Please enter a shoe brand.", "error"); 
        return; 
      }
      if (!model) { 
        showStatus("Please enter a shoe model.", "error"); 
        return; 
      }
      if (!targetPrice || targetPrice <= 0) { 
        showStatus("Please enter a valid target price (whole dollars).", "error"); 
        return; 
      }

      isProcessing = true;
      setBusy(true);

      try {
        const result = await apiCreateAlert({ email, brand, model, targetPrice, gender });

        // Update View My Alerts button with email
        updateViewAlertsLink(email);

        // Show confirmation
        showConfirmation(brand, model, gender, targetPrice);

        // Clear form fields (keep email and gender)
        alertBrand.value = "";
        alertModel.value = "";
        alertPrice.value = "";
        closeSuggestions();

      } catch (err) {
        console.error("Create alert failed:", err);
        showStatus(err.message || "Failed to set alert.", "error");
      } finally {
        isProcessing = false;
        setBusy(false);
      }
    });

    // =======================
    // INIT
    // =======================
    (function init() {
      // Pre-fill email from query string if present
      const params = new URLSearchParams(window.location.search);
      const emailFromQS = params.get("email");
      if (emailFromQS) {
        alertEmail.value = emailFromQS.trim().toLowerCase();
        updateViewAlertsLink(emailFromQS);
      }
    })();
  </script>
</body>
</html>
