<!DOCTYPE html>
<html lang="en">
<head>
 <link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="/favicon.png">  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <title>ShoeBeagle - Deal Statistics Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f4ede3;
      padding: 20px;
      color: #2d2d2d;
    }

    .container { max-width: 1400px; margin: 0 auto; }


/* Store filter + results */
.filter-row {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  margin: 10px 0 18px;
  flex-wrap: wrap;
}

.filter-row label {
  font-weight: 600;
  color: #214478ff;
}

.filter-row select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 2px solid #214478ff;
  background: #ffffff;
  font-size: 1rem;
  min-width: 260px;
}

.deals-panel {
  background: white;
  border: 2px solid #214478ff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
}

.deals-panel h2 {
  color: #214478ff;
  margin-bottom: 10px;
  font-size: 1.5rem;
}

.deals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 240px));
  gap: 16px;
  justify-content: center;
}

.deal-card {
  border: 2px solid #214478ff;
  border-radius: 12px;
  overflow: hidden;
  background: #d9e1ebff;
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
}

.deal-card img {
  width: 100%;
  height: 150px;
  object-fit: contain;
  background: white;
  border-bottom: 1px solid rgba(0,0,0,0.08);
}

.deal-card-body {
  padding: 10px 12px;
}

.deal-title {
  font-weight: 700;
  font-size: 0.95rem;
  margin-bottom: 6px;
  line-height: 1.2;
}

.deal-meta {
  font-size: 0.85rem;
  color: #49543a;
  margin-bottom: 8px;
}

.deal-price {
  font-weight: 800;
  color: #214478ff;
}

.deal-orig {
  margin-left: 8px;
  color: #777;
  text-decoration: line-through;
  font-weight: 600;
  font-size: 0.9rem;
}
    

    /* NEW: Logo at top with 6px buffer */
    .brand-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 6px;   /* 6px buffer */
      margin-bottom: 8px;
    }
    .brand-logo {
      width: 520px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }

    h1 {
      color: #214478ff;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
    }

    .last-updated {
      text-align: center;
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card h2 {
      color: #214478ff;
      font-size: 1.1rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #214478ff;
      padding-bottom: 8px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #214478ff;
      margin: 10px 0;
    }

    .stat-label { color: #666; font-size: 0.9rem; }

    .top-deal {
      background: rgba(33, 68, 120, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 4px solid #214478ff;
    }

    .top-deal-title {
      font-weight: bold;
      color: #214478ff;
      margin-bottom: 5px;
      font-size: 1.05rem;
    }

    .top-deal-store { color: #666; font-size: 0.85rem; margin-bottom: 8px; }
    .top-deal-price { font-size: 1.2rem; color: #2d2d2d; margin: 5px 0; }
    .top-deal-savings { color: #dc3545; font-weight: bold; font-size: 1.1rem; }

    .stores-table, .brand-table, .chart-container {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
    }

    .stores-table h2, .brand-table h2, .chart-container h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    table { width: 100%; border-collapse: collapse; }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: top;
    }

    th {
      background: #214478ff;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover { background: rgba(33, 68, 120, 0.05); }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: #666;
    }

    .error {
      background: #dc3545;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .refresh-btn {
      display: inline-flex;
      margin: 0;
      padding: 12px 30px;
      background: #214478ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
      text-align: center;
      justify-content: center;
      align-items: center;
    }
/* Primary action: Refresh */
.button-row .refresh-btn:first-child {
  background: #2e7d32; /* green */
}

.button-row .refresh-btn:first-child:hover {
  background: #256428;
}
    
.button-row .refresh-btn{
  min-width: 0;          /* stop forcing big widths */
  padding: 8px 14px;     /* smaller */
  font-size: 0.92rem;    /* slightly smaller text */
  margin: 0;             /* no extra spacing */
  border-radius: 8px;
  line-height: 1.1;
}


.button-row .refresh-btn {
  min-width: 140px; /* ensures same visual width */
  text-align: center;
}
    .refresh-btn:hover { background: #1a3661; }

    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .bar-chart { margin-top: 20px; }
    .bar-row { margin-bottom: 12px; }

    .bar-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .bar-bg {
      background: #e0e0e0;
      height: 30px;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      background: linear-gradient(90deg, #214478ff, #3a6bb0);
      height: 100%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.85rem;
    }

    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      font-family: monospace;
      font-size: 0.85rem;
    }

    .debug-info h3 {
      color: #214478ff;
      margin-bottom: 10px;
      font-family: system-ui;
    }

    /* small helper for subtle note */
    .note {
      font-size: 0.9rem;
      color: #666;
      margin-top: 6px;
    }

    /* Health Status Styles */
    .health-panel {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .health-panel h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .health-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .health-card.healthy {
      border-color: #28a745;
      background: #f0f9f4;
    }

    .health-card.warning {
      border-color: #ffc107;
      background: #fffbf0;
    }

    .health-card.critical {
      border-color: #dc3545;
      background: #fff5f5;
    }

    .health-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .health-store-name {
      font-weight: bold;
      font-size: 1.1rem;
      color: #214478ff;
    }

    .health-status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .health-status-badge.healthy {
      background: #28a745;
      color: white;
    }

    .health-status-badge.warning {
      background: #ffc107;
      color: #333;
    }

    .health-status-badge.critical {
      background: #dc3545;
      color: white;
    }

    .health-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .health-metric {
      font-size: 0.9rem;
    }

    .health-metric-label {
      color: #666;
      font-size: 0.85rem;
    }

    .health-metric-value {
      font-weight: bold;
      color: #214478ff;
    }

    .health-issues {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    .health-issue {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .health-issue-icon {
      font-size: 1.1rem;
    }

    .health-issue.critical {
      color: #dc3545;
    }

    .health-issue.warning {
      color: #856404;
    }

    .health-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .health-summary-item {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
    }

    .health-summary-item.healthy {
      background: #28a745;
      color: white;
    }

    .health-summary-item.warning {
      background: #ffc107;
      color: #333;
    }

    .health-summary-item.critical {
      background: #dc3545;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- NEW: Logo at top with 6px buffer -->
    <div class="brand-header">
      <img class="brand-logo" src="/images/logo.svg" alt="Shoe Beagle">
    </div>

    <!-- Removed the dog icon emoji -->
    <h1>Dashboard</h1>
    <div class="last-updated" id="lastUpdated">Loading...</div>

<div class="button-row">
  <button class="refresh-btn" onclick="loadStats()">Refresh Data</button>
  <button class="refresh-btn" onclick="openExternal('https://shoebeagle.com')">ShoeBeagle</button>
  <button class="refresh-btn" onclick="openExternal('https://github.com')">GitHub</button>
  <button class="refresh-btn" onclick="openExternal('https://vercel.com')">Vercel</button>
  <button class="refresh-btn" onclick="openExternal('https://sendgrid.com')">SendGrid</button>
  <button class="refresh-btn" onclick="openExternal('https://namecheap.com')">Namecheap</button>
</div>



    <div id="loading" class="loading">Loading deal statistics...</div>
    <div id="error" class="error" style="display: none;"></div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info" style="display: none;">
      <h3>Debug Information:</h3>
      <div id="debugContent"></div>
    </div>

    <!-- Health Status Panel -->
    <div id="healthPanel" class="health-panel" style="display: none;">
      <h2>üè• Scraper Health Status</h2>
      <div class="health-summary" id="healthSummary"></div>
      <div class="health-grid" id="healthGrid"></div>
    </div>

    <div id="content" style="display: none;">

      <!-- Key Metrics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>Total Deals</h2>
          <div class="stat-value" id="totalDeals">-</div>
          <div class="stat-label">Across all stores</div>
        </div>

        <div class="stat-card">
          <h2>Active Stores</h2>
          <div class="stat-value" id="totalStores">-</div>
          <div class="stat-label">Providing deals</div>
        </div>

        <div class="stat-card">
          <h2>Unique Brands</h2>
          <div class="stat-value" id="totalBrands">-</div>
          <div class="stat-label">Different brands available</div>
        </div>

        <div class="stat-card">
          <h2>Average Discount</h2>
          <div class="stat-value" id="avgDiscount">-</div>
          <div class="stat-label">Across all discounted deals</div>
        </div>
      </div>

      <!-- Top Deals -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>Highest % Discount</h2>
          <div id="topPercentDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Biggest $ Savings</h2>
          <div id="topDollarDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Lowest Price</h2>
          <div id="lowestPriceDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Best Value</h2>
          <div id="bestValueDeal" class="top-deal">Loading...</div>
          <div class="stat-label" style="margin-top: 10px; font-style: italic;">
            Based on discount % + $ savings
          </div>
        </div>
      </div>

<!-- Deals Browser by Store -->
<div class="deals-panel">
  <h2>üîé Browse Deals by Store</h2>

  <div class="filter-row">
    <label for="storeSelect">Store:</label>
    <select id="storeSelect">
      <option value="__all__">All Stores</option>
    </select>
    <div id="storeCount" style="color:#666;font-size:0.95rem;"></div>
  </div>

  <div class="deals-grid" id="storeDealsGrid"></div>
</div>

      
      <!-- NEW: Unknown Brands by Store -->
      <div class="stores-table">
        <h2>Unknown Brands by Store</h2>
        <div class="note">Counts deals where <code>brand === "Unknown"</code> (includes missing/blank brands).</div>
        <table>
          <thead>
            <tr>
              <th>Store Name</th>
              <th>Unknown Brand Deals</th>
              <th>Total Deals</th>
              <th>% Unknown</th>
            </tr>
          </thead>
          <tbody id="unknownBrandsTableBody"></tbody>
        </table>
      </div>

      <!-- Store Table -->
      <div class="stores-table">
        <h2>Store Breakdown</h2>
        <table>
          <thead>
            <tr>
              <th>Store Name</th>
              <th>Total Deals</th>
              <th>Avg Discount %</th>
              <th>Avg $ Savings</th>
              <th>Best Deal</th>
            </tr>
          </thead>
          <tbody id="storesTableBody"></tbody>
        </table>
      </div>

      <!-- Brand Table -->
      <div class="brand-table">
        <h2>Top Brands (by deal count)</h2>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Brand</th>
              <th>Total Deals</th>
              <th>Avg Discount %</th>
              <th>Price Range</th>
            </tr>
          </thead>
          <tbody id="brandsTableBody"></tbody>
        </table>
      </div>

      <!-- Price Distribution -->
      <div class="chart-container">
        <h2>Price Distribution</h2>
        <div class="bar-chart" id="priceChart"></div>
      </div>

    </div>
  </div>

  <script>
    async function loadStats() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('content');
      const debugInfo = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');

      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';
      debugInfo.style.display = 'none';

      try {
        const cacheBuster = Date.now();
        const response = await fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?t=${cacheBuster}`, {
          cache: "no-store"
        });
        const data = await response.json();

        if (!data.deals || !Array.isArray(data.deals)) {
          throw new Error('Invalid data format');
        }

        const deals = data.deals;
        ALL_DEALS = deals;
        buildStoreDropdown(deals);
        renderDealsForSelectedStore();
        
        // Debug summary
        const unknownBrands = deals.filter(d => (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()).length;
        const uniqueBrands = [...new Set(deals.map(d => (d.brand || 'Unknown').trim()))]
          .filter(b => b && b !== 'Unknown')
          .sort();

        const debugHTML = `
          <strong>Total deals in array:</strong> ${deals.length}<br>
          <strong>Unknown brands:</strong> ${unknownBrands} (${deals.length ? ((unknownBrands / deals.length) * 100).toFixed(1) : '0.0'}%)<br>
          <strong>Deals by store (from JSON):</strong> ${JSON.stringify(data.dealsByStore)}<br>
          <strong>Unique stores found:</strong> ${[...new Set(deals.map(d => d.store))].join(', ')}<br>
          <strong>Shoe brands found (${uniqueBrands.length}):</strong> ${uniqueBrands.join(', ')}
        `;
        debugContent.innerHTML = debugHTML;
        debugInfo.style.display = 'block';

        document.getElementById('lastUpdated').textContent =
          `Last updated: ${new Date(data.lastUpdated || Date.now()).toLocaleString()}`;

        const stats = calculateStats(deals);
        displayStats(stats);
        displayHealthStatus(deals, stats);

        loading.style.display = 'none';
        content.style.display = 'block';

      } catch (err) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `Error loading data: ${err.message}`;
        console.error('Error:', err);
      }
    }

    function calculateStats(deals) {
      const stats = {
        totalDeals: deals.length,
        stores: {},
        brands: {},
        discounts: [],
        prices: [],
        unknownByStore: {} // NEW
      };

      deals.forEach(deal => {
        const price = Number(deal.price) || 0;
        const original = Number(deal.originalPrice) || 0;

        const store = (deal.store || 'Unknown').trim() || 'Unknown';
        const brandRaw = (deal.brand || '').trim();
        const brand = brandRaw ? brandRaw : 'Unknown';

        // Calculate discount
        const dollarSavings = original > price ? original - price : 0;
        const percentOff = original > price ? ((original - price) / original) * 100 : 0;

        // Store stats
        if (!stats.stores[store]) {
          stats.stores[store] = {
            count: 0,
            totalDiscount: 0,
            totalSavings: 0,
            deals: []
          };
        }
        stats.stores[store].count++;
        stats.stores[store].totalDiscount += percentOff;
        stats.stores[store].totalSavings += dollarSavings;
        stats.stores[store].deals.push(deal);

        // NEW: Unknown brand by store tracking
        if (!stats.unknownByStore[store]) {
          stats.unknownByStore[store] = { unknownCount: 0, total: 0 };
        }
        stats.unknownByStore[store].total++;
        if (brand === 'Unknown') stats.unknownByStore[store].unknownCount++;

        // Brand stats
        if (!stats.brands[brand]) {
          stats.brands[brand] = {
            count: 0,
            totalDiscount: 0,
            minPrice: price || Infinity,
            maxPrice: price || 0
          };
        }
        stats.brands[brand].count++;
        stats.brands[brand].totalDiscount += percentOff;
        if (price > 0) {
          stats.brands[brand].minPrice = Math.min(stats.brands[brand].minPrice, price);
          stats.brands[brand].maxPrice = Math.max(stats.brands[brand].maxPrice, price);
        }

        if (percentOff > 0) {
          stats.discounts.push({
            deal: deal,
            percentOff: percentOff,
            dollarSavings: dollarSavings,
            price: price,
            valueScore: percentOff + (dollarSavings * 0.5)
          });
        }

        if (price > 0) stats.prices.push(price);
      });

      // Normalize Infinity minPrice if brand only had 0 prices
      Object.values(stats.brands).forEach(b => {
        if (!Number.isFinite(b.minPrice)) b.minPrice = 0;
      });

      return stats;
    }

    function displayStats(stats) {
      document.getElementById('totalDeals').textContent = stats.totalDeals.toLocaleString();
      document.getElementById('totalStores').textContent = Object.keys(stats.stores).length;
      document.getElementById('totalBrands').textContent = Object.keys(stats.brands).length;

      const avgDiscount = stats.discounts.length > 0
        ? stats.discounts.reduce((sum, d) => sum + d.percentOff, 0) / stats.discounts.length
        : 0;
      document.getElementById('avgDiscount').textContent = avgDiscount.toFixed(1) + '%';

      if (stats.discounts.length > 0) {
        const topPercent = [...stats.discounts].sort((a, b) => b.percentOff - a.percentOff)[0];
        document.getElementById('topPercentDeal').innerHTML = formatTopDeal(
          topPercent.deal,
          `${topPercent.percentOff.toFixed(0)}% OFF`,
          topPercent.dollarSavings
        );

        const topDollar = [...stats.discounts].sort((a, b) => b.dollarSavings - a.dollarSavings)[0];
        document.getElementById('topDollarDeal').innerHTML = formatTopDeal(
          topDollar.deal,
          `Save $${topDollar.dollarSavings.toFixed(2)}`,
          topDollar.dollarSavings
        );

        const lowestPrice = [...stats.discounts].sort((a, b) => a.price - b.price)[0];
        document.getElementById('lowestPriceDeal').innerHTML = formatTopDeal(
          lowestPrice.deal,
          `Only $${lowestPrice.price.toFixed(2)}`,
          lowestPrice.dollarSavings
        );

        const bestValue = [...stats.discounts].sort((a, b) => b.valueScore - a.valueScore)[0];
        document.getElementById('bestValueDeal').innerHTML = formatTopDeal(
          bestValue.deal,
          `${bestValue.percentOff.toFixed(0)}% off + $${bestValue.dollarSavings.toFixed(0)} saved`,
          bestValue.dollarSavings
        );
      }

      displayUnknownBrandsByStore(stats.unknownByStore); // NEW
      displayStoreTable(stats.stores);
      displayBrandTable(stats.brands);
      displayPriceDistribution(stats.prices);
    }

    function formatTopDeal(deal, highlight) {
      const price = Number(deal.price) || 0;
      const original = Number(deal.originalPrice) || 0;
      return `
        <div class="top-deal-title">${(deal.brand || 'Unknown')} ${(deal.model || '')}</div>
        <div class="top-deal-store">Store: ${deal.store || 'Unknown'}</div>
        <div class="top-deal-price">
          $${price.toFixed(2)}
          ${original > price ? `<span style="color: #999; text-decoration: line-through; font-size: 0.9rem;">$${original.toFixed(2)}</span>` : ''}
        </div>
        <div class="top-deal-savings">${highlight}</div>
      `;
    }

    function displayHealthStatus(deals, stats) {
      const healthPanel = document.getElementById('healthPanel');
      const healthGrid = document.getElementById('healthGrid');
      const healthSummary = document.getElementById('healthSummary');

      if (!healthPanel || !healthGrid || !healthSummary) return;

      const storeHealth = {};
      let healthyCount = 0;
      let warningCount = 0;
      let criticalCount = 0;

      // Analyze each store
      Object.entries(stats.stores).forEach(([storeName, storeData]) => {
        const health = {
          store: storeName,
          dealCount: storeData.count,
          issues: [],
          status: 'healthy'
        };

        // Get deals for this store
        const storeDeals = deals.filter(d => (d.store || 'Unknown').trim() === storeName);

        // Check for zero results - CRITICAL
        if (storeData.count === 0) {
          health.issues.push({ type: 'critical', message: 'üö® ZERO RESULTS - Scraper may be broken' });
          health.status = 'critical';
        }

        // Check for unknown brands
        const unknownBrands = storeDeals.filter(d => 
          (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()
        ).length;
        const unknownPercent = storeData.count > 0 ? (unknownBrands / storeData.count) * 100 : 0;
        
        if (unknownPercent > 50) {
          health.issues.push({ type: 'critical', message: `üö® ${unknownPercent.toFixed(0)}% Unknown Brands` });
          health.status = 'critical';
        } else if (unknownPercent > 20) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${unknownPercent.toFixed(0)}% Unknown Brands` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        // Check for missing images
        const missingImages = storeDeals.filter(d => !d.image || d.image.includes('placehold.co')).length;
        const missingImagesPercent = storeData.count > 0 ? (missingImages / storeData.count) * 100 : 0;
        
        if (missingImagesPercent > 30) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingImagesPercent.toFixed(0)}% Missing Images` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        // Check for missing URLs
        const missingUrls = storeDeals.filter(d => !d.url || d.url === '#').length;
        const missingUrlsPercent = storeData.count > 0 ? (missingUrls / storeData.count) * 100 : 0;
        
        if (missingUrlsPercent > 10) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingUrlsPercent.toFixed(0)}% Missing URLs` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        // Check for missing prices
        const missingPrices = storeDeals.filter(d => !d.price || Number(d.price) === 0).length;
        if (missingPrices > 0) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingPrices} Missing Prices` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        // Check for missing models
        const missingModels = storeDeals.filter(d => !d.model || d.model.trim() === '').length;
        const missingModelsPercent = storeData.count > 0 ? (missingModels / storeData.count) * 100 : 0;
        
        if (missingModelsPercent > 30) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingModelsPercent.toFixed(0)}% Missing Models` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        // Low deal count warning (potential issue)
        if (storeData.count > 0 && storeData.count < 5) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è Low Deal Count (${storeData.count})` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        storeHealth[storeName] = health;

        // Count statuses
        if (health.status === 'healthy') healthyCount++;
        else if (health.status === 'warning') warningCount++;
        else if (health.status === 'critical') criticalCount++;
      });

      // Display summary
      healthSummary.innerHTML = `
        <div class="health-summary-item healthy">${healthyCount} Healthy</div>
        <div class="health-summary-item warning">${warningCount} Warnings</div>
        <div class="health-summary-item critical">${criticalCount} Critical</div>
      `;

      // Sort stores: critical first, then warning, then healthy
      const sortedStores = Object.values(storeHealth).sort((a, b) => {
        const statusOrder = { critical: 0, warning: 1, healthy: 2 };
        return statusOrder[a.status] - statusOrder[b.status];
      });

      // Display health cards
      healthGrid.innerHTML = sortedStores.map(health => `
        <div class="health-card ${health.status}">
          <div class="health-header">
            <div class="health-store-name">${health.store}</div>
            <div class="health-status-badge ${health.status}">
              ${health.status === 'healthy' ? '‚úì Healthy' : health.status === 'warning' ? '‚ö† Warning' : '‚úó Critical'}
            </div>
          </div>
          
          <div class="health-metrics">
            <div class="health-metric">
              <div class="health-metric-label">Total Deals</div>
              <div class="health-metric-value">${health.dealCount.toLocaleString()}</div>
            </div>
          </div>

          ${health.issues.length > 0 ? `
            <div class="health-issues">
              ${health.issues.map(issue => `
                <div class="health-issue ${issue.type}">
                  <span>${issue.message}</span>
                </div>
              `).join('')}
            </div>
          ` : '<div style="margin-top: 10px; color: #28a745; font-weight: bold;">‚úì All checks passed</div>'}
        </div>
      `).join('');

      healthPanel.style.display = 'block';
    }

    // NEW: Unknown brands table
    function displayUnknownBrandsByStore(unknownByStore) {
      const tbody = document.getElementById('unknownBrandsTableBody');

      const rows = Object.entries(unknownByStore)
        .map(([store, obj]) => {
          const pct = obj.total > 0 ? (obj.unknownCount / obj.total) * 100 : 0;
          return { store, unknown: obj.unknownCount, total: obj.total, pct };
        })
        .filter(r => r.unknown > 0)
        .sort((a, b) => b.unknown - a.unknown);

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">No Unknown brands found üéâ</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td><strong>${r.store}</strong></td>
          <td>${r.unknown.toLocaleString()}</td>
          <td>${r.total.toLocaleString()}</td>
          <td>${r.pct.toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    function displayStoreTable(stores) {
      const sorted = Object.entries(stores).sort((a, b) => b[1].count - a[1].count);

      if (sorted.length === 0) {
        document.getElementById('storesTableBody').innerHTML =
          '<tr><td colspan="5">No store data available</td></tr>';
        return;
      }

      const html = sorted.map(([name, data]) => {
        const avgDiscount = data.count > 0 ? (data.totalDiscount / data.count).toFixed(1) : '0';
        const avgSavings = data.count > 0 ? (data.totalSavings / data.count).toFixed(2) : '0';

        const bestDeal = data.deals
          .map(d => {
            const o = Number(d.originalPrice) || 0;
            const p = Number(d.price) || 0;
            const pct = (o > p && o > 0) ? ((o - p) / o) * 100 : 0;
            return { deal: d, pct };
          })
          .sort((a, b) => b.pct - a.pct)[0];

        return `
          <tr>
            <td><strong>${name}</strong></td>
            <td>${data.count}</td>
            <td>${avgDiscount}%</td>
            <td>$${avgSavings}</td>
            <td>${bestDeal ? `${bestDeal.deal.brand || 'Unknown'} ${(bestDeal.deal.model || '')} (${bestDeal.pct.toFixed(0)}% off)` : '-'}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('storesTableBody').innerHTML = html;
    }

    function displayBrandTable(brands) {
      const sorted = Object.entries(brands)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 20);

      const html = sorted.map(([name, data], index) => {
        const avgDiscount = data.count > 0 ? (data.totalDiscount / data.count).toFixed(1) : '0';
        const priceRange = `$${(data.minPrice || 0).toFixed(0)} - $${(data.maxPrice || 0).toFixed(0)}`;

        return `
          <tr>
            <td>${index + 1}</td>
            <td><strong>${name}</strong></td>
            <td>${data.count}</td>
            <td>${avgDiscount}%</td>
            <td>${priceRange}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('brandsTableBody').innerHTML = html;
    }

    function displayPriceDistribution(prices) {
      const buckets = {
        '$0-50': 0,
        '$50-75': 0,
        '$75-100': 0,
        '$100-125': 0,
        '$125-150': 0,
        '$150+': 0
      };

      prices.forEach(price => {
        if (price < 50) buckets['$0-50']++;
        else if (price < 75) buckets['$50-75']++;
        else if (price < 100) buckets['$75-100']++;
        else if (price < 125) buckets['$100-125']++;
        else if (price < 150) buckets['$125-150']++;
        else buckets['$150+']++;
      });

      const maxCount = Math.max(...Object.values(buckets));

      const html = Object.entries(buckets).map(([range, count]) => `
        <div class="bar-row">
          <div class="bar-label">
            <span><strong>${range}</strong></span>
            <span>${count} deals</span>
          </div>
          <div class="bar-bg">
            <div class="bar-fill" style="width: ${maxCount > 0 ? (count / maxCount) * 100 : 0}%">
              ${count}
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('priceChart').innerHTML = html;
    }

    let ALL_DEALS = [];

    function formatMoney(n) {
      const x = Number(n);
      return Number.isFinite(x) ? `$${x.toFixed(2)}` : "‚Äî";
    }

    function buildStoreDropdown(deals) {
      const select = document.getElementById("storeSelect");
      if (!select) return;

      const stores = [...new Set(deals.map(d => d.store).filter(Boolean))].sort();

      // Reset options (keep All Stores)
      select.innerHTML =
      `<option value="__none__" selected>Select a store‚Ä¶</option>` +
      `<option value="__all__">All Stores</option>`;

      stores.forEach(store => {
        const opt = document.createElement("option");
        opt.value = store;
        opt.textContent = store;
        select.appendChild(opt);
      });

      select.addEventListener("change", () => renderDealsForSelectedStore());
    }

    function renderDealsForSelectedStore() {
      const select = document.getElementById("storeSelect");
      const grid = document.getElementById("storeDealsGrid");
      const countEl = document.getElementById("storeCount");
      if (!select || !grid) return;

      const chosen = select.value;

      let filtered = [];

      if (chosen === "__none__") {
        filtered = [];
      } else if (chosen === "__all__") {
        filtered = ALL_DEALS;
      } else {
        filtered = ALL_DEALS.filter(d => (d.store || "") === chosen);
      }

      // Show count
      if (countEl) {
        countEl.textContent = `${filtered.length.toLocaleString()} deal${filtered.length === 1 ? "" : "s"}`;
      }

      // Render (cap for performance)
      const SHOW_MAX = 200; // adjust if you want more
      const toShow = filtered.slice(0, SHOW_MAX);

      grid.innerHTML = "";

      if (!toShow.length) {
        grid.innerHTML = `<div style="text-align:center;color:#666;padding:18px;">No deals found for this store.</div>`;
        return;
      }

      toShow.forEach((d) => {
        const a = document.createElement("a");
        a.className = "deal-card";
        a.href = d.url || "#";
        a.target = "_blank";
        a.rel = "noopener noreferrer";

        const img = document.createElement("img");
        img.src = d.image || "https://placehold.co/600x400?text=Running+Shoe";
        img.alt = (d.brand && d.model) ? `${d.brand} ${d.model}` : (d.title || "Deal");
        a.appendChild(img);

        const body = document.createElement("div");
        body.className = "deal-card-body";

        const title = document.createElement("div");
        title.className = "deal-title";
        title.textContent =
          (d.brand || d.model)
            ? [d.brand, d.model].filter(Boolean).join(" ")
            : (d.title || "Deal");
        body.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "deal-meta";
        meta.textContent = d.store || "";
        body.appendChild(meta);

        const priceRow = document.createElement("div");
        priceRow.className = "deal-price";
        priceRow.textContent = formatMoney(d.price);

        const orig = Number(d.originalPrice);
        const price = Number(d.price);
        if (Number.isFinite(orig) && Number.isFinite(price) && orig > price) {
          const origSpan = document.createElement("span");
          origSpan.className = "deal-orig";
          origSpan.textContent = formatMoney(orig);
          priceRow.appendChild(origSpan);
        }

        body.appendChild(priceRow);
        a.appendChild(body);

        grid.appendChild(a);
      });
    }

    function openExternal(url) {
  window.open(url, "_blank", "noopener,noreferrer");
}
    loadStats();
  </script>
</body>
</html>
