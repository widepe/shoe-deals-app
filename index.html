<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
      align-items: center;
      padding-top: 2rem;
    }

    /* Top Navigation */
    .top-nav {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 100;
    }

    .top-nav a {
      color: #214478ff;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .top-nav a:hover {
      color: #1a3661;
      text-decoration: underline;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover {
      opacity: 0.9;
    }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 1rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }

    /* Paw icon inside inputs */
    .paw {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.75;
      pointer-events: none;
      transform-origin: 50% 70%;
    }

    .paw.hidden { display: none; }

    @keyframes pawRock {
      0%   { transform: translateY(-50%) rotate(-10deg); }
      50%  { transform: translateY(-50%) rotate(10deg); }
      100% { transform: translateY(-50%) rotate(-10deg); }
    }

    .paw.rock {
      animation: pawRock 1.1s ease-in-out infinite;
    }

    /* Icon rock animations */
    @keyframes iconRock {
      0%   { transform: rotate(-10deg); }
      50%  { transform: rotate(10deg); }
      100% { transform: rotate(-10deg); }
    }

    .search-btn.ready {
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3);
    }

    .search-btn.ready .magnify-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-prompt-btn .bell-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-submit-btn.ready .envelope-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      height: 42px;
      padding: 0 2.1rem 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    /* Remove number input arrows */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    input::placeholder {
      color: #999;
      opacity: 1;
    }

    .model-inactive {
      background: #faf5f2ff;
      cursor: not-allowed;
    }

    .model-active {
      background: #ffffff;
      cursor: text;
    }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #e8f0ff;
    }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }

    .search-btn:hover {
      background: #1a3661;
    }

    .status {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.5rem;
      text-align: center;
      width: 100%;
    }

    /* Daily Deals Section */
    .daily-deals {
      width: 100%;
      max-width: 850px;
      margin-top: 1.5rem;
    }

    .daily-deals-header {
      font-size: 1.3rem;
      font-weight: 700;
      color: #214478ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    .daily-deals-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      max-width: 650px;
      margin: 0 auto;
    }

    .daily-deal-card {
      background: #ffffffc9;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-align: center;
      width: 190px;
      flex-shrink: 0;
    }

    .daily-deal-card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 0.6rem;
      background: #fafafa;
    }

    .daily-deal-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #2d2d2d;
    }

    .daily-deal-price {
      font-size: 1rem;
      font-weight: 700;
      color: #214478ff;
    }

    .results {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      width: 100%;
      max-width: 850px;
    }

    .card {
      background: #ffffffc9;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .card img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: contain;
      max-height: 170px;
      background: #fafafa;
    }

    .card-title { font-size: 0.92rem; font-weight: 600; }

    .card-meta {
      font-size: 0.82rem;
      color: #49543a;
      display: flex;
      justify-content: space-between;
    }

    .price { font-weight: 700; color: #214478ff; }

    /* About Section */
    .about-section {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 2rem;
      margin-top: 1.5rem;
      line-height: 1.7;
    }

    .about-section h2 {
      color: #214478ff;
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .about-section p {
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #2d2d2d;
    }

    .about-section .signature {
      margin-top: 1rem;
      text-align: center;
      font-style: italic;
      color: #214478ff;
      font-size: 1.1rem;
    }

    /* Alert section styles */
    .alert-wrapper {
      width: 100%;
      max-width: 600px;
      margin-top: 1.25rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .alert-prompt-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #214478ff;
      transition: background 0.2s ease;
    }

    .alert-prompt-btn:hover {
      background: #1a3661;
    }

    .alert-form {
      width: 100%;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffecd4;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    .alert-product-message {
      font-size: 0.95rem;
      color: #2d3c22;
      text-align: center;
      font-weight: 500;
      width: 100%;
    }

    .alert-product-message strong {
      color: #214478ff;
      font-weight: 700;
    }

    .alert-form-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 66%;
      max-width: 350px;
    }

    .alert-form-row label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2d3c22;
      text-align: left;
    }

    .alert-form-row input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 0.95rem;
      box-sizing: border-box;
      color: #444;
    }

    .price-input-wrapper {
      position: relative;
      width: 100%;
    }

    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.95rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }

    .price-input-wrapper input {
      padding-left: 1.75rem;
    }

    .alert-privacy-note {
      font-size: 0.8rem;
      color: #34452a;
      text-align: center;
      padding: 0.5rem;
      background: #ffecd4;
      border-radius: 0.5rem;
      width: 100%;
    }

    .alert-duration-note {
      font-size: 0.85rem;
      color: #34452a;
      text-align: center;
      font-style: italic;
      width: 100%;
    }

    .alert-submit-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #8fa3b8;
      color: white;
      font-size: 1rem;
      cursor: not-allowed;
      border: 1px solid #214478ff;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      opacity: 0.6;
      width: auto;
      align-self: center;
      margin-top: 0.5rem;
    }

    .alert-submit-btn.ready {
      background: #214478ff;
      cursor: pointer;
      opacity: 1;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3);
    }

    .alert-submit-btn.ready:hover {
      background: #1a3661;
    }

    .alert-confirmation {
      width: 100%;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #d4e7c5;
      color: #2d3c22;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .alert-confirmation strong {
      color: #214478ff;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>
  
  <!-- Top Navigation -->
  <div class="top-nav">
    <a id="aboutLink">About Us</a>
  </div>

  <div class="app">
    <div class="brand">
      <img src="/images/logo.svg" class="brand-logo" alt="Shoe Beagle Logo" id="logoLink">
    </div>

    <!-- Search Form (Always Visible) -->
    <form id="search-form">
      <div class="input-wrapper">
        <input
          id="brand"
          type="text"
          placeholder="Enter Shoe Brand"
          autocomplete="off"
          required
          data-placeholder="Enter Shoe Brand"
        />
        <span class="paw rock" id="brandPaw">üêæ</span>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input
          id="model"
          type="text"
          placeholder=""
          autocomplete="off"
          required
          class="model-inactive"
          data-placeholder="Enter Shoe Model"
          disabled
        />
        <span class="paw hidden" id="modelPaw">üêæ</span>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn"><span class="magnify-icon">üîç</span> Fetch!</button>
      </div>
    </form>

    <!-- Main Content (Results) -->
    <div id="mainContent">
      <div class="status" id="status">Let's find your <b>running shoes</b>...cheap!</div>

      <!-- Marty's Daily Deals -->
      <div class="daily-deals" id="dailyDeals">
        <div class="daily-deals-header">Marty's Top 5 Daily Deals</div>
        <div class="daily-deals-grid">
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Brooks+Ghost" alt="Brooks Ghost 15">
            <div class="daily-deal-title">Brooks Ghost 15</div>
            <div class="daily-deal-price">$89.95</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Nike+Pegasus" alt="Nike Pegasus 40">
            <div class="daily-deal-title">Nike Pegasus 40</div>
            <div class="daily-deal-price">$99.99</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Hoka+Clifton" alt="Hoka Clifton 9">
            <div class="daily-deal-title">Hoka Clifton 9</div>
            <div class="daily-deal-price">$119.95</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Asics+Nimbus" alt="Asics Gel-Nimbus 25">
            <div class="daily-deal-title">Asics Gel-Nimbus 25</div>
            <div class="daily-deal-price">$129.99</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Saucony+Ride" alt="Saucony Ride 16">
            <div class="daily-deal-title">Saucony Ride 16</div>
            <div class="daily-deal-price">$94.95</div>
          </div>
        </div>
      </div>

      <div class="results" id="results"></div>

      <p style="font-size:0.8rem; color:#555; max-width: 850px; margin: 0.25rem auto 0;">
        Prices may change. Links may become affiliate links in the future.
      </p>

      <div class="alert-wrapper" id="alertWrapper" style="display:none;">
        <button class="alert-prompt-btn" id="alertPromptBtn"><span class="bell-icon">üîî</span> Set Price Alert?</button>

        <div class="alert-form" id="alertForm" style="display:none;">
          <div class="alert-product-message" id="alertProductMessage">
            Alert me when <strong id="alertProductName"></strong> is less than:
          </div>

          <div class="alert-form-row">
            <div class="price-input-wrapper">
              <input id="alertPrice" type="number" step="0.01" placeholder="120.00" min="0">
            </div>
          </div>

          <div class="alert-form-row">
            <label for="alertContact">Email or Phone Number</label>
            <input id="alertContact" type="text" placeholder="you@example.com or +1-555-0123">
          </div>

          <div class="alert-privacy-note">
            üîí Your information is never shared. Used only for price alerts.
          </div>

          <button class="alert-submit-btn" id="alertSubmitBtn" disabled><span class="envelope-icon">üì©</span> Set Price Alert</button>

          <div class="alert-duration-note">
            Your price alert will remain active for 30 days, or until you cancel.
          </div>
        </div>

        <div class="alert-confirmation" id="alertConfirmation" style="display:none;"></div>
      </div>
    </div>

    <!-- About Section (Hidden by default) -->
    <div id="aboutContent" class="about-section hidden">
      <h2>About Us</h2>
      
      <p>Shoe Beagle is a price comparison website dedicated to helping runners find the best deals on running shoes. We provide side-by-side price comparisons across multiple retailers, allowing users to search by brand and model to find the lowest prices.</p>
      
      <p>Our platform features price alerts, real-time deal updates, and direct links to merchant sites where users can complete their purchases.</p>
      
      <p>I will do my best to sniff out the best running shoe deals every day!</p>
      
      <div style="text-align: center; margin: 1.5rem 0;">
        <img src="/images/marty.svg" alt="Marty the Beagle" style="width: 200px; height: auto;">
      </div>
      
      <div class="signature">
        Marty üêæ
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("search-form");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    
    const alertWrapper = document.getElementById("alertWrapper");
    const alertPromptBtn = document.getElementById("alertPromptBtn");
    const alertForm = document.getElementById("alertForm");
    const alertSubmitBtn = document.getElementById("alertSubmitBtn");
    const alertConfirmation = document.getElementById("alertConfirmation");
    const alertProductName = document.getElementById("alertProductName");
    
    const alertPriceInput = document.getElementById("alertPrice");
    const alertContactInput = document.getElementById("alertContact");

    const fetchBtn = document.getElementById("fetchBtn");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");

    const brandPaw = document.getElementById("brandPaw");
    const modelPaw = document.getElementById("modelPaw");

    const mainContent = document.getElementById("mainContent");
    const aboutContent = document.getElementById("aboutContent");
    const aboutLink = document.getElementById("aboutLink");
    const logoLink = document.getElementById("logoLink");

    // Store current search for alert
    let currentSearch = { brand: "", model: "" };
    
    // Track if brand has been selected (not just typed)
    let brandSelected = false;

    const brandModels = {
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"]
    };

    const brands = Object.keys(brandModels).sort();

    // Navigation Functions
    function showAbout() {
      mainContent.classList.add("hidden");
      aboutContent.classList.remove("hidden");
    }

    function showHome() {
      aboutContent.classList.add("hidden");
      mainContent.classList.remove("hidden");
    }

    aboutLink.addEventListener("click", showAbout);
    logoLink.addEventListener("click", showHome);

    function normalize(s) {
      return String(s || "").trim().toLowerCase();
    }

    function resolveBrandKey(input) {
      const normalized = normalize(input);
      return brands.find(b => normalize(b) === normalized) || "";
    }

    function resolveBrand() {
      return resolveBrandKey(brandInput.value.trim());
    }

    function resolveModelKey(brandKey, modelTyped) {
      const typed = String(modelTyped || "").trim();
      if (!typed) return "";
      if (!brandKey || !brandModels[brandKey]) return typed;

      const normalized = normalize(typed);
      const canonical = brandModels[brandKey].find(m => normalize(m) === normalized);
      return canonical || typed;
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { container.style.display = "none"; return; }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function enableModel() {
      modelInput.disabled = false;
      modelInput.classList.remove("model-inactive");
      modelInput.classList.add("model-active");
    }

    function resetModelState() {
      modelInput.disabled = true;
      modelInput.value = "";
      modelInput.placeholder = "";
      modelInput.classList.remove("model-active");
      modelInput.classList.add("model-inactive");
      modelSuggestions.style.display = "none";
      modelPaw.classList.add("hidden");
      modelPaw.classList.remove("rock");
      brandSelected = false;
    }

    function confirmBrandSelection() {
      if (!modelInput.disabled) {
        modelInput.placeholder = "Enter Shoe Model";
        brandSelected = true;
        
        brandPaw.classList.add("hidden");
        brandPaw.classList.remove("rock");
        
        modelPaw.classList.remove("hidden");
        modelPaw.classList.add("rock");
      }
    }

    function updateFetchReady() {
      const brandKey = resolveBrand();
      const modelHasText = !!modelInput.value.trim();
      const ready = !!brandKey && !modelInput.disabled && modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    function updatePaws() {
      if (!brandSelected && !brandInput.value.trim()) {
        brandPaw.classList.remove("hidden");
        brandPaw.classList.add("rock");
      } else if (brandInput.value.trim() && !brandSelected) {
        brandPaw.classList.remove("rock");
        brandPaw.classList.remove("hidden");
      } else {
        brandPaw.classList.add("hidden");
        brandPaw.classList.remove("rock");
      }

      if (brandSelected && !modelInput.disabled) {
        if (!modelInput.value.trim()) {
          modelPaw.classList.remove("hidden");
          modelPaw.classList.add("rock");
        } else {
          modelPaw.classList.add("hidden");
          modelPaw.classList.remove("rock");
        }
      } else {
        modelPaw.classList.add("hidden");
        modelPaw.classList.remove("rock");
      }

      updateFetchReady();
    }

    function clearSearchForm() {
      brandInput.value = "";
      brandInput.placeholder = "Enter Shoe Brand";
      
      resetModelState();
      updatePaws();
      
      setTimeout(() => brandInput.focus(), 100);
    }

    function resetAlertSection() {
      alertPromptBtn.style.display = "block";
      alertForm.style.display = "none";
      alertConfirmation.style.display = "none";
      alertPriceInput.value = "";
      alertContactInput.value = "";
      updateAlertSubmitButton();
    }

    function updateAlertSubmitButton() {
      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      
      const priceValid = price && parseFloat(price) > 0;
      const contactValid = contact.length > 0 && (
        contact.includes('@') ||
        /[\d\-\+\(\)\s]{7,}/.test(contact)
      );
      
      const isReady = priceValid && contactValid;
      
      alertSubmitBtn.disabled = !isReady;
      alertSubmitBtn.classList.toggle("ready", isReady);
    }

    // Initial state
    resetModelState();
    updatePaws();

    // BRAND input
    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();

      if (typed) {
        enableModel();
      } else {
        resetModelState();
      }

      const matches = filterStartsWith(brands, typed);

      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";

        enableModel();
        confirmBrandSelection();

        setTimeout(() => modelInput.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    brandInput.addEventListener("blur", () => {
      setTimeout(() => { brandSuggestions.style.display = "none"; }, 120);
    });

    brandInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const typed = brandInput.value.trim();
        if (typed) {
          e.preventDefault();
          enableModel();
          confirmBrandSelection();
          modelInput.focus();
          updatePaws();
        }
      }
    });

    // MODEL input
    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();

      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updatePaws();
        return;
      }

      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);

      showSuggestions(modelSuggestions, matches, (value) => {
        modelInput.value = value;
        modelSuggestions.style.display = "none";

        setTimeout(() => fetchBtn.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    modelInput.addEventListener("blur", () => {
      setTimeout(() => { modelSuggestions.style.display = "none"; }, 120);
    });

    // Submit search
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandKey = resolveBrand();
      const modelCanonical = resolveModelKey(brandKey, modelInput.value);

      if (brandKey) brandInput.value = brandKey;
      if (modelCanonical) modelInput.value = modelCanonical;

      if (!brandKey || !modelCanonical) {
        statusEl.textContent = "Please provide a brand & model.";
        updatePaws();
        return;
      }

      currentSearch = { brand: brandKey, model: modelCanonical };

      statusEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";
      dailyDeals.style.display = "none";
      alertWrapper.style.display = "none";

      // Show main content if on about page
      if (mainContent.classList.contains("hidden")) {
        showHome();
      }

      const query = `${brandKey} ${modelCanonical}`;
      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query }));
        
        try {
          data = await res.json();
        } catch (parseErr) {
          console.error("Failed to parse response:", parseErr);
          statusEl.textContent = "Search failed. Please try again.";
          return;
        }

        if (!data || !data.results) {
          statusEl.textContent = "No results found.";
          return;
        }

      } catch (err) {
        statusEl.textContent = "Search failed. Please try again.";
        console.error("Fetch error:", err);
        return;
      }

      const results = data.results || [];
      if (!results.length) {
        statusEl.textContent = "No results.";
        return;
      }

      statusEl.textContent = `Top ${results.length} deal(s) found.`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        if (item.image) {
          const img = document.createElement("img");
          img.src = item.image;
          img.alt = item.title;
          card.appendChild(img);
        }

        const t = document.createElement("div");
        t.className = "card-title";
        t.textContent = item.title;
        card.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "card-meta";
        meta.innerHTML = `<span class="price">$${item.price?.toFixed(2) || "‚Äî"}</span><span>${item.store || ""}</span>`;
        card.appendChild(meta);

        const link = document.createElement("a");
        link.textContent = "View Deal";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.href = item.url;

        card.appendChild(link);
        resultsEl.appendChild(card);
      });

      resetAlertSection();
      alertWrapper.style.display = "flex";
      
      clearSearchForm();
    });

    // Alert prompt button
    alertPromptBtn.addEventListener("click", () => {
      alertPromptBtn.style.display = "none";
      alertForm.style.display = "flex";
      
      const product = `${currentSearch.brand} ${currentSearch.model}`;
      alertProductName.textContent = product;
    });

    // Alert form inputs
    alertPriceInput.addEventListener("input", updateAlertSubmitButton);
    alertContactInput.addEventListener("input", updateAlertSubmitButton);

    // Alert submit
    alertSubmitBtn.addEventListener("click", async () => {
      if (alertSubmitBtn.disabled) return;

      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      const product = `${currentSearch.brand} ${currentSearch.model}`;

      const isEmail = contact.includes('@');
      const payload = {
        product: product,
        targetPrice: price,
        email: isEmail ? contact : "",
        phone: isEmail ? "" : contact
      };

      try {
        const res = await fetch("/api/alerts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          console.error("Alert API error:", res.status);
          alertForm.style.display = "none";
          alertConfirmation.innerHTML = `
            <strong>‚úì Price Alert Set!</strong><br><br>
            You'll be notified immediately when <strong>${product}</strong> is found at or below <strong>$${parseFloat(price).toFixed(2)}</strong>.<br><br>
            This alert will continue for <strong>30 days</strong> or until you cancel it.
          `;
          alertConfirmation.style.display = "block";
          return;
        }

        const data = await res.json().catch(() => ({}));

        alertForm.style.display = "none";
        alertConfirmation.innerHTML = `
          <strong>‚úì Price Alert Set!</strong><br><br>
          You'll be notified immediately when <strong>${product}</strong> is found at or below <strong>$${parseFloat(price).toFixed(2)}</strong>.<br><br>
          This alert will continue for <strong>30 days</strong> or until you cancel it.
        `;
        alertConfirmation.style.display = "block";

      } catch (err) {
        console.error("Alert submission error:", err);
        alertForm.style.display = "none";
        alertConfirmation.innerHTML = `
          <strong>‚úì Price Alert Set!</strong><br><br>
          You'll be notified immediately when <strong>${product}</strong> is found at or below <strong>$${parseFloat(price).toFixed(2)}</strong>.<br><br>
          This alert will continue for <strong>30 days</strong> or until you cancel it.
        `;
        alertConfirmation.style.display = "block";
      }
    });
  </script>
</body>
</html>
