<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* Make cards able to host an overlay */
    .card {
      position: relative;
    }

    /* Wrap the image so we can pin the badge to it */
    .card-image-wrapper {
      position: relative;
      width: 100%;
    }

    /* Discount badge in corner of image */
    .discount-badge {
      position: absolute;
      top: 0.35rem;
      left: 0.35rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      background: rgba(220, 53, 69, 0.9);
      color: #ffffff;
    }

    /* Mobile portrait: shrink badge to match smaller image */
    @media (max-width: 480px) {
      .discount-badge {
        top: 0.2rem;
        left: 0.2rem;
        padding: 0.1rem 0.3rem;
        font-size: 0.55rem;
      }
    }

    /* Original price with line-through */
    .card-original-price {
      margin-left: 0.35rem;
      font-size: 0.8rem;
      color: #777;
      text-decoration: line-through;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      padding: 6px 1rem;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      align-items: center;
      padding-top: 0;
    }

    /* Top Navigation */
    .top-nav {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-nav a {
      color: #214478ff;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease;
      user-select: none;
    }

    .top-nav a:hover {
      color: #1a3661;
      text-decoration: underline;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover { opacity: 0.9; }
    
    input[type="text"],
    input[type="search"] {
      width: 100%;
      height: 42px;
      padding: 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 0.75rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }


    input::placeholder { color: #999; opacity: 1; }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .suggestion-item:hover { background: #e8f0ff; }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }
    .search-btn:hover { background: #1a3661; }

    /* Status message (replaces both tagline and status) */
    .status-message {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.05rem;
      text-align: center;
      width: 100%;
      min-height: 1.1rem;
    }

    /* Daily Deals Section */
    .daily-deals {
      width: 100%;
      max-width: 900px;
      margin-top: 1.0rem;
    }

    .daily-deals-header {
      font-size: 1.8rem;
      font-weight: 700;
      color: #214478ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    .shoe-grid {
      margin-top: 1.0rem;
      display: grid;
      gap: 1.25rem;
      width: 100%;
      justify-content: center;
      max-width: 900px;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr));
    }

    /* Mobile portrait: single column layout */
    @media (max-width: 480px) {
      .shoe-grid {
        grid-template-columns: 1fr;
        max-width: 100%;
      }
    }

    /* Desktop/Tablet: vertical layout with image on top */
    .card {
      background: #d9e1ebff;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      text-align: left;
      box-sizing: border-box;
    }

    .card-link {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-decoration: none;
      color: inherit;
      height: 100%;
    }

    .card-image-wrapper {
      width: 100%;
      overflow: hidden;
    }

    .card img {
      width: 100%;
      height: 150px;
      border-radius: 0.6rem;
      object-fit: contain;
      background: white;
      border: 1px solid #214478ff;
      box-sizing: border-box;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      flex: 1;
    }

    .card-title {
      font-size: 0.92rem;
      font-weight: 600;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: calc(1.2em * 3);
    }

    .card-store {
      font-size: 0.82rem;
      color: #49543a;
    }

    .card-price-row {
      display: flex;
      align-items: baseline;
      gap: 0.3rem;
      font-size: 0.95rem;
    }

    .price {
      font-weight: 700;
      color: #214478ff;
    }

    /* Mobile portrait: horizontal layout with image on left */
    @media (max-width: 480px) {
      .card-link {
        flex-direction: row;
        gap: 0.75rem;
        align-items: center;
      }

      .card-image-wrapper {
        flex-shrink: 0;
        width: 100px;
        height: 80px;
        overflow: hidden;
      }

      .card img {
        height: 80px;
        object-fit: cover;
      }

      .card-content {
        justify-content: center;
        min-width: 0;
      }

      .card-title {
        -webkit-line-clamp: 2;
        min-height: auto;
      }
    }

    /* Mobile landscape: exactly 3 columns */
    @media (min-width: 481px) and (max-width: 900px) and (orientation: landscape) {
      .shoe-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      max-width: 900px;
      margin: 0.15rem auto 0;
      text-align: center;
    }

    /* Footer */
    .footer {
      margin-top: 2rem;
      padding: 0.75rem 1rem;
      background: rgba(244, 237, 227, 0.97);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 0.82rem;
      color: #444;
      text-align: center;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      margin: 0 0.25rem;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>
<!--
  <div class="top-nav">
    <a href="/pages/myalerts.html">My Alerts</a>
  </div>
-->
  <div class="app">
    <div class="brand">
      <img src="/images/logo.svg" class="brand-logo" alt="Shoe Beagle Logo" id="logoLink">
    </div>

    <form id="search-form" method="POST">
      <div class="input-wrapper">
        <input id="brand" type="text" placeholder="Enter Shoe Brand" autocomplete="off"/>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input id="model" type="text" placeholder="Enter Shoe Model" autocomplete="off"/>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn"><span class="magnify-icon">üîç</span> Fetch!</button>
      </div>
    </form>

    <div class="status-message" id="statusMessage">Let's find your running shoes!</div>

    <div id="mainContent">
      <div class="daily-deals" id="dailyDeals">
        <div class="daily-deals-header">Marty's Daily Deals</div>
        <div class="shoe-grid" id="dailyDealsGrid"></div>
      </div>

      <div class="shoe-grid" id="results"></div>
      <p class="disclaimer">Shoe Beagle does not sell products directly and is not responsible for changes in price, availability, or shipping terms on retailer sites.</p>
    </div>

    <!-- Footer -->
    <div class="footer">
      <a href="/pages/about.html">About</a> |
      <a href="/pages/contact.html">Contact</a> |
      <a href="/pages/privacy.html">Privacy</a> |
      <a href="/pages/terms.html">Terms</a> |
      <br>
      ¬© <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script>
    const form = document.getElementById("search-form");
    // Prevent Enter from submitting the form ‚Äî only Fetch button should submit
    form.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
    
    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    const dailyDealsGrid = document.getElementById("dailyDealsGrid");
    const fetchBtn = document.getElementById("fetchBtn");
    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");
    const logoLink = document.getElementById("logoLink");
    const footerYear = document.getElementById("footerYear");

    let currentSearch = { brand: "", model: "" };

    // Set footer year
    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }

    logoLink.addEventListener("click", () => {
      location.reload();
    });

    function normalizeStr(s) { 
      return String(s || "").trim().toLowerCase(); 
    }

    // Shared discount helper used by cards
    function getDiscountInfo(item) {
      const price = Number(item.price);
      const original = item.originalPrice != null ? Number(item.originalPrice) : NaN;

      // Best case: we have both prices
      if (
        Number.isFinite(price) &&
        Number.isFinite(original) &&
        original > 0 &&
        price < original
      ) {
        const pct = Math.round(((original - price) / original) * 100);
        return {
          hasDiscount: true,
          current: price.toFixed(2),
          original: original.toFixed(2),
          percent: pct
        };
      }

      // Fallback: parse string discount like "-23%"
      if (Number.isFinite(price) && typeof item.discount === "string" && item.discount.includes("%")) {
        const m = item.discount.match(/(-?\d+(?:\.\d+)?)%/);
        if (m) {
          const pct = Math.abs(Number(m[1]));
          if (Number.isFinite(pct) && pct > 0 && pct < 100) {
            const origGuess = price / (1 - pct / 100);
            if (Number.isFinite(origGuess) && origGuess > price) {
              return {
                hasDiscount: true,
                current: price.toFixed(2),
                original: origGuess.toFixed(2),
                percent: Math.round(pct)
              };
            }
          }
        }
      }

      return { hasDiscount: false };
    }

    const brandModels = {
      "361¬∞": ["Spire","Fury","Strata","Flame"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Allbirds": ["Tree Dasher","Tree Flyer","Trail Runner SWT","Tree Dashers Relay"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Atreyu": ["Base Model","Artist","Race Model","Daily Trainer"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Craft": ["CTM Ultra","CTM Ultra Carbon","Pro Endur","Nordlite"],
      "Decathlon Kiprun": ["KD900","KS900","Ultralight","Race Light"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "Inov-8": ["Roadfly","Trailfly","Roclite","Mudtalon","X-Talon"],
      "Joe Nimble": ["Addict","Trail Addict","Ultreya","WanderToes"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "La Sportiva": ["Jackal","Akasha","Karacal","Mutant","Kaptiva"],
      "Lems": ["Primal","Primal 2","Trailhead","Mesa"],
      "Merrell": ["Vapor Glove","Trail Glove","Agility Peak","Long Sky","Morphlite"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "Newton": ["Gravity","Distance","Motion","Fate","Kismet"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Norda": ["001","002","003"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Pearl Izumi": ["Flow","Floatride","Trail N2","Road N1"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Vibram FiveFingers": ["V-Run","V-Trail","V-Alpha","KSO EVO","V-Trek"],
      "Vivobarefoot": ["Primus Lite","Primus Trail","Geo Racer","Stealth","Addis"],
      "Xero Shoes": ["HFS","Prio","Speed Force","Mesa Trail","Zelen"]
    };

    const brands = Object.keys(brandModels).sort();

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }

    function resolveBrand() { 
      return resolveBrandKey(brandInput.value.trim()); 
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { 
        container.style.display = "none"; 
        return; 
      }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function updateFetchReady() {
      const brandHasText = !!brandInput.value.trim();
      const modelHasText = !!modelInput.value.trim();
      const ready = brandHasText || modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    // Initialize
    dailyDeals.style.display = "block";

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      const matches = filterStartsWith(brands, typed);

      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    brandInput.addEventListener("blur", () => setTimeout(() => { 
      brandSuggestions.style.display = "none"; 
    }, 120));

    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();
      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updateFetchReady();
        return;
      }
      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);
      showSuggestions(modelSuggestions, matches, (value) => {
        modelInput.value = value;
        modelSuggestions.style.display = "none";
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });
      updateFetchReady();
    });

    brandInput.addEventListener("click", () => {
      brandInput.select();
    });

    modelInput.addEventListener("click", () => {
      modelInput.select();
    });

    modelInput.addEventListener("blur", () => setTimeout(() => { 
      modelSuggestions.style.display = "none"; 
    }, 120));

    // Helper: create unified deal card (used for search + daily deals)
    function createDealCard(item) {
      const discount = getDiscountInfo(item);

      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.className = "card-link";
      link.href = item.url || "#";
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      // --- image + corner badge ---
      const imgWrapper = document.createElement("div");
      imgWrapper.className = "card-image-wrapper";

      if (item.image) {
        const img = document.createElement("img");
        img.src = item.image;
        img.alt = item.title || "Running shoe deal";
        imgWrapper.appendChild(img);
      } else {
        const img = document.createElement("img");
        img.src = "https://placehold.co/600x400?text=Running+Shoe";
        img.alt = "Running shoe";
        imgWrapper.appendChild(img);
      }

      if (discount.hasDiscount) {
        const badge = document.createElement("div");
        badge.className = "discount-badge";
        badge.textContent = `${discount.percent}% OFF`;
        imgWrapper.appendChild(badge);
      }

      link.appendChild(imgWrapper);

      // --- content wrapper for text ---
      const contentDiv = document.createElement("div");
      contentDiv.className = "card-content";

      // --- brand + model (instead of title) ---
      const titleDiv = document.createElement("div");
      titleDiv.className = "card-title";

      const brand = (item.brand || "").trim();
      const model = (item.model || "").trim();

      titleDiv.textContent =
        (brand || model)
          ? [brand, model].filter(Boolean).join(" ")
          : (item.title || "Deal");

      contentDiv.appendChild(titleDiv);

      if (item.store) {
        const storeDiv = document.createElement("div");
        storeDiv.className = "card-store";
        storeDiv.textContent = item.store;
        contentDiv.appendChild(storeDiv);
      }

      // --- price row (current + struck-through original) ---
      const priceRow = document.createElement("div");
      priceRow.className = "card-price-row";

      const priceSpan = document.createElement("span");
      priceSpan.className = "price";

      const currentPrice = Number(item.price);
      if (Number.isFinite(currentPrice)) {
        priceSpan.textContent = `$${currentPrice.toFixed(2)}`;
      } else {
        priceSpan.textContent = item.price ? String(item.price) : "‚Äî";
      }
      priceRow.appendChild(priceSpan);

      if (discount.hasDiscount) {
        const origSpan = document.createElement("span");
        origSpan.className = "card-original-price";
        origSpan.textContent = `$${discount.original}`;
        priceRow.appendChild(origSpan);
      }

      contentDiv.appendChild(priceRow);
      link.appendChild(contentDiv);

      card.appendChild(link);
      return card;
    }

    // Load daily deals from API and render as cards
    // Load daily deals from the FINAL merged blob (deals.json) and render as cards
async function loadDailyDeals() {
  try {
    const blobUrl = "https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?cb=" + Date.now();

    const res = await fetch(blobUrl);
    const data = await res.json();

    // deals.json shape: { totalDeals, deals: [...] }
    const deals = (data && Array.isArray(data.deals)) ? data.deals : [];

    dailyDealsGrid.innerHTML = "";

    if (!deals.length) {
      dailyDeals.style.display = "none";
      return;
    }

    // Optional: show only first N cards on homepage
    const daily = deals.slice(0, 24);

    daily.forEach(item => {
      dailyDealsGrid.appendChild(createDealCard(item));
    });

    dailyDeals.style.display = "block";
    
    // Update status message when daily deals are shown
    dailyDealCount();
  } catch (err) {
    console.error("Error loading daily deals:", err);
    dailyDeals.style.display = "none";
  }
}


    // Load total deals count and update status message when showing daily deals
async function dailyDealCount() {
  try {
    const blobUrl = "https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?cb=" + Date.now();

    const res = await fetch(blobUrl);
    const data = await res.json();
    
    const totalDeals = data.totalDeals || 0;
    
    if (statusMessageEl && totalDeals > 0) {
      statusMessageEl.textContent = `There are ${totalDeals.toLocaleString()} deals today, let's find yours!`;
    }
  } catch (err) {
    console.error("Error loading total deals count:", err);
    // Keep default message if fetch fails
  }
}
    // Initial daily deals load
    loadDailyDeals();
    
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandTyped = brandInput.value.trim();
      const modelTyped = modelInput.value.trim();

      // Require at least one of brand/model
      if (!brandTyped && !modelTyped) {
        statusMessageEl.textContent = "Please enter a brand or a model.";
        return;
      }

      currentSearch = { brand: brandTyped, model: modelTyped };

      // Used for display + query; avoids extra spaces if one is blank
      const displayQuery = [brandTyped, modelTyped].filter(Boolean).join(" ");

      statusMessageEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";
      dailyDeals.style.display = "none";

      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query: displayQuery }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        return;
      }

      const results = (data && data.results) ? data.results : [];
      
      if (!results.length) {
        statusMessageEl.textContent = `No results found for ${displayQuery}.`;
        dailyDeals.style.display = "block";
        return;
      }

      statusMessageEl.textContent =
        `Top ${results.length} deal${results.length === 1 ? '' : 's'} found for ${displayQuery}.`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = createDealCard(item);
        resultsEl.appendChild(card);
      });
    });
  </script>
</body>
</html>
