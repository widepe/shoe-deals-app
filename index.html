<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      text-align: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
      align-items: center;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
    }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 1rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }

    /* Paw icon inside inputs */
    .paw {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.75;
      pointer-events: none;
      transform-origin: 50% 70%;
    }

    .paw.hidden { display: none; }

    @keyframes pawRock {
      0%   { transform: translateY(-50%) rotate(-10deg); }
      50%  { transform: translateY(-50%) rotate(10deg); }
      100% { transform: translateY(-50%) rotate(-10deg); }
    }

    .paw.rock {
      animation: pawRock 1.1s ease-in-out infinite;
    }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      height: 42px;
      padding: 0 2.1rem 0 0.75rem; /* extra right padding for paw */
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    input::placeholder {
      color: #444;
      opacity: 1;
    }

    .input-glow {
      border-color: #7fa26a;
      box-shadow: 0 0 0 2px #7fa26a55;
    }

    .model-inactive {
      background: #faf5f2ff;
      cursor: not-allowed;
    }

    .model-active {
      background: #ffffff;
      cursor: text;
    }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #8fa178;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #eef4e7;
    }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #7fa26a;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #7fa26a;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }

    .search-btn:hover {
      background: #6b8f57;
    }

    /* Pulse when ready */
    @keyframes readyPulse {
      0%   { transform: scale(1); box-shadow: 0 0 0 0 rgba(127,162,106,0.45); }
      70%  { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(127,162,106,0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(127,162,106,0); }
    }
    .search-btn.ready {
      animation: readyPulse 1.2s ease-in-out infinite;
    }

    .status {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.5rem;
    }

    .results {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      width: 100%;
      max-width: 850px;
    }

    .card {
      background: #ffffffc9;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .card img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: contain;
      max-height: 170px;
      background: #fafafa;
    }

    .card-title { font-size: 0.92rem; font-weight: 600; }

    .card-meta {
      font-size: 0.82rem;
      color: #49543a;
      display: flex;
      justify-content: space-between;
    }

    .price { font-weight: 700; color: #3b5b26; }

    .alert-section {
      width: 100%;
      max-width: 600px;
      margin-top: 1.25rem;
      padding: 1rem;
      border-radius: 0.75rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
      background: #eef4e7c0;
    }

    .alert-section input {
      width: 100%;
      padding: 0.45rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #fafdf4;
      font-size: 0.95rem;
      box-sizing: border-box;
      color: #444;
    }

    .alert-section input::placeholder { color: #666; }

    .fine-print {
      grid-column: 1 / -1;
      font-size: 0.8rem;
      color: #34452a;
      margin-top: 0.2rem;
    }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>  <div class="app">
    <div class="brand">
      <img src="http://storage.proboards.com/7187966/images/mFtuiMfMGFAdfeEpHsnX.png" class="brand-logo" alt="Logo">
    </div>

    <form id="search-form">
      <div class="input-wrapper">
        <input
          id="brand"
          type="text"
          placeholder="Type in Shoe Brand"
          autocomplete="off"
          required
          class="input-glow"
          data-placeholder="Type in Shoe Brand"
        />
        <span class="paw rock" id="brandPaw">üêæ</span>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input
          id="model"
          type="text"
          placeholder=""
          autocomplete="off"
          required
          class="model-inactive"
          data-placeholder="Type in Shoe Model"
          disabled
        />
        <!-- Model paw hidden until model is active -->
        <span class="paw rock hidden" id="modelPaw">üêæ</span>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn">üîç Fetch!</button>
      </div>
    </form>

    <div class="status" id="status">Let's find your <b>running shoes</b>...cheap!</div>
    <div class="results" id="results"></div>

    <p style="font-size:0.8rem; color:#555; max-width: 850px; margin: 0.25rem auto 0;">
      Prices may change. Links may become affiliate links in the future.
    </p>

    <div id="alertWrapper" style="display:none;">
      <div class="alert-section">
        <div>
          <label for="alertPrice">Alert me when ‚â§</label>
          <input id="alertPrice" type="number" step="0.01" placeholder="120.00">
        </div>
        <div>
          <label for="alertEmail">Email (optional)</label>
          <input id="alertEmail" type="email" placeholder="you@example.com">
        </div>
        <div>
          <label for="alertPhone">Phone (optional)</label>
          <input id="alertPhone" type="tel" placeholder="+1...">
        </div>
        <div class="fine-print">üí° Alerts continue until canceled.</div>
        <button id="saveAlertBtn">üì© Save Alert</button>
      </div>
      <div class="status" id="alertStatus"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("search-form");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const alertWrapper = document.getElementById("alertWrapper");
    const saveAlertBtn = document.getElementById("saveAlertBtn");
    const alertStatusEl = document.getElementById("alertStatus");

    const fetchBtn = document.getElementById("fetchBtn");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");

    const brandPaw = document.getElementById("brandPaw");
    const modelPaw = document.getElementById("modelPaw");

    const brandModels = {
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"]
    };

    const brands = Object.keys(brandModels).sort();

    function normalize(s) {
      return String(s || "").trim().toLowerCase();
    }

    function resolveBrandKey(input) {
      const normalized = normalize(input);
      return brands.find(b => normalize(b) === normalized) || "";
    }

    function resolveBrand() {
      return resolveBrandKey(brandInput.value.trim());
    }

    function resolveModelKey(brandKey, modelTyped) {
      const typed = String(modelTyped || "").trim();
      if (!typed) return "";
      if (!brandKey || !brandModels[brandKey]) return typed;

      const normalized = normalize(typed);
      const canonical = brandModels[brandKey].find(m => normalize(m) === normalized);
      return canonical || typed;
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { container.style.display = "none"; return; }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function enableModel() {
      modelInput.disabled = false;
      modelInput.classList.remove("model-inactive");
      modelInput.classList.add("model-active", "input-glow");
      modelPaw.classList.remove("hidden"); // show paw only when active
    }

    function resetModelState() {
      modelInput.disabled = true;
      modelInput.value = "";
      modelInput.placeholder = "";
      modelInput.classList.remove("model-active", "input-glow");
      modelInput.classList.add("model-inactive");
      modelSuggestions.style.display = "none";
      modelPaw.classList.add("hidden"); // hide paw until active
    }

    function confirmBrandSelection() {
      if (!modelInput.disabled) modelInput.placeholder = "Type in Shoe Model";
    }

    function updateFetchReady() {
      const brandKey = resolveBrand();
      const modelHasText = !!modelInput.value.trim();
      const ready = !!brandKey && !modelInput.disabled && modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    function updatePaws() {
      // Brand paw rocks until brand has content
      if (brandInput.value.trim()) brandPaw.classList.remove("rock");
      else brandPaw.classList.add("rock");

      // Model paw only exists when model enabled; then rocks until model has content
      if (modelInput.disabled) {
        modelPaw.classList.add("hidden");
      } else {
        modelPaw.classList.remove("hidden");
        if (modelInput.value.trim()) modelPaw.classList.remove("rock");
        else modelPaw.classList.add("rock");
      }

      updateFetchReady();
    }

    // Initial state
    resetModelState();
    updatePaws();

    // BRAND input
    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();

      if (typed) enableModel();
      else resetModelState();

      const matches = filterStartsWith(brands, typed);

      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";

        enableModel();
        confirmBrandSelection();

        // jump to model
        setTimeout(() => modelInput.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    brandInput.addEventListener("focus", () => {
      brandInput.dataset.placeholder = brandInput.placeholder;
      brandInput.placeholder = "";
    });

    brandInput.addEventListener("blur", () => {
      setTimeout(() => { brandSuggestions.style.display = "none"; }, 120);
      if (!brandInput.value.trim()) {
        brandInput.placeholder = brandInput.dataset.placeholder || "Type in Shoe Brand";
      }
    });

    // BRAND Enter: move to model, do not submit
    brandInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const typed = brandInput.value.trim();
        if (typed) {
          e.preventDefault();
          enableModel();
          confirmBrandSelection();
          modelInput.focus();
          updatePaws();
        }
      }
    });

    // MODEL input suggestions (case-insensitive)
    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();

      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updatePaws();
        return;
      }

      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);

      showSuggestions(modelSuggestions, matches, (value) => {
        // Set model canonical casing
        modelInput.value = value;
        modelSuggestions.style.display = "none";

        // Move cursor to Fetch button (not auto-submit)
        setTimeout(() => fetchBtn.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    modelInput.addEventListener("focus", () => {
      if (!modelInput.disabled) {
        modelInput.dataset.placeholder = modelInput.placeholder;
        modelInput.placeholder = "";
      }
    });

    modelInput.addEventListener("blur", () => {
      setTimeout(() => { modelSuggestions.style.display = "none"; }, 120);
      if (!modelInput.value.trim() && !modelInput.disabled) {
        modelInput.placeholder = modelInput.dataset.placeholder || "Type in Shoe Model";
      }
    });

    // Submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandKey = resolveBrand();
      const modelCanonical = resolveModelKey(brandKey, modelInput.value);

      if (brandKey) brandInput.value = brandKey;
      if (modelCanonical) modelInput.value = modelCanonical;

      if (!brandKey || !modelCanonical) {
        statusEl.textContent = "Please provide a brand & model.";
        updatePaws();
        return;
      }

      statusEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";

      const query = `${brandKey} ${modelCanonical}`;
      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query }));
        
        // Always try to parse JSON, even if status isn't 200
        try {
          data = await res.json();
        } catch (parseErr) {
          console.error("Failed to parse response:", parseErr);
          statusEl.textContent = "Search failed. Please try again.";
          return;
        }

        // Check if we got results
        if (!data || !data.results) {
          statusEl.textContent = "No results found.";
          return;
        }

      } catch (err) {
        statusEl.textContent = "Search failed. Please try again.";
        console.error("Fetch error:", err);
        return;
      }

      const results = data.results || [];
      if (!results.length) {
        statusEl.textContent = "No results.";
        return;
      }

      statusEl.textContent = `Top ${results.length} deal(s) found.`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        if (item.image) {
          const img = document.createElement("img");
          img.src = item.image;
          img.alt = item.title;
          card.appendChild(img);
        }

        const t = document.createElement("div");
        t.className = "card-title";
        t.textContent = item.title;
        card.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "card-meta";
        meta.innerHTML = `<span class="price">$${item.price?.toFixed(2) || "‚Äî"}</span><span>${item.store || ""}</span>`;
        card.appendChild(meta);

        const link = document.createElement("a");
        link.textContent = "View Deal";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.href = item.url;

        card.appendChild(link);
        resultsEl.appendChild(card);
      });

      alertWrapper.style.display = "block";
      updatePaws();
    });

    // Alerts (unchanged)
    saveAlertBtn.addEventListener("click", async () => {
      const brandKey = resolveBrand();
      const modelCanonical = resolveModelKey(brandKey, modelInput.value);
      const product = `${brandKey} ${modelCanonical}`;
      const alertPrice = document.getElementById("alertPrice").value.trim();
      const email = document.getElementById("alertEmail").value.trim();
      const phone = document.getElementById("alertPhone").value.trim();

      const res = await fetch("/api/alerts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product, targetPrice: alertPrice, email, phone })
      });

      const data = await res.json().catch(() => ({}));
      alertStatusEl.textContent = res.ok ? "Alert saved!" : (data.error || "Could not save.");
    });
  </script>
</body>
</html>
