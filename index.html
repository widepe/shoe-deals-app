<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* Make cards able to host an overlay */
    .card {
      position: relative;
    }

    /* Wrap the image so we can pin the badge to it */
    .card-image-wrapper {
      position: relative;
      width: 100%;
    }

    /* Discount badge in corner of image */
    .discount-badge {
      position: absolute;
      top: 0.35rem;
      left: 0.35rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      background: rgba(220, 53, 69, 0.9);
      color: #ffffff;
    }

    /* Price row styling */
    .card-meta .price {
      display: inline-flex;
      align-items: baseline;
    }

    /* Original price with line-through */
    .card-original-price {
      margin-left: 0.35rem;
      font-size: 0.8rem;
      color: #777;
      text-decoration: line-through;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      align-items: center;
      padding-top: 2rem;
    }

    /* Top Navigation */
    .top-nav {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-nav a {
      color: #214478ff;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease;
      user-select: none;
    }

    .top-nav a:hover {
      color: #1a3661;
      text-decoration: underline;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover { opacity: 0.9; }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 0.75rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }

    /* Paw icon inside inputs */
    .paw {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.75;
      pointer-events: none;
      transform-origin: 50% 70%;
    }

    .paw.hidden { display: none; }

    /* Icon rock animations */
    @keyframes iconRock {
      0%   { transform: rotate(-10deg); }
      50%  { transform: rotate(10deg); }
      100% { transform: rotate(-10deg); }
    }

    .search-btn.ready { box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3); }

    .search-btn.ready .magnify-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-prompt-btn .bell-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-submit-btn.ready .envelope-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      height: 42px;
      padding: 0 2.1rem 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    /* Remove number input arrows */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    input::placeholder { color: #999; opacity: 1; }

    .model-inactive { background: #faf5f2ff; cursor: not-allowed; }
    .model-active { background: #ffffff; cursor: text; }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .suggestion-item:hover { background: #e8f0ff; }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }
    .search-btn:hover { background: #1a3661; }

    /* Tagline must ALWAYS remain under inputs */
    .tagline {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.05rem;
      text-align: center;
      width: 100%;
    }

    /* Separate dynamic status line so tagline never gets overwritten */
    .status-message {
      font-size: 0.9rem;
      color: #2d3c22;
      margin-top: 0.15rem;
      text-align: center;
      width: 100%;
      min-height: 1.1rem;
    }

    /* Daily Deals Section */
    .daily-deals {
      width: 100%;
      max-width: 850px;
      margin-top: 1.0rem;
    }

    .daily-deals-header {
      font-size: 1.8rem;
      font-weight: 700;
      color: #214478ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    .daily-deals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 200px));
      gap: 1rem;
      width: 100%;
      justify-content: center;
    }

    /* Unified card style: search + daily deals */
    .card {
      background: #d9e1ebff;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      text-align: left;
      box-sizing: border-box;
    }

    .card-link {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-decoration: none;
      color: inherit;
      height: 100%;
    }
    .card img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: contain;
      height: 150px;
      background: white;
      border: 1px solid #214478ff;
      box-sizing: border-box;
    }

    .card-title {
      font-size: 0.92rem;
      font-weight: 600;
      display: -webkit-box;
      -webkit-line-clamp: 3;    /* allow up to 3 lines */
      -webkit-box-orient: vertical;
      overflow: hidden;         /* hide extra text */
      text-overflow: ellipsis;  /* optional ... */
      min-height: calc(1.2em * 3);  /* reserve room for 3 lines */
    }

    .card-store {
      font-size: 0.82rem;
      color: #49543a;
    }

    .card-price-row {
      display: flex;
      align-items: baseline;
      gap: 0.3rem;
      font-size: 0.95rem;
    }

    .price {
      font-weight: 700;
      color: #214478ff;
    }

    .card-original {
      text-decoration: line-through;
      font-size: 0.8rem;
      color: #777;
    }

    .card-discount {
      font-size: 0.8rem;
      color: #2d3c22;
      margin-top: 0.05rem;
    }

    .results {
      margin-top: 1.0rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 200px));
      gap: 1.25rem;
      width: 100%;
      justify-content: center;
      max-width: 850px;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      max-width: 850px;
      margin: 0.15rem auto 0;
      text-align: center;
    }

    /* Alert section styles */
    .alert-wrapper {
      width: 100%;
      max-width: 850px;
      margin-top: 1.0rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .alert-prompt-btn,
    .alert-form,
    .alert-confirmation,
    .alert-existing-info {
      margin-left: auto;
      margin-right: auto;
    }

    .alert-prompt-btn {
      display: block;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #214478ff;
      transition: background 0.2s ease;
    }
    .alert-prompt-btn:hover { background: #1a3661; }

    .alert-form {
      width: 100%;
      max-width: 600px;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      box-sizing: border-box;
    }

    .alert-product-message {
      font-size: 0.95rem;
      color: #2d3c22;
      text-align: center;
      font-weight: 500;
      width: 100%;
    }
    .alert-product-message strong { color: #214478ff; font-weight: 700; }

    .alert-form-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 66%;
      max-width: 350px;
    }

    .alert-form-row label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2d3c22;
      text-align: left;
    }

    .alert-form-row input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 0.95rem;
      box-sizing: border-box;
      color: #444;
    }

    .price-input-wrapper {
      position: relative;
      width: 100%;
    }
    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.95rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }
    .price-input-wrapper input {
      padding-left: 1.75rem;
      padding-right: 2.1rem;
    }

    .alert-privacy-note {
      font-size: 0.8rem;
      color: #34452a;
      text-align: center;
      padding: 0.5rem;
      background: transparent;
      border-radius: 0.5rem;
      width: 100%;
    }

    .alert-duration-note {
      font-size: 0.85rem;
      color: #34452a;
      text-align: center;
      font-style: italic;
      width: 100%;
    }

    .alert-submit-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #214478ff;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      width: auto;
      align-self: center;
      display: none;
      margin-left: auto;
      margin-right: auto;
    }

    .alert-submit-btn.ready {
      display: block;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3);
    }
    .alert-submit-btn.ready:hover { background: #1a3661; }

    .alert-confirmation,
    .alert-existing-info {
      width: 100%;
      max-width: 600px;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      color: #2d3c22;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.6;
      box-sizing: border-box;
    }
    .alert-confirmation strong,
    .alert-existing-info strong { color: #214478ff; }

    .hidden { display: none !important; }

    /* Footer */
    .footer {
      margin-top: 2rem;
      padding: 0.75rem 1rem;
      background: rgba(244, 237, 227, 0.97);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 0.82rem;
      color: #444;
      text-align: center;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      margin: 0 0.25rem;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>

  <div class="top-nav">
    <a href="/pages/myalerts.html">My Alerts</a>
  </div>

  <div class="app">
    <div class="brand">
      <img src="/images/logo.svg" class="brand-logo" alt="Shoe Beagle Logo" id="logoLink">
    </div>

    <form id="search-form" method="POST">
      <div class="input-wrapper">
        <input id="brand" type="text" placeholder="Enter Shoe Brand" autocomplete="off"/>
        <span class="paw rock" id="brandPaw">üêæ</span>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input id="model" type="text" placeholder="Enter Shoe Model" autocomplete="off" class="model-active"/>
        <span class="paw hidden" id="modelPaw">üêæ</span>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn"><span class="magnify-icon">üîç</span> Fetch!</button>
      </div>
    </form>

    <div class="tagline">Let's find your running shoes!</div>
    <div class="status-message" id="statusMessage"></div>

    <div id="mainContent">
      <div class="daily-deals" id="dailyDeals">
        <div class="daily-deals-header">Marty's Daily Deals</div>
        <div class="daily-deals-grid" id="dailyDealsGrid"></div>
      </div>

      <div class="results" id="results"></div>
      <p class="disclaimer">Shoe Beagle does not sell products directly and is not responsible for changes in price, availability, or shipping terms on retailer sites.</p>

      <div class="alert-wrapper" id="alertWrapper" style="display:none;">
        <button class="alert-prompt-btn" id="alertPromptBtn"><span class="bell-icon">üîî</span> Set Price Alert?</button>

        <div class="alert-existing-info" id="alertExistingInfo" style="display:none;"></div>

        <div class="alert-form" id="alertForm" style="display:none;">
          <div class="alert-product-message">
            Alert me when <strong id="alertProductName"></strong> is less than:
          </div>

          <div class="alert-form-row">
            <div class="price-input-wrapper">
              <input id="alertPrice" type="number" step="1" placeholder="Enter Dollar Amount" min="1">
              <span class="paw rock" id="alertPricePaw">üêæ</span>
            </div>
          </div>

          <div class="alert-form-row">
            <label for="alertContact">Email Address</label>
            <input id="alertContact" type="text" placeholder="you@example.com">
          </div>

          <div class="alert-privacy-note">üîí Your information is used only to send you requested price alerts, and is never sold or shared with third parties.</div>

          <button class="alert-submit-btn" id="alertSubmitBtn">
            <span class="envelope-icon">üì©</span> Set Price Alert
          </button>

          <div class="alert-duration-note">Your price alert will remain active for 30 days, or until you cancel.</div>
        </div>

        <div class="alert-confirmation" id="alertConfirmation" style="display:none;"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <a href="/pages/about.html">About</a> |
      <a href="/pages/contact.html">Contact</a> |
      <a href="/pages/privacy.html">Privacy</a> |
      <a href="/pages/terms.html">Terms</a> |
      <br>
      ¬© <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script>
    const form = document.getElementById("search-form");
    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    const dailyDealsGrid = document.getElementById("dailyDealsGrid");

    const alertWrapper = document.getElementById("alertWrapper");
    const alertPromptBtn = document.getElementById("alertPromptBtn");
    const alertForm = document.getElementById("alertForm");
    const alertSubmitBtn = document.getElementById("alertSubmitBtn");
    const alertConfirmation = document.getElementById("alertConfirmation");
    const alertExistingInfo = document.getElementById("alertExistingInfo");
    const alertProductName = document.getElementById("alertProductName");

    const alertPriceInput = document.getElementById("alertPrice");
    const alertPricePaw = document.getElementById("alertPricePaw");
    const alertContactInput = document.getElementById("alertContact");

    const fetchBtn = document.getElementById("fetchBtn");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");

    const brandPaw = document.getElementById("brandPaw");
    const modelPaw = document.getElementById("modelPaw");

    const mainContent = document.getElementById("mainContent");
    const logoLink = document.getElementById("logoLink");

    const footerYear = document.getElementById("footerYear");

    let currentSearch = { brand: "", model: "" };
    let brandSelected = false;

    const ALERTS_KEY = "shoeBeagleAlerts";
    let alertsMemoryFallback = [];

    // Set footer year
    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }

    logoLink.addEventListener("click", () => {
      location.reload();
    });

    function canUseLocalStorage() {
      try {
        const k = "__sb_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
      } catch (e) { return false; }
    }

    function loadAlerts() {
      if (canUseLocalStorage()) {
        try {
          const raw = localStorage.getItem(ALERTS_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) { return []; }
      }
      return alertsMemoryFallback;
    }

    function saveAlerts(list) {
      if (canUseLocalStorage()) {
        try { localStorage.setItem(ALERTS_KEY, JSON.stringify(list)); } catch (e) {}
      } else {
        alertsMemoryFallback = list;
      }
    }

    function normalizeStr(s) { return String(s || "").trim().toLowerCase(); }
    function nowMs() { return Date.now(); }

    // Shared discount helper used by cards
    function getDiscountInfo(item) {
      const price = Number(item.price);
      const original = item.originalPrice != null ? Number(item.originalPrice) : NaN;

      // Best case: we have both prices
      if (
        Number.isFinite(price) &&
        Number.isFinite(original) &&
        original > 0 &&
        price < original
      ) {
        const pct = Math.round(((original - price) / original) * 100);
        return {
          hasDiscount: true,
          current: price.toFixed(2),
          original: original.toFixed(2),
          percent: pct
        };
      }

      // Fallback: parse string discount like "-23%"
      if (Number.isFinite(price) && typeof item.discount === "string" && item.discount.includes("%")) {
        const m = item.discount.match(/(-?\d+(?:\.\d+)?)%/);
        if (m) {
          const pct = Math.abs(Number(m[1]));
          if (Number.isFinite(pct) && pct > 0 && pct < 100) {
            const origGuess = price / (1 - pct / 100);
            if (Number.isFinite(origGuess) && origGuess > price) {
              return {
                hasDiscount: true,
                current: price.toFixed(2),
                original: origGuess.toFixed(2),
                percent: Math.round(pct)
              };
            }
          }
        }
      }

      return { hasDiscount: false };
    }

    function daysBetween(msA, msB) {
      const diff = Math.abs(msA - msB);
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function computeAlertStatus(alert) {
      if (alert.cancelledAt) return "Cancelled";
      const ageDays = daysBetween(alert.setAt, nowMs());
      if (ageDays >= 30) return "Expired";
      return "Active";
    }

    function computeDaysLeft(alert) {
      if (alert.cancelledAt) return 0;
      const ageDays = daysBetween(alert.setAt, nowMs());
      const left = 30 - ageDays;
      return left > 0 ? left : 0;
    }

    function alertKey(brand, model) {
      return `${normalizeStr(brand)}::${normalizeStr(model)}`;
    }

    function findActiveAlertFor(brand, model) {
      const key = alertKey(brand, model);
      const list = loadAlerts();
      return list.find(a => a.key === key && computeAlertStatus(a) === "Active");
    }

    function upsertAlert(newAlert) {
      const list = loadAlerts();
      const idx = list.findIndex(a => a.id === newAlert.id);
      if (idx >= 0) list[idx] = newAlert;
      else list.push(newAlert);
      saveAlerts(list);
    }

    const brandModels = {
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"]
    };

    const brands = Object.keys(brandModels).sort();

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }

    function resolveBrand() { return resolveBrandKey(brandInput.value.trim()); }

    function resolveModelKey(brandKey, modelTyped) {
      const typed = String(modelTyped || "").trim();
      if (!typed) return "";
      if (!brandKey || !brandModels[brandKey]) return typed;
      const normalized = normalizeStr(typed);
      const canonical = brandModels[brandKey].find(m => normalizeStr(m) === normalized);
      return canonical || typed;
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { container.style.display = "none"; return; }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function enableModel() {
      modelInput.disabled = false;
      modelInput.classList.remove("model-inactive");
      modelInput.classList.add("model-active");
    }

    function resetModelState() {
      modelInput.disabled = true;
      modelInput.value = "";
      modelInput.placeholder = "";
      modelInput.classList.remove("model-active");
      modelInput.classList.add("model-inactive");
      modelSuggestions.style.display = "none";
      modelPaw.classList.add("hidden");
      brandSelected = false;
    }

    function confirmBrandSelection() {
      if (!modelInput.disabled) {
        modelInput.placeholder = "Enter Shoe Model";
        brandSelected = true;
        brandPaw.classList.add("hidden");
        modelPaw.classList.remove("hidden");
      }
    }

    function updateFetchReady() {
      const brandKey = resolveBrand();
      const modelHasText = !!modelInput.value.trim();
      const ready = !!brandKey && !modelInput.disabled && modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    function updatePaws() {
      if (brandInput.value.trim()) {
        brandPaw.classList.add("hidden");
      } else if (!brandSelected) {
        brandPaw.classList.remove("hidden");
      }

      if (brandSelected && !modelInput.disabled) {
        if (!modelInput.value.trim()) {
          modelPaw.classList.remove("hidden");
        } else {
          modelPaw.classList.add("hidden");
        }
      } else {
        modelPaw.classList.add("hidden");
      }

      updateFetchReady();
    }

    function updateAlertSubmitButton() {
      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      const priceValid = price && parseFloat(price) > 0;
      const contactValid = contact.length > 0 && contact.includes('@');
      const isReady = priceValid && contactValid;
      alertSubmitBtn.classList.toggle("ready", isReady);
    }

    function resetAlertSection() {
      alertPromptBtn.style.display = "block";
      alertForm.style.display = "none";
      alertConfirmation.style.display = "none";
      alertExistingInfo.style.display = "none";
      alertPriceInput.value = "";
      alertContactInput.value = "";
      alertPricePaw.classList.remove("hidden");
      updateAlertSubmitButton();
    }

    updatePaws();
    dailyDeals.style.display = "block";

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      const matches = filterStartsWith(brands, typed);
      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";
        enableModel();
        confirmBrandSelection();
        setTimeout(() => modelInput.focus(), 0);
        updatePaws();
      });
      updatePaws();
    });

    brandInput.addEventListener("blur", () => setTimeout(() => { brandSuggestions.style.display = "none"; }, 120));

    brandInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const typed = brandInput.value.trim();
        if (typed) {
          e.preventDefault();
          enableModel();
          confirmBrandSelection();
          modelInput.focus();
          updatePaws();
        }
      }
    });

    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();
      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updatePaws();
        return;
      }
      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);
      showSuggestions(modelSuggestions, matches, (value) => {
        modelInput.value = value;
        modelSuggestions.style.display = "none";
        setTimeout(() => fetchBtn.focus(), 0);
        updatePaws();
      });
      updatePaws();
    });

    brandInput.addEventListener("click", () => {
      brandInput.select();
    });

    modelInput.addEventListener("click", () => {
      modelInput.select();
    });

    modelInput.addEventListener("blur", () => setTimeout(() => { modelSuggestions.style.display = "none"; }, 120));

    alertPriceInput.addEventListener("input", () => {
      if (alertPriceInput.value.trim()) {
        alertPricePaw.classList.add("hidden");
      } else {
        alertPricePaw.classList.remove("hidden");
      }
      updateAlertSubmitButton();
    });

    alertContactInput.addEventListener("input", updateAlertSubmitButton);

    // Helper: create unified deal card (used for search + daily deals)
    function createDealCard(item) {
      const discount = getDiscountInfo(item); // uses price + originalPrice

      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.className = "card-link";
      link.href = item.url || "#";
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      // --- image + corner badge ---
      const imgWrapper = document.createElement("div");
      imgWrapper.className = "card-image-wrapper";

      if (item.image) {
        const img = document.createElement("img");
        img.src = item.image;
        img.alt = item.title || "Running shoe deal";
        imgWrapper.appendChild(img);
      } else {
        const img = document.createElement("img");
        img.alt = "Running shoe";
        imgWrapper.appendChild(img);
      }

      if (discount.hasDiscount) {
        const badge = document.createElement("div");
        badge.className = "discount-badge";
        badge.textContent = `${discount.percent}% OFF`;
        imgWrapper.appendChild(badge);
      }

      link.appendChild(imgWrapper);

      // --- title & store ---
     // --- brand + model (instead of title) ---
const titleDiv = document.createElement("div");
titleDiv.className = "card-title";

const brand = (item.brand || "").trim();
const model = (item.model || "").trim();

titleDiv.textContent =
  (brand || model)
    ? [brand, model].filter(Boolean).join(" ")
    : (item.title || "Deal");

link.appendChild(titleDiv);


      if (item.store) {
        const storeDiv = document.createElement("div");
        storeDiv.className = "card-store";
        storeDiv.textContent = item.store;
        link.appendChild(storeDiv);
      }

      // --- price row (current + struck-through original) ---
      const priceRow = document.createElement("div");
      priceRow.className = "card-price-row";

      const priceSpan = document.createElement("span");
      priceSpan.className = "price";

      const currentPrice = Number(item.price);
      if (Number.isFinite(currentPrice)) {
        priceSpan.textContent = `$${currentPrice.toFixed(2)}`;
      } else {
        priceSpan.textContent = item.price ? String(item.price) : "‚Äî";
      }
      priceRow.appendChild(priceSpan);

      if (discount.hasDiscount) {
        const origSpan = document.createElement("span");
        origSpan.className = "card-original-price";
        origSpan.textContent = `$${discount.original}`;
        priceRow.appendChild(origSpan);
      }

      link.appendChild(priceRow);

      card.appendChild(link);
      return card;
    }

    // Load daily deals from API and render as cards
    async function loadDailyDeals() {
      try {
        const res = await fetch("/api/daily-deals");
        const data = await res.json();
        const deals = (data && Array.isArray(data.deals)) ? data.deals : [];
        dailyDealsGrid.innerHTML = "";

        if (!deals.length) {
          dailyDeals.style.display = "none";
          return;
        }

        deals.forEach(item => {
          const card = createDealCard(item);
          dailyDealsGrid.appendChild(card);
        });

        dailyDeals.style.display = "block";
      } catch (err) {
        console.error("Error loading daily deals:", err);
        dailyDeals.style.display = "none";
      }
    }

    // Initial daily deals load
    loadDailyDeals();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandTyped = brandInput.value.trim();
      const modelTyped = modelInput.value.trim();

      // ‚úÖ Require at least one of brand/model, not both
      if (!brandTyped && !modelTyped) {
        statusMessageEl.textContent = "Please enter a brand or a model.";
        updatePaws();
        return;
      }

      currentSearch = { brand: brandTyped, model: modelTyped };

      // Used for display + query; avoids extra spaces if one is blank
      const displayQuery = [brandTyped, modelTyped].filter(Boolean).join(" ");

      statusMessageEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";
      dailyDeals.style.display = "none";

      resetAlertSection();
      alertWrapper.style.display = "flex";

      const existingActive = findActiveAlertFor(brandTyped, modelTyped);
      if (existingActive) {
        alertPromptBtn.style.display = "none";
        const daysLeft = computeDaysLeft(existingActive);
        alertExistingInfo.innerHTML = `
          <strong>You have an active alert set for this shoe.</strong><br><br>
          <strong>Shoe:</strong> ${existingActive.brand} ${existingActive.model}<br>
          <strong>Days Remaining:</strong> ${daysLeft}<br>
          <strong>Target Price:</strong> $${Number(existingActive.targetPrice).toFixed(2)}<br><br>
          Open <strong><a href="/pages/myalerts.html">My Alerts</a></strong> to manage it.
        `;
        alertExistingInfo.style.display = "block";
      } else {
        alertPromptBtn.style.display = "block";
        alertExistingInfo.style.display = "none";
      }

      alertProductName.textContent = displayQuery;

      const query = displayQuery;
      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        return;
      }

      const results = (data && data.results) ? data.results : [];

      if (!results.length) {
        statusMessageEl.textContent = `No results found for ${displayQuery} ‚Äî set a price alert and we'll keep sniffing.`;
        return;
      }

      statusMessageEl.textContent =
        `Top ${results.length} deal${results.length === 1 ? '' : 's'} found for ${displayQuery}`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = createDealCard(item);
        resultsEl.appendChild(card);
      });
    });

    alertPromptBtn.addEventListener("click", () => {
      alertPromptBtn.style.display = "none";
      alertForm.style.display = "flex";
    });

    alertSubmitBtn.addEventListener("click", async () => {
      const priceNum = Number(alertPriceInput.value.trim());
      const contact = alertContactInput.value.trim();
      const brand = currentSearch.brand;
      const model = currentSearch.model;

      if (!brand || !model) {
        alert("Please search for a shoe first, then set an alert.");
        return;
      }

      if (!isFinite(priceNum) || priceNum <= 0) {
        alert("Please enter a valid target price greater than 0.");
        return;
      }

      const existingActive = findActiveAlertFor(brand, model);
      if (existingActive) {
        alertForm.style.display = "none";
        alertConfirmation.innerHTML = `
          <strong>This shoe already has an active alert.</strong><br><br>
          To edit the alert, please manage it in <strong><a href="/pages/myalerts.html">My Alerts</a></strong>.
        `;
        alertConfirmation.style.display = "block";
        return;
      }

      const isEmail = contact.includes('@');
      const payload = {
        product: `${brand} ${model}`,
        targetPrice: Number(priceNum).toFixed(2),
        email: isEmail ? contact : "",
        phone: isEmail ? "" : contact
      };

      const newAlert = {
        id: `a_${Math.random().toString(36).slice(2)}_${Date.now()}`,
        key: alertKey(brand, model),
        setAt: nowMs(),
        brand,
        model,
        targetPrice: Number(priceNum).toFixed(2),
        cancelledAt: null,
        contact
      };
      upsertAlert(newAlert);

      try {
        await fetch("/api/alerts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alertForm.style.display = "none";
        alertConfirmation.innerHTML = `
          <strong>Price alert set!</strong><br><br>
          We'll notify you at <strong>${contact}</strong> when <strong>${brand} ${model}</strong> drops below <strong>$${Number(priceNum).toFixed(2)}</strong>.
        `;
        alertConfirmation.style.display = "block";
      } catch (err) {
        console.error("Alert submission error:", err);
        alert("Failed to set alert. Please try again.");
      }
    });

    alertPriceInput.addEventListener("input", () => {
      if (alertPriceInput.value.trim()) {
        alertPricePaw.classList.add("hidden");
      } else {
        alertPricePaw.classList.remove("hidden");
      }
      updateAlertSubmitButton();
    });

    alertContactInput.addEventListener("input", updateAlertSubmitButton);
  </script>
</body>
</html>
