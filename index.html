<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      align-items: center;
      padding-top: 2rem;
    }

    /* Top Navigation */
    .top-nav {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-nav a {
      color: #214478ff;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease;
      user-select: none;
    }

    .top-nav a:hover {
      color: #1a3661;
      text-decoration: underline;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .brand-logo:hover { opacity: 0.9; }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 0.75rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }

    /* Paw icon inside inputs */
    .paw {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.75;
      pointer-events: none;
      transform-origin: 50% 70%;
    }

    .paw.hidden { display: none; }

    @keyframes pawRock {
      0%   { transform: translateY(-50%) rotate(-10deg); }
      50%  { transform: translateY(-50%) rotate(10deg); }
      100% { transform: translateY(-50%) rotate(-10deg); }
    }

    .paw.rock { animation: pawRock 1.1s ease-in-out infinite; }

    /* Icon rock animations */
    @keyframes iconRock {
      0%   { transform: rotate(-10deg); }
      50%  { transform: rotate(10deg); }
      100% { transform: rotate(-10deg); }
    }

    .search-btn.ready { box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3); }

    .search-btn.ready .magnify-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-prompt-btn .bell-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    .alert-submit-btn.ready .envelope-icon {
      display: inline-block;
      animation: iconRock 1.1s ease-in-out infinite;
      transform-origin: center center;
    }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      height: 42px;
      padding: 0 2.1rem 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    input::placeholder { color: #999; opacity: 1; }

    .model-inactive { background: #faf5f2ff; cursor: not-allowed; }
    .model-active { background: #ffffff; cursor: text; }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .suggestion-item:hover { background: #e8f0ff; }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }
    .search-btn:hover { background: #1a3661; }

    /* Tagline must ALWAYS remain under inputs */
    .tagline {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.05rem;
      text-align: center;
      width: 100%;
    }

    /* Separate dynamic status line so tagline never gets overwritten */
    .status-message {
      font-size: 0.9rem;
      color: #2d3c22;
      margin-top: 0.15rem;
      text-align: center;
      width: 100%;
      min-height: 1.1rem;
    }

    /* Daily Deals Section */
    .daily-deals {
      width: 100%;
      max-width: 850px;
      margin-top: 1.0rem;
    }

    .daily-deals-header {
      font-size: 1.3rem;
      font-weight: 700;
      color: #214478ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    .daily-deals-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .daily-deal-card {
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-align: center;
      width: calc(33.333% - 0.75rem);
      min-width: 180px;
      max-width: 200px;
      flex-shrink: 0;
    }

    .daily-deal-card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 0.6rem;
      background: #fafafa;
    }

    .daily-deal-title { font-size: 0.85rem; font-weight: 600; color: #2d2d2d; }
    .daily-deal-price { font-size: 1rem; font-weight: 700; color: #214478ff; }

    .results {
      margin-top: 1.0rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      width: 100%;
      max-width: 850px;
    }

    .card {
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .card img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: contain;
      max-height: 170px;
      background: #fafafa;
    }

    .card-title { font-size: 0.92rem; font-weight: 600; }

    .card-meta {
      font-size: 0.82rem;
      color: #49543a;
      display: flex;
      justify-content: space-between;
    }

    .price { font-weight: 700; color: #214478ff; }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      max-width: 850px;
      margin: 0.15rem auto 0;
      text-align: center;
    }

    /* About Section */
    .about-section {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.25rem 2rem 0.9rem;
      margin-top: 1.0rem;
      line-height: 1.7;
      box-sizing: border-box;
    }

    .about-section h2 {
      color: #214478ff;
      font-size: 1.8rem;
      margin: 0 0 0.85rem;
      text-align: center;
    }

    .about-section p {
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #2d2d2d;
    }

    /* Alert section styles */
    .alert-wrapper {
      width: 100%;
      max-width: 600px;
      margin-top: 1.0rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    /* Make sure the button and the boxes are truly centered */
    .alert-prompt-btn,
    .alert-form,
    .alert-confirmation {
      margin-left: auto;
      margin-right: auto;
    }

    .alert-prompt-btn {
      display: block;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #214478ff;
      transition: background 0.2s ease;
    }
    .alert-prompt-btn:hover { background: #1a3661; }

    .alert-form {
      width: 100%;
      max-width: 600px;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      box-sizing: border-box;
    }

    .alert-product-message {
      font-size: 0.95rem;
      color: #2d3c22;
      text-align: center;
      font-weight: 500;
      width: 100%;
    }
    .alert-product-message strong { color: #214478ff; font-weight: 700; }

    .alert-form-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 66%;
      max-width: 350px;
    }

    .alert-form-row label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2d3c22;
      text-align: left;
    }

    .alert-form-row input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 0.95rem;
      box-sizing: border-box;
      color: #444;
    }

    .price-input-wrapper { position: relative; width: 100%; }
    .price-input-wrapper::before {
      content: '$';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.95rem;
      color: #444;
      pointer-events: none;
      font-weight: 500;
    }
    .price-input-wrapper input { padding-left: 1.75rem; }

    .alert-privacy-note {
      font-size: 0.8rem;
      color: #34452a;
      text-align: center;
      padding: 0.5rem;
      background: transparent;
      border-radius: 0.5rem;
      width: 100%;
    }

    .alert-duration-note {
      font-size: 0.85rem;
      color: #34452a;
      text-align: center;
      font-style: italic;
      width: 100%;
    }

    .alert-submit-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #8fa3b8;
      color: white;
      font-size: 1rem;
      cursor: not-allowed;
      border: 1px solid #214478ff;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      opacity: 0.6;
      width: auto;
      align-self: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .alert-submit-btn.ready {
      background: #214478ff;
      cursor: pointer;
      opacity: 1;
      box-shadow: 0 0 0 3px rgba(33, 68, 120, 0.3);
    }
    .alert-submit-btn.ready:hover { background: #1a3661; }

    .alert-confirmation {
      width: 100%;
      max-width: 600px;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      color: #2d3c22;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.6;
      box-sizing: border-box;
    }
    .alert-confirmation strong { color: #214478ff; }

    /* My Alerts dashboard */
    .alerts-dashboard {
      width: 100%;
      max-width: 850px;
      background: #ffffffc9;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 1.25rem 1.25rem 1.5rem;
      margin-top: 1.0rem;
      box-sizing: border-box;
    }

    .alerts-title {
      color: #214478ff;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin: 0.25rem 0 1rem;
    }

    .alerts-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      overflow: visible; /* allow content to show */
      border-radius: 0.6rem;
    }

    .alerts-table thead th {
      text-align: left;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #214478ff;
      padding: 0.75rem 0.65rem;
      border-bottom: 2px solid rgba(33, 68, 120, 0.35);
      background: rgba(255, 255, 255, 0.55);
    }

    /* Default: no ellipses anywhere in the table */
    .alerts-table tbody td {
      padding: 0.75rem 0.65rem;
      border-bottom: 1px solid rgba(33, 68, 120, 0.18);
      vertical-align: middle;
      font-size: 0.92rem;
      color: #2d2d2d;
      overflow: visible;
      text-overflow: clip;
      white-space: normal; /* allow wrapping so nothing truncates */
      line-height: 1.2;
    }

    /* Keep action buttons on one line in Status */
    .alerts-table td.status-cell {
      white-space: nowrap;
    }

    .alerts-muted {
      text-align: center;
      padding: 1.25rem 0.5rem;
      color: #49543a;
      font-size: 0.95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.82rem;
      border: 1px solid rgba(33, 68, 120, 0.25);
      background: rgba(255, 255, 255, 0.6);
      color: #214478ff;
      margin-right: 0.45rem;
    }

    .pill.active {
      background: rgba(46, 160, 67, 0.20);
      border-color: rgba(46, 160, 67, 0.55);
      color: #1f6a2a;
    }

    .pill.expired {
      background: rgba(150, 150, 150, 0.18);
      border-color: rgba(150, 150, 150, 0.40);
      color: #555;
    }

    .pill.cancelled {
      background: rgba(220, 53, 69, 0.14);
      border-color: rgba(220, 53, 69, 0.35);
      color: #8a1f2c;
    }

    .action-btn {
      border-radius: 0.6rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      color: white;
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      margin-left: 0.45rem;
      white-space: nowrap;
    }
    .action-btn:hover { background: #1a3661; }

    .action-btn.secondary {
      background: transparent;
      color: #214478ff;
    }
    .action-btn.secondary:hover {
      background: rgba(33, 68, 120, 0.10);
    }

    .target-editor {
      width: 92px;
      height: 32px;
      font-size: 0.9rem;
      padding: 0 0.4rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      color: #444;
      box-sizing: border-box;
      margin-left: 0.35rem;
      vertical-align: middle;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>

  <div class="top-nav">
    <a id="aboutLink">About Us</a>
    <a id="myAlertsLink">My Alerts</a>
  </div>

  <div class="app">
    <div class="brand">
      <img src="/images/logo.svg" class="brand-logo" alt="Shoe Beagle Logo" id="logoLink">
    </div>

    <form id="search-form">
      <div class="input-wrapper">
        <input id="brand" type="text" placeholder="Enter Shoe Brand" autocomplete="off" required />
        <span class="paw rock" id="brandPaw">üêæ</span>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input id="model" type="text" placeholder="" autocomplete="off" required class="model-inactive" disabled />
        <span class="paw hidden" id="modelPaw">üêæ</span>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn"><span class="magnify-icon">üîç</span> Fetch!</button>
      </div>
    </form>

    <div class="tagline">Let's find your <b>running shoes</b>...cheap!</div>
    <div class="status-message" id="statusMessage"></div>

    <div id="mainContent">
      <div class="daily-deals" id="dailyDeals">
        <div class="daily-deals-header">Top 5 Daily Deals</div>
        <div class="daily-deals-grid">
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Brooks+Ghost" alt="Brooks Ghost 15">
            <div class="daily-deal-title">Brooks Ghost 15</div>
            <div class="daily-deal-price">$89.95</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Nike+Pegasus" alt="Nike Pegasus 40">
            <div class="daily-deal-title">Nike Pegasus 40</div>
            <div class="daily-deal-price">$99.99</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Hoka+Clifton" alt="Hoka Clifton 9">
            <div class="daily-deal-title">Hoka Clifton 9</div>
            <div class="daily-deal-price">$119.95</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Asics+Nimbus" alt="Asics Gel-Nimbus 25">
            <div class="daily-deal-title">Asics Gel-Nimbus 25</div>
            <div class="daily-deal-price">$129.99</div>
          </div>
          <div class="daily-deal-card">
            <img src="https://placehold.co/300x200?text=Saucony+Ride" alt="Saucony Ride 16">
            <div class="daily-deal-title">Saucony Ride 16</div>
            <div class="daily-deal-price">$94.95</div>
          </div>
        </div>
      </div>

      <div class="results" id="results"></div>
      <p class="disclaimer">Prices are subject to change.</p>

      <div class="alert-wrapper" id="alertWrapper" style="display:none;">
        <!-- Centered -->
        <button class="alert-prompt-btn" id="alertPromptBtn"><span class="bell-icon">üîî</span> Set Price Alert?</button>

        <!-- Centered box -->
        <div class="alert-form" id="alertForm" style="display:none;">
          <div class="alert-product-message">
            Alert me when <strong id="alertProductName"></strong> is less than:
          </div>

          <div class="alert-form-row">
            <div class="price-input-wrapper">
              <input id="alertPrice" type="number" step="0.01" placeholder="120.00" min="0">
            </div>
          </div>

          <div class="alert-form-row">
            <label for="alertContact">Email or Phone Number</label>
            <input id="alertContact" type="text" placeholder="you@example.com or +1-555-0123">
          </div>

          <div class="alert-privacy-note">üîí Your information is never shared. Used only for price alerts.</div>

          <button class="alert-submit-btn" id="alertSubmitBtn" disabled>
            <span class="envelope-icon">üì©</span> Set Price Alert
          </button>

          <div class="alert-duration-note">Your price alert will remain active for 30 days, or until you cancel.</div>
        </div>

        <div class="alert-confirmation" id="alertConfirmation" style="display:none;"></div>
      </div>
    </div>

    <div id="aboutContent" class="about-section hidden">
      <h2>About Us</h2>
      <p>Shoe Beagle is a price comparison website dedicated to helping runners find the best deals on running shoes. We provide side-by-side price comparisons across multiple retailers, allowing users to search by brand and model to find the lowest prices.</p>
      <p>Our platform features price alerts, real-time deal updates, and direct links to merchant sites where users can complete their purchases.</p>
      <p>I will do my best to sniff out the best running shoe deals every day!</p>
      <div style="text-align: center; margin: 1.2rem 0 0.35rem;">
        <img src="/images/marty.svg" alt="Marty the Beagle" style="width: 200px; height: auto;">
      </div>
    </div>

    <div id="alertsDashboard" class="alerts-dashboard hidden">
      <div class="alerts-title">My Alerts</div>

      <table class="alerts-table" aria-label="My Alerts Table" id="alertsTable">
        <colgroup>
          <!-- Adjusted widths to avoid truncation AND keep buttons visible -->
          <col style="width: 10%;">  <!-- Date Set -->
          <col style="width: 34%;">  <!-- Shoe -->
          <col style="width: 16%;">  <!-- Days Left -->
          <col style="width: 18%;">  <!-- Target -->
          <col style="width: 22%;">  <!-- Status (pill + cancel) -->
        </colgroup>
        <thead>
          <tr>
            <th>Date Set</th>
            <th>Shoe</th>
            <th>Days Left</th>
            <th>Target</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="alertsTbody"></tbody>
      </table>

      <div id="alertsEmpty" class="alerts-muted hidden">No alerts have been set.</div>
    </div>
  </div>

  <script>
    const form = document.getElementById("search-form");
    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");

    const alertWrapper = document.getElementById("alertWrapper");
    const alertPromptBtn = document.getElementById("alertPromptBtn");
    const alertForm = document.getElementById("alertForm");
    const alertSubmitBtn = document.getElementById("alertSubmitBtn");
    const alertConfirmation = document.getElementById("alertConfirmation");
    const alertProductName = document.getElementById("alertProductName");

    const alertPriceInput = document.getElementById("alertPrice");
    const alertContactInput = document.getElementById("alertContact");

    const fetchBtn = document.getElementById("fetchBtn");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");

    const brandPaw = document.getElementById("brandPaw");
    const modelPaw = document.getElementById("modelPaw");

    const mainContent = document.getElementById("mainContent");
    const aboutContent = document.getElementById("aboutContent");
    const alertsDashboard = document.getElementById("alertsDashboard");

    const aboutLink = document.getElementById("aboutLink");
    const myAlertsLink = document.getElementById("myAlertsLink");
    const logoLink = document.getElementById("logoLink");

    const alertsTbody = document.getElementById("alertsTbody");
    const alertsEmpty = document.getElementById("alertsEmpty");
    const alertsTable = document.getElementById("alertsTable");

    let currentSearch = { brand: "", model: "" };
    let brandSelected = false;

    const ALERTS_KEY = "shoeBeagleAlerts";
    let alertsMemoryFallback = [];

    function canUseLocalStorage() {
      try {
        const k = "__sb_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
      } catch (e) { return false; }
    }

    function loadAlerts() {
      if (canUseLocalStorage()) {
        try {
          const raw = localStorage.getItem(ALERTS_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) { return []; }
      }
      return alertsMemoryFallback;
    }

    function saveAlerts(list) {
      if (canUseLocalStorage()) {
        try { localStorage.setItem(ALERTS_KEY, JSON.stringify(list)); } catch (e) {}
      } else {
        alertsMemoryFallback = list;
      }
    }

    function normalize(s) { return String(s || "").trim().toLowerCase(); }
    function nowMs() { return Date.now(); }

    function daysBetween(msA, msB) {
      const diff = Math.abs(msA - msB);
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatDateShort(ms) {
      const d = new Date(ms);
      const day = d.getDate();
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mon = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${day}-${mon}-${yy}`;
    }

    function computeAlertStatus(alert) {
      if (alert.cancelledAt) return "Cancelled";
      const ageDays = daysBetween(alert.setAt, nowMs());
      if (ageDays >= 30) return "Expired";
      return "Active";
    }

    function computeDaysLeft(alert) {
      if (alert.cancelledAt) return 0;
      const ageDays = daysBetween(alert.setAt, nowMs());
      const left = 30 - ageDays;
      return left > 0 ? left : 0;
    }

    function alertKey(brand, model) {
      return `${normalize(brand)}::${normalize(model)}`;
    }

    function findActiveAlertFor(brand, model) {
      const key = alertKey(brand, model);
      const list = loadAlerts();
      return list.find(a => a.key === key && computeAlertStatus(a) === "Active");
    }

    function upsertAlert(newAlert) {
      const list = loadAlerts();
      const idx = list.findIndex(a => a.id === newAlert.id);
      if (idx >= 0) list[idx] = newAlert;
      else list.push(newAlert);
      saveAlerts(list);
    }

    function pillClassFor(status) {
      if (status === "Active") return "pill active";
      if (status === "Expired") return "pill expired";
      if (status === "Cancelled") return "pill cancelled";
      return "pill";
    }

    function renderAlertsDashboard() {
      const list = loadAlerts();
      alertsTbody.innerHTML = "";

      if (!list.length) {
        alertsEmpty.classList.remove("hidden");
        alertsTable.classList.add("hidden");
        return;
      }

      alertsEmpty.classList.add("hidden");
      alertsTable.classList.remove("hidden");

      const order = { "Active": 0, "Expired": 1, "Cancelled": 2 };
      const sorted = [...list].sort((a, b) => {
        const sa = computeAlertStatus(a);
        const sb = computeAlertStatus(b);
        if (order[sa] !== order[sb]) return order[sa] - order[sb];
        return (b.setAt || 0) - (a.setAt || 0);
      });

      sorted.forEach(a => {
        const status = computeAlertStatus(a);
        const daysLeft = computeDaysLeft(a);

        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateShort(a.setAt);
        tr.appendChild(tdDate);

        // COMBINED Shoe column
        const tdShoe = document.createElement("td");
        tdShoe.textContent = `${a.brand} ${a.model}`;
        tr.appendChild(tdShoe);

        const tdDays = document.createElement("td");
        tdDays.textContent = status === "Active" ? String(daysLeft) : "‚Äî";
        if (status === "Active") {
          const renewBtn = document.createElement("button");
          renewBtn.className = "action-btn secondary";
          renewBtn.textContent = "Renew";
          renewBtn.addEventListener("click", () => {
            a.setAt = nowMs();
            a.cancelledAt = null;
            upsertAlert(a);
            renderAlertsDashboard();
          });
          tdDays.appendChild(renewBtn);
        }
        tr.appendChild(tdDays);

        const tdTarget = document.createElement("td");
        const dollar = document.createElement("span");
        dollar.textContent = "$";
        tdTarget.appendChild(dollar);

        const targetInput = document.createElement("input");
        targetInput.type = "number";
        targetInput.step = "1";
        targetInput.min = "1";
        targetInput.value = Number(a.targetPrice).toFixed(0);
        targetInput.className = "target-editor";
        targetInput.disabled = (status !== "Active");
        tdTarget.appendChild(targetInput);

        if (status === "Active") {
          const updateBtn = document.createElement("button");
          updateBtn.className = "action-btn secondary";
          updateBtn.textContent = "Update";
          updateBtn.addEventListener("click", () => {
            const val = Number(targetInput.value);
            if (!isFinite(val) || val <= 0) {
              alert("Please enter a valid target price greater than 0.");
              targetInput.value = Number(a.targetPrice).toFixed(0);
              return;
            }
            a.targetPrice = Number(val).toFixed(2);
            a.setAt = nowMs();
            a.cancelledAt = null;
            upsertAlert(a);
            renderAlertsDashboard();
          });
          tdTarget.appendChild(updateBtn);
        }
        tr.appendChild(tdTarget);

        const tdStatus = document.createElement("td");
        tdStatus.className = "status-cell";

        const pill = document.createElement("span");
        pill.className = pillClassFor(status);
        pill.textContent = status;
        tdStatus.appendChild(pill);

        if (status === "Active") {
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "action-btn";
          cancelBtn.textContent = "Cancel";
          cancelBtn.addEventListener("click", () => {
            a.cancelledAt = nowMs();
            upsertAlert(a);
            renderAlertsDashboard();
          });
          tdStatus.appendChild(cancelBtn);
        }

        tr.appendChild(tdStatus);
        alertsTbody.appendChild(tr);
      });
    }

    const brandModels = {
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"]
    };

    const brands = Object.keys(brandModels).sort();

    function resolveBrandKey(input) {
      const normalized = normalize(input);
      return brands.find(b => normalize(b) === normalized) || "";
    }

    function resolveBrand() { return resolveBrandKey(brandInput.value.trim()); }

    function resolveModelKey(brandKey, modelTyped) {
      const typed = String(modelTyped || "").trim();
      if (!typed) return "";
      if (!brandKey || !brandModels[brandKey]) return typed;
      const normalized = normalize(typed);
      const canonical = brandModels[brandKey].find(m => normalize(m) === normalized);
      return canonical || typed;
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { container.style.display = "none"; return; }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function enableModel() {
      modelInput.disabled = false;
      modelInput.classList.remove("model-inactive");
      modelInput.classList.add("model-active");
    }

    function resetModelState() {
      modelInput.disabled = true;
      modelInput.value = "";
      modelInput.placeholder = "";
      modelInput.classList.remove("model-active");
      modelInput.classList.add("model-inactive");
      modelSuggestions.style.display = "none";
      modelPaw.classList.add("hidden");
      modelPaw.classList.remove("rock");
      brandSelected = false;
    }

    function confirmBrandSelection() {
      if (!modelInput.disabled) {
        modelInput.placeholder = "Enter Shoe Model";
        brandSelected = true;
        brandPaw.classList.add("hidden");
        brandPaw.classList.remove("rock");
        modelPaw.classList.remove("hidden");
        modelPaw.classList.add("rock");
      }
    }

    function updateFetchReady() {
      const brandKey = resolveBrand();
      const modelHasText = !!modelInput.value.trim();
      const ready = !!brandKey && !modelInput.disabled && modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    function updatePaws() {
      if (!brandSelected && !brandInput.value.trim()) {
        brandPaw.classList.remove("hidden");
        brandPaw.classList.add("rock");
      } else if (brandInput.value.trim() && !brandSelected) {
        brandPaw.classList.remove("rock");
        brandPaw.classList.remove("hidden");
      } else {
        brandPaw.classList.add("hidden");
        brandPaw.classList.remove("rock");
      }

      if (brandSelected && !modelInput.disabled) {
        if (!modelInput.value.trim()) {
          modelPaw.classList.remove("hidden");
          modelPaw.classList.add("rock");
        } else {
          modelPaw.classList.add("hidden");
          modelPaw.classList.remove("rock");
        }
      } else {
        modelPaw.classList.add("hidden");
        modelPaw.classList.remove("rock");
      }

      updateFetchReady();
    }

    function clearSearchForm() {
      brandInput.value = "";
      resetModelState();
      updatePaws();
      setTimeout(() => brandInput.focus(), 100);
    }

    function resetAlertSection() {
      alertPromptBtn.style.display = "block";
      alertForm.style.display = "none";
      alertConfirmation.style.display = "none";
      alertPriceInput.value = "";
      alertContactInput.value = "";
      updateAlertSubmitButton();
    }

    function updateAlertSubmitButton() {
      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      const priceValid = price && parseFloat(price) > 0;
      const contactValid = contact.length > 0 && (
        contact.includes('@') || /[\d\-\+\(\)\s]{7,}/.test(contact)
      );
      const isReady = priceValid && contactValid;
      alertSubmitBtn.disabled = !isReady;
      alertSubmitBtn.classList.toggle("ready", isReady);
    }

    function hideAllContentBelowStatus() {
      mainContent.classList.add("hidden");
      aboutContent.classList.add("hidden");
      alertsDashboard.classList.add("hidden");
      resultsEl.innerHTML = "";
      dailyDeals.style.display = "none";
      alertWrapper.style.display = "none";
      resetAlertSection();
      statusMessageEl.textContent = "";
    }

    function showHome() {
      aboutContent.classList.add("hidden");
      alertsDashboard.classList.add("hidden");
      mainContent.classList.remove("hidden");
      if (!resultsEl.innerHTML.trim()) dailyDeals.style.display = "block";
    }

    function showAbout() {
      mainContent.classList.add("hidden");
      alertsDashboard.classList.add("hidden");
      aboutContent.classList.remove("hidden");
      statusMessageEl.textContent = "";
    }

    function showMyAlerts() {
      hideAllContentBelowStatus();
      alertsDashboard.classList.remove("hidden");
      renderAlertsDashboard();
    }

    aboutLink.addEventListener("click", showAbout);
    myAlertsLink.addEventListener("click", showMyAlerts);
    logoLink.addEventListener("click", showHome);

    resetModelState();
    updatePaws();
    dailyDeals.style.display = "block";

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      if (typed) enableModel();
      else resetModelState();

      const matches = filterStartsWith(brands, typed);

      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";
        enableModel();
        confirmBrandSelection();
        setTimeout(() => modelInput.focus(), 0);
        updatePaws();
      });

      updatePaws();
    });

    brandInput.addEventListener("blur", () => setTimeout(() => { brandSuggestions.style.display = "none"; }, 120));

    brandInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const typed = brandInput.value.trim();
        if (typed) {
          e.preventDefault();
          enableModel();
          confirmBrandSelection();
          modelInput.focus();
          updatePaws();
        }
      }
    });

    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();

      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updatePaws();
        return;
      }

      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);

      showSuggestions(modelSuggestions, matches, (value) => {
        modelInput.value = value;
        modelSuggestions.style.display = "none";
        setTimeout(() => fetchBtn.focus(), 0);
        updatePaws();
      });

      updatePaws();
    });

    modelInput.addEventListener("blur", () => setTimeout(() => { modelSuggestions.style.display = "none"; }, 120));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandKey = resolveBrand();
      const modelCanonical = resolveModelKey(brandKey, modelInput.value);

      if (!brandKey || !modelCanonical) {
        statusMessageEl.textContent = "Please provide a brand & model.";
        updatePaws();
        return;
      }

      if (!aboutContent.classList.contains("hidden") || !alertsDashboard.classList.contains("hidden")) {
        showHome();
      }

      currentSearch = { brand: brandKey, model: modelCanonical };

      statusMessageEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";
      dailyDeals.style.display = "none";

      // Always show alert section centered for the searched shoe
      resetAlertSection();
      alertWrapper.style.display = "flex";
      alertProductName.textContent = `${brandKey} ${modelCanonical}`;

      const query = `${brandKey} ${modelCanonical}`;
      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        clearSearchForm();
        return;
      }

      const results = (data && data.results) ? data.results : [];

      if (!results.length) {
        statusMessageEl.textContent = "No results found ‚Äî set a price alert and we‚Äôll keep sniffing.";
        clearSearchForm();
        return;
      }

      statusMessageEl.textContent = `Top ${results.length} deal(s) found.`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        if (item.image) {
          const img = document.createElement("img");
          img.src = item.image;
          img.alt = item.title || "Deal image";
          card.appendChild(img);
        }

        const t = document.createElement("div");
        t.className = "card-title";
        t.textContent = item.title || "Deal";
        card.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "card-meta";
        const p = (typeof item.price === "number") ? item.price.toFixed(2) : (item.price ? String(item.price) : "‚Äî");
        meta.innerHTML = `<span class="price">$${p}</span><span>${item.store || ""}</span>`;
        card.appendChild(meta);

        const link = document.createElement("a");
        link.textContent = "View Deal";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.href = item.url || "#";
        card.appendChild(link);

        resultsEl.appendChild(card);
      });

      clearSearchForm();
    });

    alertPromptBtn.addEventListener("click", () => {
      alertPromptBtn.style.display = "none";
      alertForm.style.display = "flex";
      alertProductName.textContent = `${currentSearch.brand} ${currentSearch.model}`;
    });

    alertPriceInput.addEventListener("input", updateAlertSubmitButton);
    alertContactInput.addEventListener("input", updateAlertSubmitButton);

    alertSubmitBtn.addEventListener("click", async () => {
      if (alertSubmitBtn.disabled) return;

      const priceNum = Number(alertPriceInput.value.trim());
      const contact = alertContactInput.value.trim();
      const brand = currentSearch.brand;
      const model = currentSearch.model;

      if (!brand || !model) { alert("Please search for a shoe first, then set an alert."); return; }
      if (!isFinite(priceNum) || priceNum <= 0) { alert("Please enter a valid target price greater than 0."); return; }

      const existingActive = findActiveAlertFor(brand, model);
      if (existingActive) {
        alertForm.style.display = "none";
        alertConfirmation.innerHTML = `
          <strong>You already have an active alert for this shoe.</strong><br><br>
          Please go to <strong>My Alerts</strong> to renew or update your target.
        `;
        alertConfirmation.style.display = "block";
        return;
      }

      const isEmail = contact.includes('@');
      const payload = { product: `${brand} ${model}`, targetPrice: Number(priceNum).toFixed(2), email: isEmail ? contact : "", phone: isEmail ? "" : contact };

      const newAlert = {
        id: `a_${Math.random().toString(36).slice(2)}_${Date.now()}`,
        key: alertKey(brand, model),
        setAt: nowMs(),
        brand,
        model,
        targetPrice: Number(priceNum).toFixed(2),
        cancelledAt: null,
        contact
      };
      upsertAlert(newAlert);

      try {
        await fetch("/api/alerts", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      } catch (err) { console.error("Alert submission error:", err); }

      alertForm.style.display = "none";
      alertConfirmation.innerHTML = `
        <strong>‚úì Price Alert Set!</strong><br><br>
        Alert created for <strong>${brand} ${model}</strong> at <strong>$${Number(priceNum).toFixed(2)}</strong>.<br><br>
        Manage it anytime in <strong>My Alerts</strong> (renew, update, cancel).
      `;
      alertConfirmation.style.display = "block";
    });
  </script>
</body>
</html>
