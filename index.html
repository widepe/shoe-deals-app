<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      text-align: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
      align-items: center;
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 600px;
      height: auto;
      object-fit: contain;
      margin-bottom: 0.5rem;
      max-width: 100%;
    }

    form {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 1rem;
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 220px;
      flex: 1 1 200px;
    }

    /* Paw icon inside inputs */
    .paw {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.75;
      pointer-events: none;
      transform-origin: 50% 70%;
    }

    .paw.hidden { display: none; }

    @keyframes pawRock {
      0%   { transform: translateY(-50%) rotate(-10deg); }
      50%  { transform: translateY(-50%) rotate(10deg); }
      100% { transform: translateY(-50%) rotate(-10deg); }
    }

    .paw.rock {
      animation: pawRock 1.1s ease-in-out infinite;
    }

    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      height: 42px;
      padding: 0 2.1rem 0 0.75rem; /* extra right padding for paw */
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    input::placeholder {
      color: #444;
      opacity: 1;
    }

    .input-glow {
      border-color: #7fa26a;
      box-shadow: 0 0 0 2px #7fa26a55;
    }

    .model-inactive {
      background: #faf5f2ff;
      cursor: not-allowed;
    }

    .model-active {
      background: #ffffff;
      cursor: text;
    }

    .suggestions {
      position: absolute;
      top: 46px;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #8fa178;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 10;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #eef4e7;
    }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #7fa26a;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
    }

    .button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .search-btn {
      height: 42px;
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #7fa26a;
      padding: 0 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
    }

    .search-btn:hover {
      background: #6b8f57;
    }

    /* Pulse when ready */
    @keyframes readyPulse {
      0%   { transform: scale(1); box-shadow: 0 0 0 0 rgba(127,162,106,0.45); }
      70%  { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(127,162,106,0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(127,162,106,0); }
    }
    .search-btn.ready {
      animation: readyPulse 1.2s ease-in-out infinite;
    }

    .status {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.5rem;
    }

    .results {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      width: 100%;
      max-width: 850px;
    }

    .card {
      background: #ffffffc9;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .card img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: contain;
      max-height: 170px;
      background: #fafafa;
    }

    .card-title { font-size: 0.92rem; font-weight: 600; }

    .card-meta {
      font-size: 0.82rem;
      color: #49543a;
      display: flex;
      justify-content: space-between;
    }

    .price { font-weight: 700; color: #3b5b26; }

    /* Alert section styles */
    .alert-wrapper {
      width: 100%;
      max-width: 600px;
      margin-top: 1.25rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .alert-prompt-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #7fa26a;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #8fa178;
      transition: background 0.2s ease;
    }

    .alert-prompt-btn:hover {
      background: #6b8f57;
    }

    .alert-form {
      width: 100%;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #eef4e7c0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .alert-form-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .alert-form-row label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2d3c22;
      text-align: left;
    }

    .alert-form-row input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #8fa178;
      background: #fafdf4;
      font-size: 0.95rem;
      box-sizing: border-box;
      color: #444;
    }

    .alert-privacy-note {
      font-size: 0.8rem;
      color: #34452a;
      text-align: center;
      padding: 0.5rem;
      background: #f4ede3;
      border-radius: 0.5rem;
    }

    .alert-submit-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background: #9db88b;
      color: white;
      font-size: 1rem;
      cursor: not-allowed;
      border: 1px solid #8fa178;
      transition: background 0.2s ease;
      opacity: 0.6;
    }

    .alert-submit-btn.ready {
      background: #7fa26a;
      cursor: pointer;
      opacity: 1;
      animation: readyPulse 1.2s ease-in-out infinite;
    }

    .alert-submit-btn.ready:hover {
      background: #6b8f57;
    }

    .alert-confirmation {
      width: 100%;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #d4e7c5;
      color: #2d3c22;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .alert-confirmation strong {
      color: #3b5b26;
    }
  </style>
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>
  
  <div class="app">
    <div class="brand">
      <img src="/images/logo.svg" class="brand-logo" alt="Shoe Beagle Logo">
    </div>

    <form id="search-form">
      <div class="input-wrapper">
        <input
          id="brand"
          type="text"
          placeholder="Enter Shoe Brand"
          autocomplete="off"
          required
          class="input-glow"
          data-placeholder="Enter Shoe Brand"
        />
        <span class="paw rock" id="brandPaw">üêæ</span>
        <div id="brandSuggestions" class="suggestions"></div>
      </div>

      <div class="input-wrapper">
        <input
          id="model"
          type="text"
          placeholder=""
          autocomplete="off"
          required
          class="model-inactive"
          data-placeholder="Enter Shoe Model"
          disabled
        />
        <span class="paw rock hidden" id="modelPaw">üêæ</span>
        <div id="modelSuggestions" class="suggestions"></div>
      </div>

      <div class="button-wrapper">
        <button id="fetchBtn" type="submit" class="search-btn">üîç Fetch!</button>
      </div>
    </form>

    <div class="status" id="status">Let's find your <b>running shoes</b>...cheap!</div>
    <div class="results" id="results"></div>

    <p style="font-size:0.8rem; color:#555; max-width: 850px; margin: 0.25rem auto 0;">
      Prices may change. Links may become affiliate links in the future.
    </p>

    <div class="alert-wrapper" id="alertWrapper" style="display:none;">
      <!-- Initial prompt button -->
      <button class="alert-prompt-btn" id="alertPromptBtn">üîî Set Price Alert?</button>

      <!-- Alert form (hidden initially) -->
      <div class="alert-form" id="alertForm" style="display:none;">
        <div class="alert-form-row">
          <label for="alertPrice">Alert me when price is ‚â§</label>
          <input id="alertPrice" type="number" step="0.01" placeholder="$120.00" min="0">
        </div>

        <div class="alert-form-row">
          <label for="alertContact">Email or Phone Number</label>
          <input id="alertContact" type="text" placeholder="you@example.com or +1-555-0123">
        </div>

        <div class="alert-privacy-note">
          üîí Your information is never shared. Used only for price alerts.
        </div>

        <button class="alert-submit-btn" id="alertSubmitBtn" disabled>üì© Submit Price Alert</button>
      </div>

      <!-- Confirmation message (hidden initially) -->
      <div class="alert-confirmation" id="alertConfirmation" style="display:none;"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("search-form");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    
    const alertWrapper = document.getElementById("alertWrapper");
    const alertPromptBtn = document.getElementById("alertPromptBtn");
    const alertForm = document.getElementById("alertForm");
    const alertSubmitBtn = document.getElementById("alertSubmitBtn");
    const alertConfirmation = document.getElementById("alertConfirmation");
    
    const alertPriceInput = document.getElementById("alertPrice");
    const alertContactInput = document.getElementById("alertContact");

    const fetchBtn = document.getElementById("fetchBtn");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");

    const brandPaw = document.getElementById("brandPaw");
    const modelPaw = document.getElementById("modelPaw");

    // Store current search for alert
    let currentSearch = { brand: "", model: "" };

    const brandModels = {
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"]
    };

    const brands = Object.keys(brandModels).sort();

    function normalize(s) {
      return String(s || "").trim().toLowerCase();
    }

    function resolveBrandKey(input) {
      const normalized = normalize(input);
      return brands.find(b => normalize(b) === normalized) || "";
    }

    function resolveBrand() {
      return resolveBrandKey(brandInput.value.trim());
    }

    function resolveModelKey(brandKey, modelTyped) {
      const typed = String(modelTyped || "").trim();
      if (!typed) return "";
      if (!brandKey || !brandModels[brandKey]) return typed;

      const normalized = normalize(typed);
      const canonical = brandModels[brandKey].find(m => normalize(m) === normalized);
      return canonical || typed;
    }

    function filterStartsWith(list, text) {
      if (!text) return [];
      const lower = text.toLowerCase();
      return list.filter(item => item.toLowerCase().startsWith(lower));
    }

    function showSuggestions(container, items, onClickItem) {
      container.innerHTML = "";
      if (!items.length) { container.style.display = "none"; return; }
      items.forEach(value => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onClickItem(value);
        });
        container.appendChild(div);
      });
      container.style.display = "block";
    }

    function enableModel() {
      modelInput.disabled = false;
      modelInput.classList.remove("model-inactive");
      modelInput.classList.add("model-active", "input-glow");
      modelPaw.classList.remove("hidden");
    }

    function resetModelState() {
      modelInput.disabled = true;
      modelInput.value = "";
      modelInput.placeholder = "";
      modelInput.classList.remove("model-active", "input-glow");
      modelInput.classList.add("model-inactive");
      modelSuggestions.style.display = "none";
      modelPaw.classList.add("hidden");
    }

    function confirmBrandSelection() {
      if (!modelInput.disabled) modelInput.placeholder = "Enter Shoe Model";
    }

    function updateFetchReady() {
      const brandKey = resolveBrand();
      const modelHasText = !!modelInput.value.trim();
      const ready = !!brandKey && !modelInput.disabled && modelHasText;
      fetchBtn.classList.toggle("ready", ready);
    }

    function updatePaws() {
      if (brandInput.value.trim()) brandPaw.classList.remove("rock");
      else brandPaw.classList.add("rock");

      if (modelInput.disabled) {
        modelPaw.classList.add("hidden");
      } else {
        modelPaw.classList.remove("hidden");
        if (modelInput.value.trim()) modelPaw.classList.remove("rock");
        else modelPaw.classList.add("rock");
      }

      updateFetchReady();
    }

    function clearSearchForm() {
      brandInput.value = "";
      brandInput.placeholder = "Enter Shoe Brand";
      brandInput.classList.add("input-glow");
      
      resetModelState();
      updatePaws();
      
      setTimeout(() => brandInput.focus(), 100);
    }

    function resetAlertSection() {
      alertPromptBtn.style.display = "block";
      alertForm.style.display = "none";
      alertConfirmation.style.display = "none";
      alertPriceInput.value = "";
      alertContactInput.value = "";
      updateAlertSubmitButton();
    }

    function updateAlertSubmitButton() {
      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      
      // Check if price is valid and contact is provided
      const priceValid = price && parseFloat(price) > 0;
      const contactValid = contact && (
        contact.includes('@') || // email
        /[\d\-\+\(\)]{7,}/.test(contact) // phone-like
      );
      
      const isReady = priceValid && contactValid;
      
      alertSubmitBtn.disabled = !isReady;
      alertSubmitBtn.classList.toggle("ready", isReady);
    }

    // Initial state
    resetModelState();
    updatePaws();

    // BRAND input
    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();

      if (typed) enableModel();
      else resetModelState();

      const matches = filterStartsWith(brands, typed);

      showSuggestions(brandSuggestions, matches, (value) => {
        brandInput.value = value;
        brandSuggestions.style.display = "none";

        enableModel();
        confirmBrandSelection();

        setTimeout(() => modelInput.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    brandInput.addEventListener("blur", () => {
      setTimeout(() => { brandSuggestions.style.display = "none"; }, 120);
    });

    brandInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const typed = brandInput.value.trim();
        if (typed) {
          e.preventDefault();
          enableModel();
          confirmBrandSelection();
          modelInput.focus();
          updatePaws();
        }
      }
    });

    // MODEL input
    modelInput.addEventListener("input", () => {
      const brandKey = resolveBrand();
      const text = modelInput.value.trim();

      if (!brandKey || !brandModels[brandKey]) {
        modelSuggestions.style.display = "none";
        updatePaws();
        return;
      }

      const models = brandModels[brandKey];
      const matches = filterStartsWith(models, text);

      showSuggestions(modelSuggestions, matches, (value) => {
        modelInput.value = value;
        modelSuggestions.style.display = "none";

        setTimeout(() => fetchBtn.focus(), 0);

        updatePaws();
      });

      updatePaws();
    });

    modelInput.addEventListener("blur", () => {
      setTimeout(() => { modelSuggestions.style.display = "none"; }, 120);
    });

    // Submit search
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const brandKey = resolveBrand();
      const modelCanonical = resolveModelKey(brandKey, modelInput.value);

      if (brandKey) brandInput.value = brandKey;
      if (modelCanonical) modelInput.value = modelCanonical;

      if (!brandKey || !modelCanonical) {
        statusEl.textContent = "Please provide a brand & model.";
        updatePaws();
        return;
      }

      // Store current search
      currentSearch = { brand: brandKey, model: modelCanonical };

      statusEl.textContent = "Searching deals‚Ä¶";
      resultsEl.innerHTML = "";
      alertWrapper.style.display = "none";

      const query = `${brandKey} ${modelCanonical}`;
      let data;

      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query }));
        
        try {
          data = await res.json();
        } catch (parseErr) {
          console.error("Failed to parse response:", parseErr);
          statusEl.textContent = "Search failed. Please try again.";
          return;
        }

        if (!data || !data.results) {
          statusEl.textContent = "No results found.";
          return;
        }

      } catch (err) {
        statusEl.textContent = "Search failed. Please try again.";
        console.error("Fetch error:", err);
        return;
      }

      const results = data.results || [];
      if (!results.length) {
        statusEl.textContent = "No results.";
        return;
      }

      statusEl.textContent = `Top ${results.length} deal(s) found.`;
      resultsEl.innerHTML = "";

      results.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        if (item.image) {
          const img = document.createElement("img");
          img.src = item.image;
          img.alt = item.title;
          card.appendChild(img);
        }

        const t = document.createElement("div");
        t.className = "card-title";
        t.textContent = item.title;
        card.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "card-meta";
        meta.innerHTML = `<span class="price">$${item.price?.toFixed(2) || "‚Äî"}</span><span>${item.store || ""}</span>`;
        card.appendChild(meta);

        const link = document.createElement("a");
        link.textContent = "View Deal";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.href = item.url;

        card.appendChild(link);
        resultsEl.appendChild(card);
      });

      // Show alert section
      resetAlertSection();
      alertWrapper.style.display = "flex";
      
      // Clear search form
      clearSearchForm();
    });

    // Alert prompt button
    alertPromptBtn.addEventListener("click", () => {
      alertPromptBtn.style.display = "none";
      alertForm.style.display = "flex";
    });

    // Alert form inputs
    alertPriceInput.addEventListener("input", updateAlertSubmitButton);
    alertContactInput.addEventListener("input", updateAlertSubmitButton);

    // Alert submit
    alertSubmitBtn.addEventListener("click", async () => {
      if (alertSubmitBtn.disabled) return;

      const price = alertPriceInput.value.trim();
      const contact = alertContactInput.value.trim();
      const product = `${currentSearch.brand} ${currentSearch.model}`;

      // Determine if email or phone
      const isEmail = contact.includes('@');
      const payload = {
        product: product,
        targetPrice: price,
        email: isEmail ? contact : "",
        phone: isEmail ? "" : contact
      };

      try {
        const res = await fetch("/api/alerts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          // Show confirmation
          alertForm.style.display = "none";
          alertConfirmation.innerHTML = `
            <strong>‚úì Price Alert Set!</strong><br><br>
            You'll be notified immediately when <strong>${product}</strong> is found at or below <strong>$${parseFloat(price).toFixed(2)}</strong>.<br><br>
            This alert will continue for <strong>30 days</strong> or until you cancel it.
          `;
          alertConfirmation.style.display = "block";
        } else {
          alert(data.error || "Could not save alert. Please try again.");
        }
      } catch (err) {
        console.error("Alert submission error:", err);
        alert("Could not save alert. Please try again.");
      }
    });
  </script>
</body>
</html>
